(function(){function d(a){var c=!1;return function(){if(c)throw new Error("Callback was already called.");c=!0,a.apply(b,arguments)}}var a={},b,c;b=this,b!=null&&(c=b.async),a.noConflict=function(){return b.async=c,a};var e=function(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)},f=function(a,b){if(a.map)return a.map(b);var c=[];return e(a,function(a,d,e){c.push(b(a,d,e))}),c},g=function(a,b,c){return a.reduce?a.reduce(b,c):(e(a,function(a,d,e){c=b(c,a,d,e)}),c)},h=function(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b};typeof process=="undefined"||!process.nextTick?typeof setImmediate=="function"?(a.nextTick=function(a){setImmediate(a)},a.setImmediate=a.nextTick):(a.nextTick=function(a){setTimeout(a,0)},a.setImmediate=a.nextTick):(a.nextTick=process.nextTick,typeof setImmediate!="undefined"?a.setImmediate=setImmediate:a.setImmediate=a.nextTick),a.each=function(a,b,c){c=c||function(){};if(!a.length)return c();var f=0;e(a,function(e){b(e,d(function(b){b?(c(b),c=function(){}):(f+=1,f>=a.length&&c(null))}))})},a.forEach=a.each,a.eachSeries=function(a,b,c){c=c||function(){};if(!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c(null):e())})};e()},a.forEachSeries=a.eachSeries,a.eachLimit=function(a,b,c,d){var e=i(b);e.apply(null,[a,c,d])},a.forEachLimit=a.eachLimit;var i=function(a){return function(b,c,d){d=d||function(){};if(!b.length||a<=0)return d();var e=0,f=0,g=0;(function h(){if(e>=b.length)return d();while(g<a&&f<b.length)f+=1,g+=1,c(b[f-1],function(a){a?(d(a),d=function(){}):(e+=1,g-=1,e>=b.length?d():h())})})()}},j=function(b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[a.each].concat(c))}},k=function(a,b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[i(a)].concat(c))}},l=function(b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[a.eachSeries].concat(c))}},m=function(a,b,c,d){var e=[];b=f(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d,b(c)})},function(a){d(a,e)})};a.map=j(m),a.mapSeries=l(m),a.mapLimit=function(a,b,c,d){return n(b)(a,c,d)};var n=function(a){return k(a,m)};a.reduce=function(b,c,d,e){a.eachSeries(b,function(a,b){d(c,a,function(a,d){c=d,b(a)})},function(a){e(a,c)})},a.inject=a.reduce,a.foldl=a.reduce,a.reduceRight=function(b,c,d,e){var g=f(b,function(a){return a}).reverse();a.reduce(g,c,d,e)},a.foldr=a.reduceRight;var o=function(a,b,c,d){var e=[];b=f(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c&&e.push(a),b()})},function(a){d(f(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};a.filter=j(o),a.filterSeries=l(o),a.select=a.filter,a.selectSeries=a.filterSeries;var p=function(a,b,c,d){var e=[];b=f(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c||e.push(a),b()})},function(a){d(f(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};a.reject=j(p),a.rejectSeries=l(p);var q=function(a,b,c,d){a(b,function(a,b){c(a,function(c){c?(d(a),d=function(){}):b()})},function(a){d()})};a.detect=j(q),a.detectSeries=l(q),a.some=function(b,c,d){a.each(b,function(a,b){c(a,function(a){a&&(d(!0),d=function(){}),b()})},function(a){d(!1)})},a.any=a.some,a.every=function(b,c,d){a.each(b,function(a,b){c(a,function(a){a||(d(!1),d=function(){}),b()})},function(a){d(!0)})},a.all=a.every,a.sortBy=function(b,c,d){a.map(b,function(a,b){c(a,function(c,d){c?b(c):b(null,{value:a,criteria:d})})},function(a,b){if(a)return d(a);var c=function(a,b){var c=a.criteria,d=b.criteria;return c<d?-1:c>d?1:0};d(null,f(b.sort(c),function(a){return a.value}))})},a.auto=function(b,c){c=c||function(){};var d=h(b);if(!d.length)return c(null);var f={},i=[],j=function(a){i.unshift(a)},k=function(a){for(var b=0;b<i.length;b+=1)if(i[b]===a){i.splice(b,1);return}},l=function(){e(i.slice(0),function(a){a()})};j(function(){h(f).length===d.length&&(c(null,f),c=function(){})}),e(d,function(d){var i=b[d]instanceof Function?[b[d]]:b[d],m=function(b){var g=Array.prototype.slice.call(arguments,1);g.length<=1&&(g=g[0]);if(b){var i={};e(h(f),function(a){i[a]=f[a]}),i[d]=g,c(b,i),c=function(){}}else f[d]=g,a.setImmediate(l)},n=i.slice(0,Math.abs(i.length-1))||[],o=function(){return g(n,function(a,b){return a&&f.hasOwnProperty(b)},!0)&&!f.hasOwnProperty(d)};if(o())i[i.length-1](m,f);else{var p=function(){o()&&(k(p),i[i.length-1](m,f))};j(p)}})},a.waterfall=function(b,c){c=c||function(){};if(b.constructor!==Array){var d=new Error("First argument to waterfall must be an array of functions");return c(d)}if(!b.length)return c();var e=function(b){return function(d){if(d)c.apply(null,arguments),c=function(){};else{var f=Array.prototype.slice.call(arguments,1),g=b.next();g?f.push(e(g)):f.push(c),a.setImmediate(function(){b.apply(null,f)})}}};e(a.iterator(b))()};var r=function(a,b,c){c=c||function(){};if(b.constructor===Array)a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(h(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};a.parallel=function(b,c){r({map:a.map,each:a.each},b,c)},a.parallelLimit=function(a,b,c){r({map:n(b),each:i(b)},a,c)},a.series=function(b,c){c=c||function(){};if(b.constructor===Array)a.mapSeries(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.eachSeries(h(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}},a.iterator=function(a){var b=function(c){var d=function(){return a.length&&a[c].apply(null,arguments),d.next()};return d.next=function(){return c<a.length-1?b(c+1):null},d};return b(0)},a.apply=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b.concat(Array.prototype.slice.call(arguments)))}};var s=function(a,b,c,d){var e=[];a(b,function(a,b){c(a,function(a,c){e=e.concat(c||[]),b(a)})},function(a){d(a,e)})};a.concat=j(s),a.concatSeries=l(s),a.whilst=function(b,c,d){b()?c(function(e){if(e)return d(e);a.whilst(b,c,d)}):d()},a.doWhilst=function(b,c,d){b(function(e){if(e)return d(e);c()?a.doWhilst(b,c,d):d()})},a.until=function(b,c,d){b()?d():c(function(e){if(e)return d(e);a.until(b,c,d)})},a.doUntil=function(b,c,d){b(function(e){if(e)return d(e);c()?d():a.doUntil(b,c,d)})},a.queue=function(b,c){function f(b,d,f,g){d.constructor!==Array&&(d=[d]),e(d,function(d){var e={data:d,callback:typeof g=="function"?g:null};f?b.tasks.unshift(e):b.tasks.push(e),b.saturated&&b.tasks.length===c&&b.saturated(),a.setImmediate(b.process)})}c===undefined&&(c=1);var g=0,h={tasks:[],concurrency:c,saturated:null,empty:null,drain:null,push:function(a,b){f(h,a,!1,b)},unshift:function(a,b){f(h,a,!0,b)},process:function(){if(g<h.concurrency&&h.tasks.length){var a=h.tasks.shift();h.empty&&h.tasks.length===0&&h.empty(),g+=1;var c=function(){g-=1,a.callback&&a.callback.apply(a,arguments),h.drain&&h.tasks.length+g===0&&h.drain(),h.process()},e=d(c);b(a.data,e)}},length:function(){return h.tasks.length},running:function(){return g}};return h},a.cargo=function(b,c){var d=!1,g=[],h={tasks:g,payload:c,saturated:null,empty:null,drain:null,push:function(b,d){b.constructor!==Array&&(b=[b]),e(b,function(a){g.push({data:a,callback:typeof d=="function"?d:null}),h.saturated&&g.length===c&&h.saturated()}),a.setImmediate(h.process)},process:function i(){if(d)return;if(g.length===0){h.drain&&h.drain();return}var a=typeof c=="number"?g.splice(0,c):g.splice(0),j=f(a,function(a){return a.data});h.empty&&h.empty(),d=!0,b(j,function(){d=!1;var b=arguments;e(a,function(a){a.callback&&a.callback.apply(null,b)}),i()})},length:function(){return g.length},running:function(){return d}};return h};var t=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);b.apply(null,c.concat([function(b){var c=Array.prototype.slice.call(arguments,1);typeof console!="undefined"&&(b?console.error&&console.error(b):console[a]&&e(c,function(b){console[a](b)}))}]))}};a.log=t("log"),a.dir=t("dir"),a.memoize=function(a,b){var c={},d={};b=b||function(a){return a};var e=function(){var e=Array.prototype.slice.call(arguments),f=e.pop(),g=b.apply(null,e);g in c?f.apply(null,c[g]):g in d?d[g].push(f):(d[g]=[f],a.apply(null,e.concat([function(){c[g]=arguments;var a=d[g];delete d[g];for(var b=0,e=a.length;b<e;b++)a[b].apply(null,arguments)}])))};return e.memo=c,e.unmemoized=a,e},a.unmemoize=function(a){return function(){return(a.unmemoized||a).apply(null,arguments)}},a.times=function(b,c,d){var e=[];for(var f=0;f<b;f++)e.push(f);return a.map(e,c,d)},a.timesSeries=function(b,c,d){var e=[];for(var f=0;f<b;f++)e.push(f);return a.mapSeries(e,c,d)},a.compose=function(){var b=Array.prototype.reverse.call(arguments);return function(){var c=this,d=Array.prototype.slice.call(arguments),e=d.pop();a.reduce(b,d,function(a,b,d){b.apply(c,a.concat([function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);d(a,b)}]))},function(a,b){e.apply(c,[a].concat(b))})}};var u=function(a,b){var c=function(){var c=this,d=Array.prototype.slice.call(arguments),e=d.pop();return a(b,function(a,b){a.apply(c,d.concat([b]))},e)};if(arguments.length>2){var d=Array.prototype.slice.call(arguments,2);return c.apply(this,d)}return c};a.applyEach=j(u),a.applyEachSeries=l(u),a.forever=function(a,b){function c(d){if(d){if(b)return b(d);throw d}a(c)}c()},typeof define!="undefined"&&define.amd?define("lib/async",[],function(){return a}):typeof module!="undefined"&&module.exports?module.exports=a:b.async=a})(),define("lib/misc/csrf_ajax_protection_setup",[],function(){return function(){$.ajaxSetup({beforeSend:function(a,b){function c(a){var b=null;if(document.cookie&&document.cookie!=""){var c=document.cookie.split(";");for(var d=0;d<c.length;d++){var e=jQuery.trim(c[d]);if(e.substring(0,a.length+1)==a+"="){b=decodeURIComponent(e.substring(a.length+1));break}}}return b}!/^http:.*/.test(b.url)&&!/^https:.*/.test(b.url)&&a.setRequestHeader("X-CSRFToken",c("csrftoken"))}})}}),define("lib/db/db_util",[],function(){function a(a){return"_pouch_"+a}function b(a){return"liquor_"+a}function c(c,d){var e=a(b(c)),f=indexedDB.open(e);f.onupgradeneeded=function(a){a.target.transaction.abort(),d(null,null)},f.onsuccess=function(a){d(null,f.result)},f.onerror=function(a){a.target.error.name=="AbortError"?indexedDB.deleteDatabase(e):alert("there is error")}}return{get_store_db_name:b,is_store_idb_exist:c,pouch_db_name_to_index_db_name:a}}),!function(a){if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define("lib/db/pouchdb",a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.PouchDB=a()}}(function(){var define,module,exports;return function e(a,b,c){function d(g,h){if(!b[g]){if(!a[g]){var j=typeof require=="function"&&require;if(!h&&j)return j(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var k=b[g]={exports:{}};a[g][0].call(k.exports,function(b){var c=a[g][1][b];return d(c?c:b)},k,k.exports,e,a,b,c)}return b[g].exports}var f=typeof require=="function"&&require;for(var g=0;g<c.length;g++)d(c[g]);return d}({1:[function(_dereq_,module,exports){function arrayFirst(a,b){for(var c=0;c<a.length;c++)if(b(a[c],c)===!0)return a[c];return!1}function yankError(a){return function(b,c){b||c[0].error?a(b||c[0]):a(null,c[0])}}function computeHeight(a){var b={},c=[];return merge.traverseRevTree(a,function(a,d,e,f){var g=d+"-"+e;return a&&(b[g]=0),f!==undefined&&c.push({from:f,to:g}),g}),c.reverse(),c.forEach(function(a){b[a.from]===undefined?b[a.from]=1+b[a.to]:b[a.from]=Math.min(b[a.from],1+b[a.to])}),b}function AbstractPouchDB(){var a=this;EventEmitter.call(this),a.autoCompact=function(b){return a.auto_compaction?function(c,d){if(c)b(c);else{var e=d.length,f=function(){e--,e||b(null,d)};d.forEach(function(b){b.ok?a.compactDocument(b.id,1,f):f()})}}:b};var b=0,c,d=["change","delete","create","update"];this.on("newListener",function(e){if(!~d.indexOf(e))return;if(b){b++;return}b++;var f=0;c=this.changes({conflicts:!0,include_docs:!0,continuous:!0,since:"latest",onChange:function(b){if(b.seq<=f)return;f=b.seq,a.emit("change",b),b.doc._deleted?a.emit("delete",b):b.doc._rev.split("-")[0]==="1"?a.emit("create",b):a.emit("update",b)}})}),this.on("removeListener",function(a){if(!~d.indexOf(a))return;b--;if(b)return;c.cancel()})}function adapterFun(a,b){return utils.toPromise(function(){if(!this.taskqueue.isReady){this.taskqueue.addTask(a,arguments);return}b.apply(this,arguments)})}function processChange(a,b,c){var d=[{rev:a._rev}];c.style==="all_docs"&&(d=merge.collectLeaves(b.rev_tree).map(function(a){return{rev:a.rev}}));var e={id:b.id,changes:d,doc:a};return utils.isDeleted(b,a._rev)&&(e.deleted=!0),c.conflicts&&(e.doc._conflicts=merge.collectConflicts(b),e.doc._conflicts.length||delete e.doc._conflicts),e}function doChanges(api,opts,promise,callback){opts=utils.extend(!0,{},opts),"live"in opts&&!("continuous"in opts)&&(opts.continuous=opts.live),opts.processChange=processChange,opts.since||(opts.since=0);if(opts.since==="latest"){api.info(function(a,b){if(promise.isCancelled){callback(null,{status:"cancelled"});return}if(a){callback(a);return}opts.since=b.update_seq-1,doChanges(api,opts,promise,callback)});return}if(api.type()!=="http"&&opts.filter&&typeof opts.filter=="string"){if(opts.filter==="_view"){if(!opts.view||typeof opts.view!="string"){var err=errors.error(errors.BAD_REQUEST,"`view` filter parameter is not provided.");callback(err);return}var viewName=opts.view.split("/");api.get("_design/"+viewName[0],function(err,ddoc){if(promise.isCancelled){callback(null,{status:"cancelled"});return}if(err){callback(err);return}if(ddoc&&ddoc.views&&ddoc.views[viewName[1]]){var filter=eval("(function () {  return function (doc) {    var emitted = false;    var emit = function (a, b) {      emitted = true;    };    var view = "+ddoc.views[viewName[1]].map+";"+"    view(doc);"+"    if (emitted) {"+"      return true;"+"    }"+"  }"+"})()");opts.filter=filter,doChanges(api,opts,promise,callback);return}var msg=ddoc.views?"missing json key: "+viewName[1]:"missing json key: views";err=err||errors.error(errors.MISSING_DOC,msg),callback(err);return})}else{var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){if(promise.isCancelled){callback(null,{status:"cancelled"});return}if(err){callback(err);return}if(ddoc&&ddoc.filters&&ddoc.filters[filterName[1]]){var filter=eval("(function () { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter,doChanges(api,opts,promise,callback);return}var msg=ddoc&&ddoc.filters?"missing json key: "+filterName[1]:"missing json key: filters";err=err||errors.error(errors.MISSING_DOC,msg),callback(err);return})}return}"descending"in opts||(opts.descending=!1),opts.limit=opts.limit===0?1:opts.limit,opts.complete=callback;var newPromise=api._changes(opts);if(newPromise&&typeof newPromise.cancel=="function"){var cancel=promise.cancel;promise.cancel=function(){newPromise.cancel(),cancel.apply(this,arguments)}}}var utils=_dereq_("./utils"),merge=_dereq_("./merge"),errors=_dereq_("./deps/errors"),EventEmitter=_dereq_("events").EventEmitter;utils.inherits(AbstractPouchDB,EventEmitter),module.exports=AbstractPouchDB,AbstractPouchDB.prototype.post=adapterFun("post",function(a,b,c){return typeof b=="function"&&(c=b,b={}),typeof a!="object"||Array.isArray(a)?c(errors.NOT_AN_OBJECT):this.bulkDocs({docs:[a]},b,this.autoCompact(yankError(c)))}),AbstractPouchDB.prototype.put=adapterFun("put",function(){var a=Array.prototype.slice.call(arguments),b,c,d,e,f=a.shift(),g="_id"in f;if(typeof f!="object"||Array.isArray(f))return e=a.pop(),e(errors.NOT_AN_OBJECT);f=utils.extend(!0,{},f);for(;;){b=a.shift(),c=typeof b,c==="string"&&!g?(f._id=b,g=!0):c!=="string"||!g||"_rev"in f?c==="object"?d=b:c==="function"&&(e=b):f._rev=b;if(!a.length)break}d=d||{};var h=utils.invalidIdError(f._id);return h?e(h):this.bulkDocs({docs:[f]},d,this.autoCompact(yankError(e)))}),AbstractPouchDB.prototype.putAttachment=adapterFun("putAttachment",function(a,b,c,d,e,f){function h(a){a._attachments=a._attachments||{},a._attachments[b]={content_type:e,data:d},g.put(a,f)}var g=this;typeof e=="function"&&(f=e,e=d,d=c,c=null),typeof e=="undefined"&&(e=d,d=c,c=null),g.get(a,function(b,d){if(b&&b.error===errors.MISSING_DOC.error){h({_id:a});return}if(b){f(b);return}if(d._rev!==c){f(errors.REV_CONFLICT);return}h(d)})}),AbstractPouchDB.prototype.removeAttachment=adapterFun("removeAttachment",function(a,b,c,d){var e=this;e.get(a,function(a,f){if(a){d(a);return}if(f._rev!==c){d(errors.REV_CONFLICT);return}if(!f._attachments)return d();delete f._attachments[b],Object.keys(f._attachments).length===0&&delete f._attachments,e.put(f,d)})}),AbstractPouchDB.prototype.remove=adapterFun("remove",function(a,b,c){typeof b=="function"&&(c=b,b={}),b===undefined&&(b={}),b=utils.extend(!0,{},b),b.was_delete=!0;var d={_id:a._id,_rev:a._rev};return d._deleted=!0,this.bulkDocs({docs:[d]},b,yankError(c))}),AbstractPouchDB.prototype.revsDiff=adapterFun("revsDiff",function(a,b,c){function g(a,b){f[a]||(f[a]={missing:[]}),f[a].missing.push(b)}function h(b,c){var d=a[b].slice(0);merge.traverseRevTree(c,function(a,c,e,f,h){var i=c+"-"+e,j=d.indexOf(i);if(j===-1)return;d.splice(j,1),h.status!=="available"&&g(b,i)}),d.forEach(function(a){g(b,a)})}typeof b=="function"&&(c=b,b={}),b=utils.extend(!0,{},b);var d=Object.keys(a),e=0,f={};d.map(function(b){this._getRevisionTree(b,function(g,i){if(g&&g.name==="not_found"&&g.message==="missing")f[b]={missing:a[b]};else{if(g)return c(g);h(b,i)}if(++e===d.length)return c(null,f)})},this)}),AbstractPouchDB.prototype.compactDocument=function(a,b,c){var d=this;this._getRevisionTree(a,function(e,f){if(e)return c(e);var g=computeHeight(f),h=[],i=[];Object.keys(g).forEach(function(a){g[a]>b&&h.push(a)}),merge.traverseRevTree(f,function(a,b,c,d,e){var f=b+"-"+c;e.status==="available"&&h.indexOf(f)!==-1&&(e.status="missing",i.push(f))}),d._doCompaction(a,f,i,c)})},AbstractPouchDB.prototype.compact=adapterFun("compact",function(a,b){typeof a=="function"&&(b=a,a={});var c=this;this.changes({complete:function(a,d){if(a){b();return}var e=d.results.length;if(!e){b();return}d.results.forEach(function(a){c.compactDocument(a.id,0,function(){e--,e||b()})})}})}),AbstractPouchDB.prototype.get=adapterFun("get",function(a,b,c){function f(){var f=[],g=d.length;if(!g)return c(null,f);d.forEach(function(d){e.get(a,{rev:d,revs:b.revs,attachments:b.attachments},function(a,b){a?f.push({missing:d}):f.push({ok:b}),g--,g||c(null,f)})})}typeof b=="function"&&(c=b,b={});if(typeof a!="string")return c(errors.INVALID_ID);var d=[],e=this;if(b.open_revs){if(b.open_revs==="all")this._getRevisionTree(a,function(a,b){a&&(b=[]),d=merge.collectLeaves(b).map(function(a){return a.rev}),f()});else{if(!Array.isArray(b.open_revs))return c(errors.error(errors.UNKNOWN_ERROR,"function_clause"));d=b.open_revs;for(var g=0;g<d.length;g++){var h=d[g];if(typeof h!="string"||!/^\d+-/.test(h))return c(errors.error(errors.BAD_REQUEST,"Invalid rev format"))}f()}return}return this._get(a,b,function(a,d){b=utils.extend(!0,{},b);if(a)return c(a);var f=d.doc,g=d.metadata,h=d.ctx;if(b.conflicts){var i=merge.collectConflicts(g);i.length&&(f._conflicts=i)}if(b.revs||b.revs_info){var j=merge.rootToLeaf(g.rev_tree),k=arrayFirst(j,function(a){return a.ids.map(function(a){return a.id}).indexOf(f._rev.split("-")[1])!==-1});k.ids.splice(k.ids.map(function(a){return a.id}).indexOf(f._rev.split("-")[1])+1),k.ids.reverse(),b.revs&&(f._revisions={start:k.pos+k.ids.length-1,ids:k.ids.map(function(a){return a.id})});if(b.revs_info){var l=k.pos+k.ids.length;f._revs_info=k.ids.map(function(a){return l--,{rev:l+"-"+a.id,status:a.opts.status}})}}b.local_seq&&(f._local_seq=d.metadata.seq);if(b.attachments&&f._attachments){var m=f._attachments,n=Object.keys(m).length;if(n===0)return c(null,f);Object.keys(m).forEach(function(a){this._getAttachment(m[a],{encode:!0,ctx:h},function(b,d){f._attachments[a].data=d,--n||c(null,f)})},e)}else{if(f._attachments)for(var o in f._attachments)f._attachments.hasOwnProperty(o)&&(f._attachments[o].stub=!0);c(null,f)}})}),AbstractPouchDB.prototype.getAttachment=adapterFun("getAttachment",function(a,b,c,d){var e=this;c instanceof Function&&(d=c,c={}),c=utils.extend(!0,{},c),this._get(a,c,function(a,f){if(a)return d(a);if(!f.doc._attachments||!f.doc._attachments[b])return d(errors.MISSING_DOC);c.ctx=f.ctx,e._getAttachment(f.doc._attachments[b],c,d)})}),AbstractPouchDB.prototype.allDocs=adapterFun("allDocs",function(a,b){typeof a=="function"&&(b=a,a={}),a=utils.extend(!0,{},a);if("keys"in a){var c=["startkey","endkey","key"].filter(function(b){return b in a})[0];if(c){b(errors.error(errors.QUERY_PARSE_ERROR,"Query parameter `"+c+"` is not compatible with multi-get"));return}}return typeof a.skip=="undefined"&&(a.skip=0),this._allDocs(a,b)}),AbstractPouchDB.prototype.changes=function(a,b,c){typeof b=="function"&&(c=b,b=null);if(b)return doChanges(this,a,b,c),b;var d=utils.toPromise(function(a,b,c){typeof a=="function"&&(b=c,c=a,a={}),a?a=utils.extend(!0,{},a):a={};if(a.complete){var d=a.complete;b.then(function(a){d(null,a)},d)}delete a.complete;var e=b.cancel;b.cancel=function(a){typeof e=="function"&&e.apply(this),c(null,{status:"cancelled",reason:a})};if(b.isCancelled){c(null,{status:"cancelled"});return}if(!this.taskqueue.isReady){this.taskqueue.addTask("changes",[a,b,c]);return}doChanges(this,a,b,c)},!0);b=d.apply(this,arguments);var e=b.cancel;return b.isCancelled=!1,b.cancel=function(){b.isCancelled=!0,e.apply(this,arguments)},b},AbstractPouchDB.prototype.close=adapterFun("close",function(a){return this._close(a)}),AbstractPouchDB.prototype.info=adapterFun("info",function(a){var b=this;this._info(function(c,d){if(c)return a(c);var e=b.prefix.length;d.db_name.length>e&&d.db_name.slice(0,e)===b.prefix&&(d.db_name=d.db_name.slice(e)),a(null,d)})}),AbstractPouchDB.prototype.id=adapterFun("id",function(a){return this._id(a)}),AbstractPouchDB.prototype.type=function(){return typeof this._type=="function"?this._type():this.adapter},AbstractPouchDB.prototype.bulkDocs=adapterFun("bulkDocs",function(a,b,c){typeof b=="function"&&(c=b,b={}),b?b=utils.extend(!0,{},b):b={};if(!a||!a.docs)return c(errors.MISSING_BULK_DOCS);if(!Array.isArray(a.docs))return c(errors.QUERY_PARSE_ERROR);for(var d=0;d<a.docs.length;++d)if(typeof a.docs[d]!="object"||Array.isArray(a.docs[d]))return c(errors.NOT_AN_OBJECT);return a=utils.extend(!0,{},a),"new_edits"in b||("new_edits"in a?b.new_edits=a.new_edits:b.new_edits=!0),this._bulkDocs(a,b,this.autoCompact(c))})},{"./deps/errors":8,"./merge":14,"./utils":18,events:21}],2:[function(a,b,c){function f(a){var b=f.options,c=b.parser[b.strictMode?"strict":"loose"].exec(a),d={},e=14;while(e--)d[b.key[e]]=c[e]||"";return d[b.q.name]={},d[b.key[12]].replace(b.q.parser,function(a,c,e){c&&(d[b.q.name][c]=e)}),d}function g(a){return/^_(design|local)/.test(a)?a:encodeURIComponent(a)}function h(a,b){if(/http(s?):/.test(a)){var c=f(a);c.remote=!0;if(c.user||c.password)c.auth={username:c.user,password:c.password};var e=c.path.replace(/(^\/|\/$)/g,"").split("/");c.db=e.pop(),c.path=e.join("/"),b=b||{},b=d.extend(!0,{},b),c.headers=b.headers||{};if(b.auth||c.auth){var g=b.auth||c.auth,h=d.btoa(g.username+":"+g.password);c.headers.Authorization="Basic "+h}return b.headers&&(c.headers=b.headers),c}return{host:"",path:"/",db:a,auth:!1}}function i(a,b){if(a.remote){var c=a.path?"/":"";return a.protocol+"://"+a.host+":"+a.port+"/"+a.path+c+a.db+"/"+b}return"/"+a.db+"/"+b}function j(a,b){if(a.remote){var c=a.path?"/":"";return a.protocol+"://"+a.host+":"+a.port+"/"+a.path+c+b}return"/"+b}function k(a,b){function m(a,b){return d.ajax(d.extend({},l,a),b)}function p(a,e,f,g){e=d.extend(!0,{},e);var i=h(g),j={source:c.db,target:i.protocol===c.protocol&&i.authority===c.authority?i.db:i.source};e.continuous&&(j.continuous=!0),e.create_target&&(j.create_target=!0),e.doc_ids&&(j.doc_ids=e.doc_ids),e.filter&&typeof e.filter=="string"&&(j.filter=e.filter),e.query_params&&(j.query_params=e.query_params);var k={},l={headers:c.headers,method:"POST",url:c.protocol+"://"+c.host+(c.port===80?"":":"+c.port)+"/_replicate",body:j},n;f.cancel=function(){this.cancelled=!0,n&&!k.ok&&n.abort(),k._local_id&&(l.body={replication_id:k._local_id}),l.body.cancel=!0,m(l,function(a,c,f){if(a)return b(a);d.call(e.complete,null,k,f)})};if(f.cancelled)return;n=m(l,function(a,c,f){if(a)return b(a);k.ok=!0,c._local_id&&(k._local_id=c._local_id),d.call(e.complete,null,c,f)})}var c=h(a.name,a),f=i(c,""),k=this,l=a.ajax||{};a=d.extend(!0,{},a);var n={list:[],get:function(a,b){typeof a=="function"&&(b=a,a={count:10});var d=function(a,c){!a&&"uuids"in c?(n.list=n.list.concat(c.uuids),b(null,"OK")):b(a||e.UNKNOWN_ERROR)},f="?count="+a.count;m({headers:c.headers,method:"GET",url:j(c,"_uuids")+f},d)}},o=function(){m({headers:c.headers,method:"PUT",url:f},function(a,d){a&&a.status===401?m({headers:c.headers,method:"HEAD",url:f},function(a,c){a?b(a):b(null,k)}):!a||a.status===412?b(null,k):b(a)})};a.skipSetup||m({headers:c.headers,method:"GET",url:f},function(a,c){a?a.status===404?o():b(a):b(null,k)}),k.type=function(){return"http"},k.id=d.toPromise(function(a){if(!k.taskqueue.isReady){k.taskqueue.addTask("id",arguments);return}m({headers:c.headers,method:"GET",url:j(c,"")},function(b,d){if(b)a(b);else{var e=d&&d.uuid?d.uuid+c.db:i(c,"");a(null,e)}})}),k.request=d.toPromise(function(a,b){if(!k.taskqueue.isReady){k.taskqueue.addTask("request",arguments);return}a.headers=c.headers,a.url=i(c,a.url),m(a,b)}),k.compact=d.toPromise(function(a,b){if(!k.taskqueue.isReady){k.taskqueue.addTask("compact",arguments);return}typeof a=="function"&&(b=a,a={}),a=d.extend(!0,{},a),m({headers:c.headers,url:i(c,"_compact"),method:"POST"},function(){function c(){k.info(function(d,e){e.compact_running?setTimeout(c,a.interval||200):b()})}typeof b=="function"&&c()})}),k._info=d.toPromise(function(a){if(!k.taskqueue.isReady){k.taskqueue.addTask("info",arguments);return}m({headers:c.headers,method:"GET",url:i(c,"")},function(b,d){b?a(b):(d.host=i(c,""),a(null,d))})}),k.get=d.toPromise(function(a,b,e){if(!k.taskqueue.isReady){k.taskqueue.addTask("get",arguments);return}typeof b=="function"&&(e=b,b={}),b=d.extend(!0,{},b),b.auto_encode===undefined&&(b.auto_encode=!0);var f=[];b.revs&&f.push("revs=true"),b.revs_info&&f.push("revs_info=true"),b.local_seq&&f.push("local_seq=true"),b.open_revs&&(b.open_revs!=="all"&&(b.open_revs=JSON.stringify(b.open_revs)),f.push("open_revs="+b.open_revs)),b.attachments&&f.push("attachments=true"),b.rev&&f.push("rev="+b.rev),b.conflicts&&f.push("conflicts="+b.conflicts),f=f.join("&"),f=f===""?"":"?"+f,b.auto_encode&&(a=g(a));var h={headers:c.headers,method:"GET",url:i(c,a+f)},j=a.split("/");if(j.length>1&&j[0]!=="_design"&&j[0]!=="_local"||j.length>2&&j[0]==="_design"&&j[0]!=="_local")h.binary=!0;m(h,function(a,b,c){if(a)return e(a);e(null,b,c)})}),k.remove=d.toPromise(function(a,b,d){if(!k.taskqueue.isReady){k.taskqueue.addTask("remove",arguments);return}typeof b=="function"&&(d=b,b={}),m({headers:c.headers,method:"DELETE",url:i(c,g(a._id))+"?rev="+a._rev},d)}),k.getAttachment=d.toPromise(function(a,b,c,e){typeof c=="function"&&(e=c,c={}),c=d.extend(!0,{},c),c.auto_encode===undefined&&(c.auto_encode=!0),c.auto_encode&&(a=g(a)),c.auto_encode=!1,k.get(a+"/"+b,c,e)}),k.removeAttachment=d.toPromise(function(a,b,d,e){if(!k.taskqueue.isReady){k.taskqueue.addTask("removeAttachment",arguments);return}m({headers:c.headers,method:"DELETE",url:i(c,g(a)+"/"+b)+"?rev="+d},e)}),k.putAttachment=d.toPromise(function(a,b,d,e,f,h){if(!k.taskqueue.isReady){k.taskqueue.addTask("putAttachment",arguments);return}typeof f=="function"&&(h=f,f=e,e=d,d=null),typeof f=="undefined"&&(f=e,e=d,d=null);var j=g(a)+"/"+b,l=i(c,j);d&&(l+="?rev="+d);var n={headers:c.headers,method:"PUT",url:l,processData:!1,body:e,timeout:6e4};n.headers["Content-Type"]=f,m(n,h)}),k.put=d.toPromise(function(){var a=Array.prototype.slice.call(arguments);if(!k.taskqueue.isReady){k.taskqueue.addTask("put",a);return}var b,f,h,j,l=a.shift(),n="_id"in l;if(typeof l!="object"||Array.isArray(l))return j=a.pop(),j(e.NOT_AN_OBJECT);l=d.extend(!0,{},l);for(;;){b=a.shift(),f=typeof b,f==="string"&&!n?(l._id=b,n=!0):f!=="string"||!n||"_rev"in l?f==="object"?h=d.extend(!0,{},b):f==="function"&&(j=b):l._rev=b;if(!a.length)break}h=h||{};var o=d.invalidIdError(l._id);if(o)return j(o);var p=[];h&&typeof h.new_edits!="undefined"&&p.push("new_edits="+h.new_edits),p=p.join("&"),p!==""&&(p="?"+p),m({headers:c.headers,method:"PUT",url:i(c,g(l._id))+p,body:l},j)}),k.post=d.toPromise(function(a,b,c){if(!k.taskqueue.isReady){k.taskqueue.addTask("post",arguments);return}typeof b=="function"&&(c=b,b={}),b=d.extend(!0,{},b);if(typeof a!="object")return c(e.NOT_AN_OBJECT);"_id"in a?k.put(a,b,c):n.list.length>0?(a._id=n.list.pop(),k.put(a,b,c)):n.get(function(d,f){if(d)return c(e.UNKNOWN_ERROR);a._id=n.list.pop(),k.put(a,b,c)})}),k.bulkDocs=d.toPromise(function(a,b,f){if(!k.taskqueue.isReady){k.taskqueue.addTask("bulkDocs",arguments);return}typeof b=="function"&&(f=b,b={}),b||(b={});if(!Array.isArray(a.docs))return f(e.error(e.NOT_AN_OBJECT,"Missing JSON list of 'docs'"));var g=a.docs.filter(function(a){return typeof a!="object"||Array.isArray(a)});if(g.length)return f(e.NOT_AN_OBJECT);a=d.extend(!0,{},a),b=d.extend(!0,{},b),typeof b.new_edits!="undefined"&&(a.new_edits=b.new_edits),m({headers:c.headers,method:"POST",url:i(c,"_bulk_docs"),body:a},f)}),k.allDocs=d.toPromise(function(a,b){if(!k.taskqueue.isReady){k.taskqueue.addTask("allDocs",arguments);return}typeof a=="function"&&(b=a,a={}),a=d.extend(!0,{},a);var e=[],f,g="GET";a.conflicts&&e.push("conflicts=true"),a.descending&&e.push("descending=true"),a.include_docs&&e.push("include_docs=true"),a.key&&e.push("key="+encodeURIComponent(JSON.stringify(a.key))),a.startkey&&e.push("startkey="+encodeURIComponent(JSON.stringify(a.startkey))),a.endkey&&e.push("endkey="+encodeURIComponent(JSON.stringify(a.endkey))),a.limit&&e.push("limit="+a.limit),typeof a.skip!="undefined"&&e.push("skip="+a.skip),e=e.join("&"),e!==""&&(e="?"+e);if(typeof a.keys!="undefined"){var h=2e3,j="keys="+encodeURIComponent(JSON.stringify(a.keys));j.length+e.length+1<=h?e+=(e.indexOf("?")!==-1?"&":"?")+j:(g="POST",f=JSON.stringify({keys:a.keys}))}m({headers:c.headers,method:g,url:i(c,"_all_docs"+e),body:f},b)}),k._changes=function(a){var b=25;a=d.extend(!0,{},a),a.timeout=a.timeout||0;var f={},g=typeof a.limit!="undefined"?a.limit:!1;g===0&&(g=1);var h=g;a.style&&(f.style=a.style);if(a.include_docs||a.filter&&typeof a.filter=="function")f.include_docs=!0;a.continuous&&(f.feed="longpoll"),a.conflicts&&(f.conflicts=!0),a.descending&&(f.descending=!0),a.filter&&typeof a.filter=="string"&&(f.filter=a.filter,a.filter==="_view"&&a.view&&typeof a.view=="string"&&(f.view=a.view));if(a.query_params&&typeof a.query_params=="object")for(var j in a.query_params)a.query_params.hasOwnProperty(j)&&(f[j]=a.query_params[j]);var k,l,n=function(d,e){if(a.aborted)return;f.since=d,a.descending?g&&(f.limit=h):f.limit=!g||h>b?b:h;var j="?"+Object.keys(f).map(function(a){return a+"="+f[a]}).join("&"),n={headers:c.headers,method:"GET",url:i(c,"_changes"+j),timeout:a.timeout};l=d;if(a.aborted)return;k=m(n,e)},o=10,p=0,q={results:[]},r=function(c,f){if(a.aborted)return;var i=0;if(f&&f.results){i=f.results.length,q.last_seq=f.last_seq;var j={};j.query=a.query_params,f.results=f.results.filter(function(b){h--;var c=d.filterChange(a)(b);return c&&(q.results.push(b),d.call(a.onChange,b)),c})}else if(c){a.aborted=!0,d.call(a.complete,c);return}f&&f.last_seq&&(l=f.last_seq);var k=g&&h<=0||f&&i<b||a.descending;if(a.continuous||!k){c?p+=1:p=0;var m=1<<p,s=o*m,t=a.maximumWait||3e4;if(s>t){d.call(a.complete,c||e.UNKNOWN_ERROR);return}setTimeout(function(){n(l,r)},s)}else d.call(a.complete,null,q)};return n(a.since||0,r),{cancel:function(){a.aborted=!0,k.abort()}}},k.revsDiff=d.toPromise(function(a,b,d){if(!k.taskqueue.isReady){k.taskqueue.addTask("revsDiff",arguments);return}typeof b=="function"&&(d=b,b={}),m({headers:c.headers,method:"POST",url:i(c,"_revs_diff"),body:a},function(a,b){d(a,b)})}),k.close=d.toPromise(function(a){if(!k.taskqueue.isReady){k.taskqueue.addTask("close",arguments);return}a()}),k.replicateOnServer=function(a,b,c){if(!k.taskqueue.isReady)return k.taskqueue.addTask("replicateOnServer",arguments),c;a.info(function(d,e){p(a,b,c,e.host)})},k.destroy=d.toPromise(function(a){if(!k.taskqueue.isReady){k.taskqueue.addTask("destroy",arguments);return}d.ajax({url:i(c,""),method:"DELETE"},function(b,c){b?(k.emit("error",b),a(b)):(k.emit("destroyed"),a(null,c))})})}var d=a("../utils"),e=a("../deps/errors");f.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},k.destroy=d.toPromise(function(a,b,c){var e=h(a,b);b=b||{},typeof b=="function"&&(c=b,b={}),b=d.extend(!0,{},b),b.headers=e.headers,b.method="DELETE",b.url=i(e,""),d.ajax(b,c)}),k.valid=function(){return!0},b.exports=k},{"../deps/errors":8,"../utils":18}],3:[function(a,b,c){(function(c){function g(a){return function(b){a(f.error(f.IDB_ERROR,b.target,b.type))}}function h(){var a="_pouch__checkModernIdb_"+(c.navigator&&c.navigator.appVersion),b=d.hasLocalStorage()&&c.localStorage[a];if(b)return JSON.parse(b);var e="_pouch__checkModernIdb",f=c.indexedDB.open(e,1).onupgradeneeded===null;return c.indexedDB.deleteDatabase&&c.indexedDB.deleteDatabase(e),d.hasLocalStorage()&&(c.localStorage[a]=JSON.stringify(f)),f}function i(a,b){function t(a){a.createObjectStore(h,{keyPath:"id"}).createIndex("seq","seq",{unique:!0}),a.createObjectStore(j,{autoIncrement:!0}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0}),a.createObjectStore(k,{keyPath:"digest"}),a.createObjectStore(l,{keyPath:"id",autoIncrement:!1}),a.createObjectStore(m)}function u(a){var b=a.currentTarget.transaction.objectStore(h);b.openCursor().onsuccess=function(a){var c=a.target.result;if(c){var e=c.value,f=d.isDeleted(e),g=d.isLocalId(e.id);e.deletedOrLocal=f||g?"1":"0",b.put(e),c["continue"]()}else b.createIndex("deletedOrLocal","deletedOrLocal",{unique:!1})}}function v(a,b){return a._bulk_seq-b._bulk_seq}function w(a,b,c){var e=b.keys,f="descending"in b?b.descending:!1;if(!e.length)c(null,{offset:b.skip,rows:[],total_rows:a});else{var g=[];e.forEach(function(h){var i=d.extend(!0,{},b);i.keys_request=!0,i.key=h,delete i.keys,delete i.skip,delete i.limit,x(a,i,function(d,i){g.push({err:d,res:i,key:h});if(g.length===e.length){var j={};for(var k=0;k<g.length;k++){var l=g[k];if(l.err){c(d);return}j[l.key]=l}var m=[];e.forEach(function(a){var b=j[a];b.res.rows.length?m.push(b.res.rows[0]):m.push({key:a,error:"not_found"})}),f&&(m=m.reverse()),c(null,{total_rows:a,offset:b.skip,rows:"limit"in b?m.slice(b.skip,b.limit+b.skip):b.skip>0?m.slice(b.skip):m})}})})}}function x(a,b,g){var i="startkey"in b?b.startkey:!1,k="endkey"in b?b.endkey:!1,l="key"in b?b.key:!1,m="descending"in b&&b.descending?"prev":null,n=0,o=!1;m&&i&&k&&(o=k,k=!1);var p;try{p=i&&k?c.IDBKeyRange.bound(i,k):i?m?c.IDBKeyRange.upperBound(i):c.IDBKeyRange.lowerBound(i):k?m?c.IDBKeyRange.lowerBound(k):c.IDBKeyRange.upperBound(k):l?c.IDBKeyRange.only(l):null}catch(q){return q.name==="DataError"&&q.code===0?g(null,{total_rows:a,offset:b.skip,rows:[]}):g(f.error(f.IDB_ERROR,q.name,q.message))}var r=s.transaction([h,j],"readonly");r.oncomplete=function(){g(null,{total_rows:a,offset:b.skip,rows:v})};var t=r.objectStore(h),u=m?t.openCursor(p,m):t.openCursor(p),v=[];u.onsuccess=function(a){function g(a,f){if(d.isLocalId(a.id))return c["continue"]();var g={id:a.id,key:a.id,value:{rev:e.winningRev(a)}};if(b.include_docs){g.doc=f,g.doc._rev=e.winningRev(a),g.doc._doc_id_rev&&delete g.doc._doc_id_rev,b.conflicts&&(g.doc._conflicts=e.collectConflicts(a));for(var h in g.doc._attachments)g.doc._attachments.hasOwnProperty(h)&&(g.doc._attachments[h].stub=!0)}if(b.keys_request)d.isDeleted(a)&&(g.value.deleted=!0,g.doc=null),v.push(g);else if(!d.isDeleted(a))if(!v.length&&b.skip>0&&n<b.skip)n++;else{if(o&&g.key<=o){g.key===o&&v.push(g);return}if("limit"in b&&v.length===b.limit)return;v.push(g)}c["continue"]()}if(!a.target.result)return;var c=a.target.result,f=c.value;if(!b.include_docs)g(f);else{var h=r.objectStore(j).index("_doc_id_rev"),i=e.winningRev(f),k=f.id+"::"+i;h.get(k).onsuccess=function(a){g(c.value,a.target.result)}}}}var h="document-store",j="by-sequence",k="attach-store",l="meta-store",m="detect-blob-support",n=a.name,o=c.indexedDB.open(n);"openReqList"in i||(i.openReqList={}),i.openReqList[n]=o;var p=null,q=null,r=this,s=null;o.onupgradeneeded=function(a){var b=a.target.result;a.oldVersion<1&&t(b),a.oldVersion<2&&u(a)},o.onsuccess=function(a){s=a.target.result,s.onversionchange=function(){s.close()};var c=s.transaction([l,m],"readwrite"),e=c.objectStore(l).get(l);e.onsuccess=function(a){var e=!1,f=function(){if(p===null||!e)return;b(null,r)},g=a.target.result||{id:l};n+"_id"in g?(q=g[n+"_id"],e=!0,f()):(q=d.uuid(),g[n+"_id"]=q,c.objectStore(l).put(g).onsuccess=function(){e=!0,f()});try{c.objectStore(m).put(d.createBlob(),"key"),p=!0}catch(h){p=!1}finally{f()}}},o.onerror=g(b),r.type=function(){return"idb"},r._id=d.toPromise(function(a){a(null,q)}),r._bulkDocs=function(b,c,m){function x(a){var b=a.target.result;b.updateSeq=(b.updateSeq||0)+w,H.objectStore(l).put(b)}function y(){if(!r.length){H.objectStore(l).get(l).onsuccess=x;return}var a=r.shift(),b=H.objectStore(h).get(a.metadata.id);b.onsuccess=function(c){var d=c.target.result;d?D(d,a):E(a)}}function z(a){var b=[];u.sort(v),u.forEach(function(a){delete a._bulk_seq;if(a.error){b.push(a);return}var c=a.metadata,f=e.winningRev(c);b.push({ok:!0,id:c.id,rev:f});if(d.isLocalId(c.id))return;i.Changes.notify(n),i.Changes.notifyLocalWindows(n)}),m(null,b)}function A(a,b){if(a.stub)return b();if(typeof a.data=="string"){var c;try{c=atob(a.data)}catch(e){var g=f.error(f.BAD_ARG,"Attachments need to be base64 encoded");return m(g)}a.digest="md5-"+d.Crypto.MD5(c);if(p){var h=a.content_type;c=d.fixBinary(c),a.data=d.createBlob([c],{type:h})}return b()}var i=new FileReader;i.onloadend=function(c){a.digest="md5-"+d.Crypto.MD5(this.result),p||(a.data=btoa(this.result)),b()},i.readAsBinaryString(a.data)}function B(a){function c(){b++,r.length===b&&a()}if(!r.length)return a();var b=0;r.forEach(function(a){function e(){d++,d===b.length&&c()}var b=a.data&&a.data._attachments?Object.keys(a.data._attachments):[];if(!b.length)return c();var d=0;for(var f in a.data._attachments)a.data._attachments.hasOwnProperty(f)&&A(a.data._attachments[f],e)})}function C(a,b){function g(a){c||(a?(c=a,b(c)):e===f.length&&n())}function i(a){e++,g(a)}function n(){a.data._doc_id_rev=a.data._id+"::"+a.data._rev;var c=H.objectStore(j).put(a.data);c.onsuccess=function(c){a.metadata.seq=c.target.result,delete a.metadata.rev;var e=d.isDeleted(a.metadata),f=d.isLocalId(a.metadata.id),g=d.extend(!0,{deletedOrLocal:e||f?"1":"0"},a.metadata),i=H.objectStore(h).put(g);i.onsuccess=function(){u.push(a),d.call(b)}}}var c=null,e=0;a.data._id=a.metadata.id,a.data._rev=a.metadata.rev,w++,d.isDeleted(a.metadata,a.metadata.rev)&&(a.data._deleted=!0);var f=a.data._attachments?Object.keys(a.data._attachments):[];for(var k in a.data._attachments)if(!a.data._attachments[k].stub){var l=a.data._attachments[k].data;delete a.data._attachments[k].data;var m=a.data._attachments[k].digest;G(a,m,l,i)}else e++,g();f.length||n()}function D(a,b){var c=e.merge(a.rev_tree,b.metadata.rev_tree[0],1e3),g=d.isDeleted(a),h=g&&d.isDeleted(b.metadata)||!g&&o&&c.conflicts!=="new_leaf";if(h)return u.push(F(f.REV_CONFLICT,b._bulk_seq)),y();b.metadata.rev_tree=c.tree,C(b,y)}function E(a){if("was_delete"in c&&d.isDeleted(a.metadata))return u.push(f.MISSING_DOC),y();C(a,y)}function F(a,b){return a._bulk_seq=b,a}function G(a,b,c,e){var f=H.objectStore(k);f.get(b).onsuccess=function(g){var h=g.target.result&&g.target.result.refs||{},i=[a.metadata.id,a.metadata.rev].join("@"),j={digest:b,body:c,refs:h};j.refs[i]=!0,f.put(j).onsuccess=function(a){d.call(e)}}}var o=c.new_edits,q=b.docs,r=q.map(function(a,b){var c=d.parseDoc(a,o);return c._bulk_seq=b,c}),t=r.filter(function(a){return a.error});if(t.length)return m(t[0]);var u=[],w=0,H;B(function(){H=s.transaction([h,j,k,l],"readwrite"),H.onerror=g(m),H.ontimeout=g(m),H.oncomplete=z,y()})},r._get=function(b,c,g){function o(){g(m,{doc:i,metadata:l,ctx:n})}var i,l,m,n;c=d.extend(!0,{},c),c.ctx?n=c.ctx:n=s.transaction([h,j,k],"readonly"),n.objectStore(h).get(b).onsuccess=function(a){l=a.target.result;if(!l)return m=f.MISSING_DOC,o();if(d.isDeleted(l)&&!c.rev)return m=f.error(f.MISSING_DOC,"deleted"),o();var b=e.winningRev(l),g=l.id+"::"+(c.rev?c.rev:b),h=n.objectStore(j).index("_doc_id_rev");h.get(g).onsuccess=function(a){i=a.target.result,i&&i._doc_id_rev&&delete i._doc_id_rev;if(!i)return m=f.MISSING_DOC,o();o()}}},r._getAttachment=function(a,b,c){var e,f;b=d.extend(!0,{},b),b.ctx?f=b.ctx:f=s.transaction([h,j,k],"readonly");var g=a.digest,i=a.content_type;f.objectStore(k).get(g).onsuccess=function(a){var f=a.target.result.body;if(b.encode)if(p){var g=new FileReader;g.onloadend=function(a){e=btoa(this.result),c(null,e)},g.readAsBinaryString(f)}else e=f,c(null,e);else p?e=f:(f=d.fixBinary(atob(f)),e=d.createBlob([f],{type:i})),c(null,e)}},r._allDocs=function(b,d){function i(a){f=a.target.result}var e=s.transaction([h],"readonly"),f,j=e.objectStore(h).index("deletedOrLocal");j.count(c.IDBKeyRange.only("0")).onsuccess=i,e.onerror=g(d),e.oncomplete=function(){"keys"in b?w(f,b,d):x(f,b,d)}},r._info=function(b){function f(a){d=a.target.result&&a.target.result.updateSeq||0}function g(a){var b=a.target.result;if(!b){e.objectStore(l).get(l).onsuccess=f;return}b.value.deleted!==!0&&c++,b["continue"]()}var c=0,d=0,e=s.transaction([h,l],"readonly");e.oncomplete=function(){b(null,{db_name:n,doc_count:c,update_seq:d})},e.objectStore(h).openCursor().onsuccess=g},r._changes=function(b){function q(){p=s.transaction([h,j]),p.oncomplete=u;var a;g?a=p.objectStore(j).openCursor(c.IDBKeyRange.lowerBound(b.since,!0),g):a=p.objectStore(j).openCursor(c.IDBKeyRange.lowerBound(b.since,!0)),a.onsuccess=t,a.onerror=onerror}function t(a){if(!a.target.result){for(var c=0,f=l.length;c<f;c++){var g=l[c];g&&o.push(g)}return!1}var i=a.target.result,n=i.value._id,q=m[n];if(q!==undefined)return l[q].seq=i.key,l.push(l[q]),l[q]=null,m[n]=l.length-1,i["continue"]();var r=p.objectStore(h);r.get(i.value._id).onsuccess=function(a){var c=a.target.result;if(d.isLocalId(c.id))return i["continue"]();k<c.seq&&(k=c.seq);var f=e.winningRev(c),g=c.id+"::"+f,h=p.objectStore(j).index("_doc_id_rev");h.get(g).onsuccess=function(a){var d=a.target.result;delete d._doc_id_rev,d._rev=f;var e=b.processChange(d,c,b);e.seq=i.key;var g=e.id,h=m[g];h!==undefined&&(l[h]=null),l.push(e),m[g]=l.length-1,i["continue"]()}}}function u(){d.processChanges(b,o,k)}b=d.extend(!0,{},b);if(b.continuous){var f=n+":"+d.uuid();return i.Changes.addListener(n,f,r,b),i.Changes.notify(n),{cancel:function(){i.Changes.removeListener(n,f)}}}var g=b.descending?"prev":null,k=0;b.since=b.since&&!g?b.since:0;var l=[],m={},o=[],p;q()},r._close=function(a){if(s===null)return a(f.NOT_OPEN);s.close(),a()},r._getRevisionTree=function(a,b){var c=s.transaction([h],"readonly"),d=c.objectStore(h).get(a);d.onsuccess=function(a){var c=a.target.result;c?b(null,c.rev_tree):b(f.MISSING_DOC)}},r._doCompaction=function(a,b,c,e){var f=s.transaction([h,j],"readwrite"),g=f.objectStore(h);g.get(a).onsuccess=function(e){var g=e.target.result;g.rev_tree=b;var i=c.length;c.forEach(function(b){var c=f.objectStore(j).index("_doc_id_rev"),e=a+"::"+b;c.getKey(e).onsuccess=function(a){var b=a.target.result;if(!b)return;f.objectStore(j)["delete"](b),i--;if(!i){if(g){var c=d.isDeleted(g),e=d.isLocalId(g.id);g=d.extend(!0,{deletedOrLocal:c||e?"1":"0"},g)}f.objectStore(h).put(g)}}})},f.oncomplete=function(){d.call(e)}}}var d=a("../utils"),e=a("../merge"),f=a("../deps/errors");i.valid=function(){return c.indexedDB&&h()},i.destroy=d.toPromise(function(a,b,d){"openReqList"in i||(i.openReqList={}),i.Changes.clearListeners(a),i.openReqList[a]&&i.openReqList[a].result&&i.openReqList[a].result.close();var e=c.indexedDB.deleteDatabase(a);e.onsuccess=function(){i.openReqList[a]&&(i.openReqList[a]=null),d()},e.onerror=g(d)}),i.Changes=new d.Changes,b.exports=i}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"../deps/errors":8,"../merge":14,"../utils":18}],4:[function(a,b,c){(function(c){function g(a){return"'"+a+"'"}function h(){if(typeof c!="undefined")return c.navigator&&c.navigator.sqlitePlugin&&c.navigator.sqlitePlugin.openDatabase?navigator.sqlitePlugin.openDatabase.apply(navigator.sqlitePlugin,arguments):c.sqlitePlugin&&c.sqlitePlugin.openDatabase?c.sqlitePlugin.openDatabase.apply(c.sqlitePlugin,arguments):c.openDatabase.apply(c,arguments)}function u(a){return function(b){var c=b&&b.constructor.toString().match(/function ([^\(]+)/),d=c&&c[1]||b.type,e=b.target||b.message;a(f.error(f.WSQ_ERROR,e,d))}}function v(a){var b="";for(var c=0,d=a.length;c<d;c+=2)b+=String.fromCharCode(parseInt(a.substring(c,c+2),16));return b}function w(a){for(var b=1,c=a.length;b<c;b+=2)if(a.charAt(b)!=="\0")return!1;return!0}function x(a){var b="";for(var c=0,d=a.length;c<d;c+=2)b+=a.charAt(c);return b}function y(a){var b;try{b=decodeURIComponent(window.escape(a))}catch(c){b=a}return w(b)?x(b):b}function z(a,b){function C(){d.hasLocalStorage()&&(c.localStorage["_pouch__websqldb_"+A]=!0),b(null,w)}function D(a){a.executeSql(r),a.executeSql("ALTER TABLE "+m+" ADD COLUMN deleted TINYINT(1) DEFAULT 0",[],function(){a.executeSql(p),a.executeSql("ALTER TABLE "+l+" ADD COLUMN local TINYINT(1) DEFAULT 0",[],function(){a.executeSql(q);var b="SELECT "+l+".winningseq AS seq, "+l+".json AS metadata FROM "+m+" JOIN "+l+" ON "+m+".seq = "+l+".winningseq";a.executeSql(b,[],function(a,b){var c=[],e=[];for(var f=0;f<b.rows.length;f++){var g=b.rows.item(f),h=g.seq,i=JSON.parse(g.metadata);d.isDeleted(i)&&c.push(h),d.isLocalId(i.id)&&e.push(i.id)}a.executeSql("UPDATE "+l+"SET local = 1 WHERE id IN ("+e.map(function(){return"?"}).join(",")+")",e),a.executeSql("UPDATE "+m+" SET deleted = 1 WHERE seq IN ("+c.map(function(){return"?"}).join(",")+")",c)})})})}function E(){while(s.length>0){var a=s.pop();a(null,x)}}function F(a,b){if(b===0){var c="CREATE TABLE IF NOT EXISTS "+o+" (update_seq, dbid, db_version INTEGER)",e="CREATE TABLE IF NOT EXISTS "+n+" (digest, json, body BLOB)",f="CREATE TABLE IF NOT EXISTS "+l+" (id unique, seq, json, winningseq, local TINYINT(1))",g="CREATE TABLE IF NOT EXISTS "+m+" (seq INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, doc_id_rev UNIQUE, json, deleted TINYINT(1))";a.executeSql(e),a.executeSql(f,[],function(){a.executeSql(r),a.executeSql(q)}),a.executeSql(g,[],function(){a.executeSql(p)}),a.executeSql(c,[],function(){var b="INSERT INTO "+o+" (update_seq, db_version, dbid) VALUES (?, ?, ?)";x=d.uuid(),a.executeSql(b,[0,k,x]),E()})}else b===1&&(D(a),a.executeSql("UPDATE "+o+" SET db_version = "+k)),a.executeSql("SELECT dbid FROM "+o,[],function(a,b){x=b.rows.item(0).dbid,E()})}function G(){B.transaction(function(a){a.executeSql("SELECT sql FROM sqlite_master WHERE tbl_name = "+o,[],function(a,b){b.rows.length?/db_version/.test(b.rows.item(0).sql)?a.executeSql("SELECT db_version FROM "+o,[],function(a,b){var c=b.rows.item(0).db_version;F(a,c)}):a.executeSql("ALTER TABLE "+o+" ADD COLUMN db_version INTEGER",[],function(){F(a,1)}):F(a,0)})},u(b),C)}var w=this,x=null,A=a.name,B=t[A];B||(t[A]=B=h(A,i,A,j));if(!B)return b(f.UNKNOWN_ERROR);d.isCordova()&&typeof c!="undefined"?c.addEventListener(A+"_pouch",function H(){c.removeEventListener(A+"_pouch",H,!1),G()},!1):G(),w.type=function(){return"websql"},w._id=d.toPromise(function(a){a(null,x)}),w._info=function(a){B.transaction(function(b){var c="SELECT COUNT(id) AS count FROM "+l;b.executeSql(c,[],function(b,c){var d=c.rows.item(0).count,e="SELECT update_seq FROM "+o;b.executeSql(e,[],function(b,c){var e=c.rows.item(0).update_seq;a(null,{db_name:A,doc_count:d,update_seq:e})})})})},w._bulkDocs=function(a,b,c){function s(a,b){return a._bulk_seq-b._bulk_seq}function t(a){var b=[];q.sort(s),q.forEach(function(a){delete a._bulk_seq;if(a.error){b.push(a);return}var c=a.metadata,f=e.winningRev(c);b.push({ok:!0,id:c.id,rev:f});if(d.isLocalId(c.id))return;i++,z.Changes.notify(A),z.Changes.notifyLocalWindows(A)});var f="SELECT update_seq FROM "+o;p.executeSql(f,[],function(a,d){var e=d.rows.item(0).update_seq+i,f="UPDATE "+o+" SET update_seq=?";a.executeSql(f,[e],function(){c(null,b)})})}function v(a,b){if(a.stub)return b();if(typeof a.data=="string"){try{a.data=atob(a.data)}catch(e){var g=f.error(f.BAD_ARG,"Attachments need to be base64 encoded");return c(g)}var h=d.fixBinary(a.data);a.data=d.createBlob([h],{type:a.content_type})}var i=new FileReader;i.onloadend=function(c){a.data=this.result,a.digest="md5-"+d.Crypto.MD5(this.result),b()},i.readAsBinaryString(a.data)}function w(a){function c(){b++,j.length===b&&a()}if(!j.length)return a();var b=0;j.forEach(function(a){function e(){d++,d===b.length&&c()}var b=a.data&&a.data._attachments?Object.keys(a.data._attachments):[],d=0;if(!b.length)return c();for(var f in a.data._attachments)a.data._attachments.hasOwnProperty(f)&&v(a.data._attachments[f],e)})}function x(a,b,c){function f(){var b=a.data,c="INSERT INTO "+m+" (doc_id_rev, json, deleted) VALUES (?, ?, ?);",e=[b._id+"::"+b._rev,JSON.stringify(b),d.isDeleted(a.metadata,a.metadata.rev)?1:0];p.executeSql(c,e,s)}function g(a){h||(a?(h=a,b(h)):i===j.length&&f())}function k(a){i++,g(a)}function s(f,g){var h=a.metadata.seq=g.insertId;delete a.metadata.rev;var i=e.winningRev(a.metadata),j=c?"UPDATE "+l+" SET seq=?, json=?, winningseq=(SELECT seq FROM "+m+" WHERE doc_id_rev=?) WHERE id=?":"INSERT INTO "+l+" (id, seq, winningseq, json, local) VALUES (?, ?, ?, ?, ?);",k=JSON.stringify(a.metadata),n=a.metadata.id+"::"+i,o=d.isLocalId(a.metadata.id)?1:0,p=c?[h,k,n,a.metadata.id]:[a.metadata.id,h,h,k,o];f.executeSql(j,p,function(c,d){q.push(a),b()})}var h=null,i=0;a.data._id=a.metadata.id,a.data._rev=a.metadata.rev,d.isDeleted(a.metadata,a.metadata.rev)&&(a.data._deleted=!0);var j=a.data._attachments?Object.keys(a.data._attachments):[];for(var n in a.data._attachments)if(!a.data._attachments[n].stub){var o=a.data._attachments[n].data;delete a.data._attachments[n].data;var r=a.data._attachments[n].digest;F(a,r,o,k)}else i++,g();j.length||f()}function y(a,b){var c=e.merge(a.rev_tree,b.metadata.rev_tree[0],1e3),h=d.isDeleted(a)&&d.isDeleted(b.metadata)||!d.isDeleted(a)&&g&&c.conflicts!=="new_leaf";if(h)return q.push(E(f.REV_CONFLICT,b._bulk_seq)),D();b.metadata.rev_tree=c.tree,x(b,D,!0)}function C(a){if("was_delete"in b&&d.isDeleted(a.metadata))return q.push(f.MISSING_DOC),D();x(a,D,!1)}function D(){if(!j.length)return t();var a=j.shift(),b=a.metadata.id;b in r?y(r[b],a):(r[b]=a.metadata,C(a))}function E(a,b){return a._bulk_seq=b,a}function F(a,b,c,d){var e=[a.metadata.id,a.metadata.rev].join("@"),f={digest:b},g="SELECT digest, json FROM "+n+" WHERE digest=?";p.executeSql(g,[b],function(a,h){h.rows.length?(f.refs=JSON.parse(h.rows.item(0).json).refs,g="UPDATE "+n+" SET json=?, body=? WHERE digest=?",a.executeSql(g,[JSON.stringify(f),c,b],function(){d()})):(f.refs={},f.refs[e]=!0,g="INSERT INTO "+n+"(digest, json, body) VALUES (?, ?, ?)",a.executeSql(g,[b,JSON.stringify(f),c],function(){d()}))})}function G(a,b){for(var c=0;c<b.rows.length;c++){var d=b.rows.item(c);r[d.id]=JSON.parse(d.json)}D()}var g=b.new_edits,h=a.docs,i=0,j=h.map(function(a,b){var c=d.parseDoc(a,g);return c._bulk_seq=b,c}),k=j.filter(function(a){return a.error});if(k.length)return c(k[0]);var p,q=[],r={};w(function(){B.transaction(function(a){p=a;var b="SELECT * FROM "+l+" WHERE id IN "+"("+j.map(function(){return"?"}).join(",")+")",c=j.map(function(a){return a.metadata.id});p.executeSql(b,c,G)},u(c))})},w._get=function(a,b,c){function k(){c(i,{doc:g,metadata:h,ctx:j})}b=d.extend(!0,{},b);var g,h,i;if(!b.ctx){B.transaction(function(d){b.ctx=d,w._get(a,b,c)});return}var j=b.ctx,n="SELECT * FROM "+l+" WHERE id=?";j.executeSql(n,[a],function(a,c){if(!c.rows.length)return i=f.MISSING_DOC,k();h=JSON.parse(c.rows.item(0).json);if(d.isDeleted(h)&&!b.rev)return i=f.error(f.MISSING_DOC,"deleted"),k();var l=e.winningRev(h),n=b.rev?b.rev:l;n=h.id+"::"+n;var o="SELECT * FROM "+m+" WHERE doc_id_rev=?";j.executeSql(o,[n],function(a,b){if(!b.rows.length)return i=f.MISSING_DOC,k();g=JSON.parse(b.rows.item(0).json),k()})})},w._allDocs=function(a,b){var c=[],f={},g,h=m+" JOIN "+l+" ON "+m+".seq = "+l+".winningseq",i="startkey"in a?a.startkey:!1,j="endkey"in a?a.endkey:!1,k="key"in a?a.key:!1,n="descending"in a?a.descending:!1,o="keys"in a?a.keys:!1,p="limit"in a?a.limit:!1,q="skip"in a?a.skip:!1,r=[],s=[l+".local = 0"];if(k!==!1)s.push(l+".id = ?"),r.push(k);else if(o!==!1)s.push(l+".id in ("+o.map(function(){return"?"}).join(",")+")"),r=r.concat(o);else if(i!==!1||j!==!1)i!==!1&&(s.push(l+".id "+(n?"<=":">=")+" ?"),r.push(i)),j!==!1&&(s.push(l+".id "+(n?">=":"<=")+" ?"),r.push(j)),k!==!1&&(s.push(l+".id = ?"),r.push(k));o===!1&&s.push(m+".deleted = 0"),B.transaction(function(b){var i="SELECT COUNT("+l+".id) AS 'num' FROM "+h+" WHERE "+m+".deleted = 0 AND "+l+".local = 0";b.executeSql(i,[],function(b,i){g=i.rows.item(0).num;var j="SELECT "+l+".id, "+m+".seq, "+m+".json AS data, "+l+".json AS metadata FROM "+h;s.length&&(j+=" WHERE "+s.join(" AND ")),j+=" ORDER BY "+l+".id "+(n?"DESC":"ASC"),p!==!1&&(j+=" LIMIT "+p),q!==!1&&q>0&&(p===!1&&(j+=" LIMIT -1"),j+=" OFFSET "+q),b.executeSql(j,r,function(b,g){for(var h=0,i=g.rows.length;h<i;h++){var j=g.rows.item(h),k=JSON.parse(j.metadata),l=JSON.parse(j.data);j={id:k.id,key:k.id,value:{rev:e.winningRev(k)}};if(a.include_docs){j.doc=l,j.doc._rev=e.winningRev(k),a.conflicts&&(j.doc._conflicts=e.collectConflicts(k));for(var m in j.doc._attachments)j.doc._attachments.hasOwnProperty(m)&&(j.doc._attachments[m].stub=!0)}"keys"in a?a.keys.indexOf(k.id)>-1&&(d.isDeleted(k)&&(j.value.deleted=!0,j.doc=null),f[j.id]=j):c.push(j)}})})},u(b),function(){"keys"in a&&(a.keys.forEach(function(a){a in f?c.push(f[a]):c.push({key:a,error:"not_found"})}),a.descending&&c.reverse()),b(null,{total_rows:g,offset:a.skip,rows:c})})},w._changes=function(b){function g(){var a="SELECT "+l+".id, "+m+".seq, "+m+".json AS data, "+l+".json AS metadata FROM "+m+" JOIN "+l+" ON "+m+".seq = "+l+".winningseq WHERE "+l+".seq > "+b.since+" ORDER BY "+l+".seq "+(e?"DESC":"ASC");B.transaction(function(c){c.executeSql(a,[],function(a,c){var e=0;for(var g=0,h=c.rows.length;g<h;g++){var i=c.rows.item(g),j=JSON.parse(i.metadata);if(!d.isLocalId(j.id)){e<i.seq&&(e=i.seq);var k=JSON.parse(i.data),l=b.processChange(k,j,b);l.seq=i.seq,f.push(l)}}d.processChanges(b,f,e)})})}b=d.extend(!0,{},b);if(b.continuous){var c=A+":"+d.uuid();return z.Changes.addListener(A,c,w,b),z.Changes.notify(A),{cancel:function(){z.Changes.removeListener(A,c)}}}var e=b.descending;b.since=b.since&&!e?b.since:0;var f=[];g()},w._close=function(a){a()},w._getAttachment=function(a,b,c){var e,f=b.ctx,g=a.digest,h=a.content_type,i="SELECT hex(body) as body FROM "+n+" WHERE digest=?";f.executeSql(i,[g],function(a,f){var g=y(v(f.rows.item(0).body));b.encode?e=btoa(g):(g=d.fixBinary(g),e=d.createBlob([g],{type:h})),c(null,e)})},w._getRevisionTree=function(a,b){B.transaction(function(c){var d="SELECT json AS metadata FROM "+l+" WHERE id = ?";c.executeSql(d,[a],function(a,c){if(!c.rows.length)b(f.MISSING_DOC);else{var d=JSON.parse(c.rows.item(0).metadata);b(null,d.rev_tree)}})})},w._doCompaction=function(a,b,c,e){B.transaction(function(f){var h="SELECT json AS metadata FROM "+l+" WHERE id = ?";f.executeSql(h,[a],function(f,h){if(!h.rows.length)return d.call(e);var i=JSON.parse(h.rows.item(0).metadata);i.rev_tree=b;var j="DELETE FROM "+m+" WHERE doc_id_rev IN ("+c.map(function(b){return g(a+"::"+b)}).join(",")+")";f.executeSql(j,[],function(b,c){var d="UPDATE "+l+" SET json = ? WHERE id = ?";b.executeSql(d,[JSON.stringify(i),a],function(a,b){e()})})})})}}var d=a("../utils"),e=a("../merge"),f=a("../deps/errors"),i=1,j=5242880,k=2,l=g("document-store"),m=g("by-sequence"),n=g("attach-store"),o=g("metadata-store"),p="CREATE INDEX IF NOT EXISTS 'by-seq-deleted-idx' ON "+m+" (seq, deleted)",q="CREATE INDEX IF NOT EXISTS 'doc-store-local-idx' ON "+l+" (local, id)",r="CREATE INDEX IF NOT EXISTS 'doc-winningseq-idx' ON "+l+" (winningseq)",s=[],t={};z.valid=function(){if(typeof c!="undefined"){if(c.navigator&&c.navigator.sqlitePlugin&&c.navigator.sqlitePlugin.openDatabase)return!0;if(c.sqlitePlugin&&c.sqlitePlugin.openDatabase)return!0;if(c.openDatabase)return!0}return!1},z.destroy=d.toPromise(function(a,b,e){var f=h(a,i,a,j);f.transaction(function(a){a.executeSql("DROP TABLE IF EXISTS "+l,[]),a.executeSql("DROP TABLE IF EXISTS "+m,[]),a.executeSql("DROP TABLE IF EXISTS "+n,[]),a.executeSql("DROP TABLE IF EXISTS "+o,[])},u(e),function(){d.hasLocalStorage()&&delete c.localStorage["_pouch__websqldb_"+a],e()})}),z.Changes=new d.Changes,b.exports=z}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"../deps/errors":8,"../merge":14,"../utils":18}],5:[function(a,b,c){(function(c){function h(a){a&&c.debug&&console.error(a)}function i(a,b,c){if(!(this instanceof i))return new i(a,b,c);var j=this;if(typeof b=="function"||typeof b=="undefined")c=b,b={};typeof a=="object"&&(b=a,a=undefined),typeof c=="undefined"&&(c=h),b=b||{};var k=c;j.auto_compaction=b.auto_compaction,j.prefix=i.prefix,d.call(j),j.taskqueue=new g;var l=new f(function(d,f){c=function(a,b){if(a)return f(a);delete b.then,d(b)},b=e.extend(!0,{},b);var g=b.name||a,h,k;(function(){try{if(typeof g!="string")throw k=new Error("Missing/invalid DB name"),k.code=400,k;h=i.parseAdapter(g),b.originalName=g,b.name=h.name,b.adapter=b.adapter||h.adapter;if(!i.adapters[b.adapter])throw k=new Error("Adapter is missing"),k.code=404,k;if(!i.adapters[b.adapter].valid())throw k=new Error("Invalid Adapter"),k.code=404,k}catch(a){j.taskqueue.fail(a),j.changes=e.toPromise(function(b){b.complete&&b.complete(a)})}})();if(k)return f(k);j.adapter=b.adapter,j.replicate=i.replicate.bind(j,j),j.replicate.from=function(a,b,c){return typeof b=="function"&&(c=b,b={}),i.replicate(a,j,b,c)},j.replicate.to=function(a,b,c){return typeof b=="function"&&(c=b,b={}),j.replicate(a,b,c)},j.replicate.sync=function(a,b,c){return typeof b=="function"&&(c=b,b={}),i.sync(j,a,b,c)},j.destroy=e.toPromise(function(a){var b=this;if(!b.taskqueue.isReady){b.taskqueue.addTask("destroy",arguments);return}b.info(function(b,c){if(b)return a(b);i.destroy(c.db_name,a)})}),i.adapters[b.adapter].call(j,b,function(a,d){function e(a){a==="destroyed"&&(j.emit("destroyed"),i.removeListener(b.name,e))}if(a){c&&(j.taskqueue.fail(a),c(a));return}i.on(b.name,e),j.emit("created",j),i.emit("created",b.originalName),j.taskqueue.ready(j),c(null,j)}),b.skipSetup&&j.taskqueue.ready(j),e.isCordova()&&cordova.fireWindowEvent(b.name+"_pouch",{})});l.then(function(a){k(null,a)},k),j.then=l.then.bind(l),function(){try{j.catch=l.catch.bind(l)}catch(a){}}()}var d=a("./adapter"),e=a("./utils"),f=typeof c.Promise=="function"?c.Promise:a("bluebird"),g=a("./taskqueue");e.inherits(i,d),b.exports=i}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"./adapter":1,"./taskqueue":17,"./utils":18,bluebird:24}],6:[function(a,b,c){(function(c){function i(a,b){function m(b,c,d){if(!a.binary&&!a.json&&a.processData&&typeof b!="string")b=JSON.stringify(b);else if(!a.binary&&a.json&&typeof b=="string")try{b=JSON.parse(b)}catch(e){return d(e)}Array.isArray(b)&&(b=b.map(function(a){var b;return a.ok?a:a.error&&a.error==="conflict"?(b=g.REV_CONFLICT,b.id=a.id,b):a.error&&a.error==="forbidden"?(b=g.FORBIDDEN,b.id=a.id,b.reason=a.reason,b):a.missing?(b=g.MISSING_DOC,b.missing=a.missing,b):a})),d(null,b,c)}function n(a,b){var c,d,e,f;try{c=JSON.parse(a.responseText);for(f in g)if(g.hasOwnProperty(f)&&g[f].name===c.error){e=g[f];break}e||(e=g.UNKNOWN_ERROR,a.status&&(e.status=a.status),a.statusText&&(a.name=a.statusText)),d=g.error(e,c.reason)}catch(h){for(var f in g)if(g.hasOwnProperty(f)&&g[f].status===a.status){e=g[f];break}e||(e=g.UNKNOWN_ERROR,a.status&&(e.status=a.status),a.statusText&&(a.name=a.statusText)),d=g.error(e)}b(d)}var i=!1,j=function(){if(i)return;b.apply(this,arguments),i=!0};typeof a=="function"&&(j=a,a={}),a=e(!0,{},a);var k={method:"GET",headers:{},json:!0,processData:!0,timeout:1e4,cache:!1};a=e(!0,k,a);if(a.method==="GET"&&!a.cache){var l=a.url.indexOf("?")!==-1;a.url+=(l?"&":"?")+"_nonce="+h(16)}if(c.browser){var o,p;a.xhr?p=new a.xhr:p=new XMLHttpRequest,p.open(a.method,a.url),p.withCredentials=!0,a.json&&(a.headers.Accept="application/json",a.headers["Content-Type"]=a.headers["Content-Type"]||"application/json",a.body&&a.processData&&typeof a.body!="string"&&(a.body=JSON.stringify(a.body))),a.binary&&(p.responseType="arraybuffer");var q=function(a,b,c){var d="";if(c){var e=new Date;e.setTime(e.getTime()+c*24*60*60*1e3),d="; expires="+e.toGMTString()}document.cookie=a+"="+b+d+"; path=/"};for(var r in a.headers)if(r==="Cookie"){var s=a.headers[r].split("=");q(s[0],s[1],10)}else p.setRequestHeader(r,a.headers[r]);"body"in a||(a.body=null);var t=function(){if(i)return;p.abort(),n(p,j)};return p.onreadystatechange=function(){if(p.readyState!==4||i)return;clearTimeout(o);if(p.status>=200&&p.status<300){var b;a.binary?b=f([p.response||""],{type:p.getResponseHeader("Content-Type")}):b=p.responseText,m(b,p,j)}else n(p,j)},a.timeout>0&&(o=setTimeout(t,a.timeout),p.onprogress=function(){clearTimeout(o),o=setTimeout(t,a.timeout)},p.upload&&(p.upload.onprogress=p.onprogress)),p.send(a.body),{abort:t}}return a.json&&(a.binary||(a.headers.Accept="application/json"),a.headers["Content-Type"]=a.headers["Content-Type"]||"application/json"),a.binary&&(a.encoding=null,a.json=!1),a.processData||(a.json=!1),d(a,function(b,c,d){if(b)return b.status=c?c.statusCode:400,n(b,j);var e,f=c.headers["content-type"],h=d||"";!a.binary&&(a.json||!a.processData)&&typeof h!="object"&&(/json/.test(f)||/^[\s]*\{/.test(h)&&/\}[\s]*$/.test(h))&&(h=JSON.parse(h)),c.statusCode>=200&&c.statusCode<300?m(h,c,j):(a.binary&&(h=JSON.parse(h.toString())),h.reason==="missing"?e=g.MISSING_DOC:h.reason==="no_db_file"?e=g.error(g.DB_MISSING,h.reason):h.error==="conflict"?e=g.REV_CONFLICT:e=g.error(g.UNKNOWN_ERROR,h.reason,h.error),e.status=c.statusCode,j(e))})}var d=a("request"),e=a("./extend.js"),f=a("./blob.js"),g=a("./errors"),h=a("../deps/uuid");b.exports=i}).call(this,a("/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))},{"../deps/uuid":12,"./blob.js":7,"./errors":8,"./extend.js":10,"/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":22,request:20}],7:[function(a,b,c){(function(a){function c(b,c){b=b||[],c=c||{};try{return new Blob(b,c)}catch(d){if(d.name!=="TypeError")throw d;var e=a.BlobBuilder||a.MSBlobBuilder||a.MozBlobBuilder||a.WebKitBlobBuilder,f=new e;for(var g=0;g<b.length;g+=1)f.append(b[g]);return f.getBlob(c.type)}}b.exports=c}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{}],8:[function(a,b,c){function d(a){this.status=a.status,this.name=a.error,this.message=a.reason,this.error=!0}d.prototype__proto__=Error.prototype,d.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message})},c.UNAUTHORIZED=new d({status:401,error:"unauthorized",reason:"Name or password is incorrect."}),c.MISSING_BULK_DOCS=new d({status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"}),c.MISSING_DOC=new d({status:404,error:"not_found",reason:"missing"}),c.REV_CONFLICT=new d({status:409,error:"conflict",reason:"Document update conflict"}),c.INVALID_ID=new d({status:400,error:"invalid_id",reason:"_id field must contain a string"}),c.MISSING_ID=new d({status:412,error:"missing_id",reason:"_id is required for puts"}),c.RESERVED_ID=new d({status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."}),c.NOT_OPEN=new d({status:412,error:"precondition_failed",reason:"Database not open so cannot close"}),c.UNKNOWN_ERROR=new d({status:500,error:"unknown_error",reason:"Database encountered an unknown error"}),c.BAD_ARG=new d({status:500,error:"badarg",reason:"Some query argument is invalid"}),c.INVALID_REQUEST=new d({status:400,error:"invalid_request",reason:"Request was invalid"}),c.QUERY_PARSE_ERROR=new d({status:400,error:"query_parse_error",reason:"Some query parameter is invalid"}),c.DOC_VALIDATION=new d({status:500,error:"doc_validation",reason:"Bad special document member"}),c.BAD_REQUEST=new d({status:400,error:"bad_request",reason:"Something wrong with the request"}),c.NOT_AN_OBJECT=new d({status:400,error:"bad_request",reason:"Document must be a JSON object"}),c.DB_MISSING=new d({status:404,error:"not_found",reason:"Database not found"}),c.IDB_ERROR=new d({status:500,error:"indexed_db_went_bad",reason:"unknown"}),c.WSQ_ERROR=new d({status:500,error:"web_sql_went_bad",reason:"unknown"}),c.LDB_ERROR=new d({status:500,error:"levelDB_went_went_bad",reason:"unknown"}),c.FORBIDDEN=new d({status:403,error:"forbidden",reason:"Forbidden by design doc validate_doc_update function"}),c.error=function(a,b,c){function d(a){this.message=b,c&&(this.name=c)}return d.prototype=a,new d(b)}},{}],9:[function(a,b,c){Object.keys||(Object.keys=function(b){if(typeof b!="object"&&typeof b!="function"||b===null)throw new TypeError("Object.keys called on a non-object");var c=[];for(var d in b)Object.prototype.hasOwnProperty.call(b,d)&&c.push(d);return c}),Array.isArray||(Array.isArray=function(b){return Object.prototype.toString.call(b)==="[object Array]"}),"forEach"in Array.prototype||(Array.prototype.forEach=function(a,b){for(var c=0,d=this.length;c<d;c++)c in this&&a.call(b,this[c],c,this)}),"map"in Array.prototype||(Array.prototype.map=function(a,b){var c=new Array(this.length);for(var d=0,e=this.length;d<e;d++)d in this&&(c[d]=a.call(b,this[d],d,this));return c})},{}],10:[function(a,b,c){function j(a){return a===null?String(a):typeof a=="object"||typeof a=="function"?d[h.call(a)]||"object":typeof a}function k(a){return a!==null&&a===a.window}function l(a){if(!a||j(a)!=="object"||a.nodeType||k(a))return!1;try{if(a.constructor&&!i.call(a,"constructor")&&!i.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(b){return!1}var c;for(c in a);return c===undefined||i.call(a,c)}function m(a){return j(a)==="function"}function o(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;typeof g=="boolean"&&(j=g,g=arguments[1]||{},h=2),typeof g!="object"&&!m(g)&&(g={}),i===h&&(g=this,--h);for(;h<i;h++)if((a=arguments[h])!=null)for(b in a)if(!(b in Object.prototype)){c=g[b],d=a[b];if(g===d)continue;j&&d&&(l(d)||(e=n(d)))?(e?(e=!1,f=c&&n(c)?c:[]):f=c&&l(c)?c:{},g[b]=o(j,f,d)):d!==undefined&&(!n(a)||!m(d))&&(g[b]=d)}return g}var d={},e=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"];for(var f=0;f<e.length;f++){var g=e[f];d["[object "+g+"]"]=g.toLowerCase()}var h=d.toString,i=d.hasOwnProperty,n=Array.isArray||function(a){return j(a)==="array"};b.exports=o},{}],11:[function(a,b,c){(function(b){var d=a("crypto");c.MD5=function(a){function c(a,b){return a<<b|a>>>32-b}function e(a,b){var c,d,e,f,g;return e=a&2147483648,f=b&2147483648,c=a&1073741824,d=b&1073741824,g=(a&1073741823)+(b&1073741823),c&d?g^2147483648^e^f:c|d?g&1073741824?g^3221225472^e^f:g^1073741824^e^f:g^e^f}function f(a,b,c){return a&b|~a&c}function g(a,b,c){return a&c|b&~c}function h(a,b,c){return a^b^c}function i(a,b,c){return b^(a|~c)}function j(a,b,d,g,h,i,j){return a=e(a,e(e(f(b,d,g),h),j)),e(c(a,i),b)}function k(a,b,d,f,h,i,j){return a=e(a,e(e(g(b,d,f),h),j)),e(c(a,i),b)}function l(a,b,d,f,g,i,j){return a=e(a,e(e(h(b,d,f),g),j)),e(c(a,i),b)}function m(a,b,d,f,g,h,j){return a=e(a,e(e(i(b,d,f),g),j)),e(c(a,h),b)}function n(a){var b,c=a.length,d=c+8,e=(d-d%64)/64,f=(e+1)*16,g=new Array(f-1),h=0,i=0;while(i<c)b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|a.charCodeAt(i)<<h,i++;return b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|128<<h,g[f-2]=c<<3,g[f-1]=c>>>29,g}function o(a){var b="",c="",d,e;for(e=0;e<=3;e++)d=a>>>e*8&255,c="0"+d.toString(16),b+=c.substr(c.length-2,2);return b}if(!b.browser)return d.createHash("md5").update(a).digest("hex");var p=[],q,r,s,t,u,v,w,x,y,z=7,A=12,B=17,C=22,D=5,E=9,F=14,G=20,H=4,I=11,J=16,K=23,L=6,M=10,N=15,O=21;p=n(a),v=1732584193,w=4023233417,x=2562383102,y=271733878;for(q=0;q<p.length;q+=16)r=v,s=w,t=x,u=y,v=j(v,w,x,y,p[q+0],z,3614090360),y=j(y,v,w,x,p[q+1],A,3905402710),x=j(x,y,v,w,p[q+2],B,606105819),w=j(w,x,y,v,p[q+3],C,3250441966),v=j(v,w,x,y,p[q+4],z,4118548399),y=j(y,v,w,x,p[q+5],A,1200080426),x=j(x,y,v,w,p[q+6],B,2821735955),w=j(w,x,y,v,p[q+7],C,4249261313),v=j(v,w,x,y,p[q+8],z,1770035416),y=j(y,v,w,x,p[q+9],A,2336552879),x=j(x,y,v,w,p[q+10],B,4294925233),w=j(w,x,y,v,p[q+11],C,2304563134),v=j(v,w,x,y,p[q+12],z,1804603682),y=j(y,v,w,x,p[q+13],A,4254626195),x=j(x,y,v,w,p[q+14],B,2792965006),w=j(w,x,y,v,p[q+15],C,1236535329),v=k(v,w,x,y,p[q+1],D,4129170786),y=k(y,v,w,x,p[q+6],E,3225465664),x=k(x,y,v,w,p[q+11],F,643717713),w=k(w,x,y,v,p[q+0],G,3921069994),v=k(v,w,x,y,p[q+5],D,3593408605),y=k(y,v,w,x,p[q+10],E,38016083),x=k(x,y,v,w,p[q+15],F,3634488961),w=k(w,x,y,v,p[q+4],G,3889429448),v=k(v,w,x,y,p[q+9],D,568446438),y=k(y,v,w,x,p[q+14],E,3275163606),x=k(x,y,v,w,p[q+3],F,4107603335),w=k(w,x,y,v,p[q+8],G,1163531501),v=k(v,w,x,y,p[q+13],D,2850285829),y=k(y,v,w,x,p[q+2],E,4243563512),x=k(x,y,v,w,p[q+7],F,1735328473),w=k(w,x,y,v,p[q+12],G,2368359562),v=l(v,w,x,y,p[q+5],H,4294588738),y=l(y,v,w,x,p[q+8],I,2272392833),x=l(x,y,v,w,p[q+11],J,1839030562),w=l(w,x,y,v,p[q+14],K,4259657740),v=l(v,w,x,y,p[q+1],H,2763975236),y=l(y,v,w,x,p[q+4],I,1272893353),x=l(x,y,v,w,p[q+7],J,4139469664),w=l(w,x,y,v,p[q+10],K,3200236656),v=l(v,w,x,y,p[q+13],H,681279174),y=l(y,v,w,x,p[q+0],I,3936430074),x=l(x,y,v,w,p[q+3],J,3572445317),w=l(w,x,y,v,p[q+6],K,76029189),v=l(v,w,x,y,p[q+9],H,3654602809),y=l(y,v,w,x,p[q+12],I,3873151461),x=l(x,y,v,w,p[q+15],J,530742520),w=l(w,x,y,v,p[q+2],K,3299628645),v=m(v,w,x,y,p[q+0],L,4096336452),y=m(y,v,w,x,p[q+7],M,1126891415),x=m(x,y,v,w,p[q+14],N,2878612391),w=m(w,x,y,v,p[q+5],O,4237533241),v=m(v,w,x,y,p[q+12],L,1700485571),y=m(y,v,w,x,p[q+3],M,2399980690),x=m(x,y,v,w,p[q+10],N,4293915773),w=m(w,x,y,v,p[q+1],O,2240044497),v=m(v,w,x,y,p[q+8],L,1873313359),y=m(y,v,w,x,p[q+15],M,4264355552),x=m(x,y,v,w,p[q+6],N,2734768916),w=m(w,x,y,v,p[q+13],O,1309151649),v=m(v,w,x,y,p[q+4],L,4149444226),y=m(y,v,w,x,p[q+11],M,3174756917),x=m(x,y,v,w,p[q+2],N,718787259),w=m(w,x,y,v,p[q+9],O,3951481745),v=e(v,r),w=e(w,s),x=e(x,t),y=e(y,u);var P=o(v)+o(w)+o(x)+o(y);return P.toLowerCase()}}).call(this,a("/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))},{"/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":22,crypto:20}],12:[function(a,b,c){function d(a,b){var c=d.CHARS,e=[],f;b=b||c.length;if(a)for(f=0;f<a;f++)e[f]=c[0|Math.random()*b];else{var g;e[8]=e[13]=e[18]=e[23]="-",e[14]="4";for(f=0;f<36;f++)e[f]||(g=0|Math.random()*16,e[f]=c[f===19?g&3|8:g])}return e.join("")}d.CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),b.exports=d},{}],13:[function(a,b,c){(function(c){a("./deps/es5_shims");var d=a("./setup");b.exports=d,d.ajax=a("./deps/ajax"),d.extend=a("./deps/extend"),d.utils=a("./utils"),d.Errors=a("./deps/errors");var e=a("./replicate");d.replicate=e.replicate,d.sync=e.sync,d.version=a("./version");var f=a("./adapters/http");d.adapter("http",f),d.adapter("https",f),d.adapter("idb",a("./adapters/idb")),d.adapter("websql",a("./adapters/websql")),d.plugin(a("pouchdb-mapreduce"));if(!c.browser){var g=a("./adapters/leveldb");d.adapter("ldb",g),d.adapter("leveldb",g)}}).call(this,a("/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))},{"./adapters/http":2,"./adapters/idb":3,"./adapters/leveldb":20,"./adapters/websql":4,"./deps/ajax":6,"./deps/errors":8,"./deps/es5_shims":9,"./deps/extend":10,"./replicate":15,"./setup":16,"./utils":18,"./version":19,"/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":22,"pouchdb-mapreduce":35}],14:[function(a,b,c){function e(a){var b=a.shift(),c=[b.id,b.opts,[]],d=c,e;while(a.length)b=a.shift(),e=[b.id,b.opts,[]],d[2].push(e),d=e;return c}function f(a,b){var c=[{tree1:a,tree2:b}],d=!1;while(c.length>0){var e=c.pop(),f=e.tree1,g=e.tree2;if(f[1].status||g[1].status)f[1].status=f[1].status==="available"||g[1].status==="available"?"available":"missing";for(var h=0;h<g[2].length;h++){if(!f[2][0]){d="new_leaf",f[2][0]=g[2][h];continue}var i=!1;for(var j=0;j<f[2].length;j++)f[2][j][0]===g[2][h][0]&&(c.push({tree1:f[2][j],tree2:g[2][h]}),i=!0);i||(d="new_branch",f[2].push(g[2][h]),f[2].sort())}}return{conflicts:d,tree:a}}function g(a,b,c){var d=[],e=!1,g=!1,h;return a.length?(a.forEach(function(a){if(a.pos===b.pos&&a.ids[0]===b.ids[0])h=f(a.ids,b.ids),d.push({pos:a.pos,ids:h.tree}),e=e||h.conflicts,g=!0;else if(c!==!0){var i=a.pos<b.pos?a:b,j=a.pos<b.pos?b:a,k=j.pos-i.pos,l=[],m=[];m.push({ids:i.ids,diff:k,parent:null,parentIdx:null});while(m.length>0){var n=m.pop();if(n.diff===0){n.ids[0]===j.ids[0]&&l.push(n);continue}if(!n.ids)continue;n.ids[2].forEach(function(a,b){m.push({ids:a,diff:n.diff-1,parent:n.ids,parentIdx:b})})}var o=l[0];o?(h=f(o.ids,j.ids),o.parent[2][o.parentIdx]=h.tree,d.push({pos:i.pos,ids:i.ids}),e=e||h.conflicts,g=!0):d.push(a)}else d.push(a)}),g||d.push(b),d.sort(function(a,b){return a.pos-b.pos}),{tree:d,conflicts:e||"internal_node"}):{tree:[b],conflicts:"new_leaf"}}function h(a,b){var c=i.rootToLeaf(a).map(function(a){var c=a.ids.slice(-b);return{pos:a.pos+(a.ids.length-c.length),ids:e(c)}});return c.reduce(function(a,b,c,d){return g(a,b,!0).tree},[c.shift()])}var d=a("./deps/extend"),i={};i.merge=function(a,b,c){a=d(!0,[],a),b=d(!0,{},b);var e=g(a,b);return{tree:h(e.tree,c),conflicts:e.conflicts}},i.winningRev=function(a){var b=[];return i.traverseRevTree(a.rev_tree,function(a,c,d,e,f){a&&b.push({pos:c,id:d,deleted:!!f.deleted})}),b.sort(function(a,b){return a.deleted!==b.deleted?a.deleted>b.deleted?1:-1:a.pos!==b.pos?b.pos-a.pos:a.id<b.id?1:-1}),b[0].pos+"-"+b[0].id},i.traverseRevTree=function(a,b){var c=[];a.forEach(function(a){c.push({pos:a.pos,ids:a.ids})});while(c.length>0){var d=c.pop(),e=d.pos,f=d.ids,g=b(f[2].length===0,e,f[0],d.ctx,f[1]);f[2].forEach(function(a){c.push({pos:e+1,ids:a,ctx:g})})}},i.collectLeaves=function(a){var b=[];return i.traverseRevTree(a,function(a,c,d,e,f){a&&b.unshift({rev:c+"-"+d,pos:c,opts:f})}),b.sort(function(a,b){return b.pos-a.pos}),b.map(function(a){delete a.pos}),b},i.collectConflicts=function(a){var b=i.winningRev(a),c=i.collectLeaves(a.rev_tree),d=[];return c.forEach(function(a){a.rev!==b&&!a.opts.deleted&&d.push(a.rev)}),d},i.rootToLeaf=function(a){var b=[];return i.traverseRevTree(a,function(a,c,d,e,f){e=e?e.slice(0):[],e.push({id:d,opts:f});if(a){var g=c+1-e.length;b.unshift({pos:g,ids:e})}return e}),b},b.exports=i},{"./deps/extend":10}],15:[function(a,b,c){function f(){var a=this;this.cancelled=!1,this.cancel=function(){a.cancelled=!0}}function g(){this.seq=0,this.state="start",this.changes=[],this.docs=[]}function h(a,b,c,e){var f=c.filter?c.filter.toString():"";a.id(function(a,g){b.id(function(a,b){var h=g+b+f+JSON.stringify(c.query_params);e("_local/"+d.Crypto.MD5(h))})})}function i(a,b,c,d){b.get(c,function(b,e){b&&b.status===404?d(null,0):b?d(b):a.get(c,function(a,b){a&&a.status===404||!a&&e.last_seq!==b.last_seq?d(null,0):a?d(a):d(null,b.last_seq)})})}function j(a,b,c,d,e){function f(a,b){a.get(c,function(e,f){if(e&&e.status===404)f={_id:c};else if(e)return b(e);f.last_seq=d,a.put(f,b)})}f(b,function(b,c){if(b)return e(b);f(a,function(a,b){if(a)return e(a);e()})})}function k(a,b,c,e,f){function t(){if(h[0].docs.length===0)return x();var a=h[0].docs;c.bulkDocs({docs:a},{new_edits:!1},function(b,c){if(b)return w("target.bulkDocs completed with error",b);s.docs_written+=a.length,x()})}function u(a,b){if(f.cancelled)return C();if(a)return w("src.get completed with error",a);Object.keys(b).forEach(function(a){var c=b[a].ok;c&&(s.docs_read++,h[0].pendingRevs++,h[0].docs.push(c))}),v()}function v(){var a=h[0].diffs;if(Object.keys(a).length===0){t();return}var c=Object.keys(a)[0],d=a[c].missing;delete a[c],b.get(c,{revs:!0,open_revs:d,attachments:!0},u)}function w(a,b){if(n)return;s.ok=!1,s.status="aborted",s.errors.push(b),s.end_time=new Date,s.last_seq=o,h=[],k=new g;var c={status:500,error:"Replication aborted",reason:a,details:b};n=!0,d.call(e.complete,c,s),f.cancel()}function x(){l=!0,j(b,c,a,h[0].seq,function(a,b){l=!1;if(f.cancelled)return C();if(a)return w("writeCheckpoint completed with error",a);o=h[0].seq,s.last_seq=o,d.call(e.onChange,null,s),h.shift(),A()})}function y(a,b){if(f.cancelled)return C();if(a)return w("target.revsDiff completed with error",a);if(Object.keys(b).length===0){x();return}h[0].diffs=b,h[0].pendingRevs=0,v()}function z(){var a={};h[0].changes.forEach(function(b){a[b.id]=b.changes.map(function(a){return a.rev})}),c.revsDiff(a,y)}function A(){if(f.cancelled)return C();if(h.length===0){B();return}h[0].state==="start"&&(h[0].state="processing",z())}function B(){if(k.changes.length===0){m&&h.length===0&&D();return}if(m||k.changes.length>=q)h.push(k),k=new g,A()}function C(){s.status="cancelled",l||D()}function D(){if(n)return;return s.status=s.status||"complete",s.end_time=new Date,s.last_seq=o,n=!0,d.call(e.complete,null,s)}function E(a){if(f.cancelled)return C();if(n)return;k.seq=a.seq,k.changes.push(a),B()}function F(a,b){m=!0;if(f.cancelled)return C();if(a)return w("src.changes completed with error",a);B()}function G(){i(b,c,a,function(a,c){if(a)return w("fetchCheckpoint completed with error",a);o=c;if(f.cancelled)return C();var d={continuous:p,since:o,style:"all_docs",onChange:E,complete:F,doc_ids:r};e.filter&&(d.filter=e.filter),e.query_params&&(d.query_params=e.query_params);var g=b.changes(d),h=f.cancel;f.cancel=function(){h(),C(),g&&g.cancel instanceof Function&&g.cancel()}})}var h=[],k=new g,l=!1,m=!1,n=!1,o=0,p=e.continuous||e.live||!1,q=e.batch_size||1,r=e.doc_ids,s={ok:!0,start_time:new Date,docs_read:0,docs_written:0,errors:[]};typeof e.since=="undefined"?G():j(b,c,a,e.since,function(a,b){if(a)return w("writeCheckpoint completed with error",a);o=e.since,G()})}function l(a,b){if(typeof a=="string")return new e(a,b);b(null,a)}function m(a,b,c,e){c instanceof Function&&(e=c,c={}),c===undefined&&(c={}),c.complete||(c.complete=e),c=d.extend(!0,{},c),c.continuous=c.continuous||c.live;var g=new f;return l(a,function(a,d){if(a)return e(a);l(b,function(a,b){if(a)return e(a);if(c.server){if(typeof d.replicateOnServer!="function")return e({error:"Server replication not supported for "+d.type()+"adapter"});if(d.type()!==b.type())return e({error:"Server replication for different adapter types ("+d.type()+" and "+b.type()+") is not supported"});d.replicateOnServer(b,c,g)}else h(d,b,c,function(a){k(a,d,b,c,g)})})}),g}function n(a,b,c,e){function h(a,b){return function(c,d){c&&n(),d.direction=b,a(c,d)}}function i(a,b){return b=b||function(){},function(c){return{source:a,change:b(c)}}}function j(a,b,c){return b=d.extend(!0,{},b),b.complete=h(b.complete,c),b.onChange=i(a,b.onChange),b.continuous=b.continuous||b.live,b}function k(){return f=m(a,b,j(a,c,"push"),e),f}function l(){return g=m(b,a,j(b,c,"pull"),e),g}function n(){f&&f.cancel(),g&&g.cancel()}var f,g;return c instanceof Function&&(e=c,c={}),c===undefined&&(c={}),e instanceof Function&&!c.complete&&(c.complete=e),{push:k(),pull:l(),cancel:n}}var d=a("./utils"),e=a("./index");c.replicate=m,c.sync=n},{"./index":13,"./utils":18}],16:[function(a,b,c){(function(c){var d=a("./constructor"),e=a("./utils"),f=a("events").EventEmitter;d.adapters={},d.prefix="_pouch_";var g=new f,h=["on","addListener","emit","listeners","once","removeAllListeners","removeListener","setMaxListeners"],i=["idb","leveldb","websql"];h.forEach(function(a){d[a]=g[a].bind(g)}),d.setMaxListeners(0),d.parseAdapter=function(a){var b=a.match(/([a-z\-]*):\/\/(.*)/),f;if(b){a=/http(s?)/.test(b[1])?b[1]+"://"+b[2]:b[2],f=b[1];if(!d.adapters[f].valid())throw"Invalid adapter";return{name:a,adapter:b[1]}}var g="idb"in d.adapters&&"websql"in d.adapters&&e.hasLocalStorage()&&c.localStorage["_pouch__websqldb_"+d.prefix+a];for(var h=0;h<i.length;++h){var j=i[h];if(j in d.adapters){if(g&&j==="idb")continue;f=d.adapters[j];var k="use_prefix"in f?f.use_prefix:!0;return{name:k?d.prefix+a:a,adapter:j}}}throw"No valid adapter found"},d.destroy=e.toPromise(function(a,b,c){if(typeof b=="function"||typeof b=="undefined")c=b,b={};typeof a=="object"&&(b=a,a=undefined);var e=d.parseAdapter(b.name||a),f=e.name;d.adapters[e.adapter].destroy(f,b,function(a,b){a?c(a):(d.emit("destroyed",f),d.emit(f,"destroyed"),c(null,b))})}),d.allDbs=e.toPromise(function(a){var b=new Error("allDbs method removed");b.stats="400",a(b)}),d.adapter=function(a,b){b.valid()&&(d.adapters[a]=b)},d.plugin=function(a){Object.keys(a).forEach(function(b){d.prototype[b]=a[b]})},b.exports=d}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"./constructor":5,"./utils":18,events:21}],17:[function(a,b,c){function d(){this.isReady=!1,this.failed=!1,this.queue=[]}b.exports=d,d.prototype.execute=function(){var a,b;if(this.failed)while(a=this.queue.shift())b=a.parameters[a.parameters.length-1],typeof b=="function"?b(this.failed):a.name==="changes"&&typeof b.complete=="function"&&b.complete(this.failed);else if(this.isReady)while(a=this.queue.shift())a.task=this.db[a.name].apply(this.db,a.parameters)},d.prototype.fail=function(a){this.failed=a,this.execute()},d.prototype.ready=function(a){if(this.failed)return!1;if(arguments.length===0)return this.isReady;this.isReady=a?!0:!1,this.db=a,this.execute()},d.prototype.addTask=function(a,b){var c={name:a,parameters:b};return this.queue.push(c),this.failed&&this.execute(),c}},{}],18:[function(a,b,c){(function(b,d){function l(){return typeof chrome!="undefined"&&typeof chrome.storage!="undefined"&&typeof chrome.storage.local!="undefined"}var e=a("./merge");c.extend=a("./deps/extend"),c.ajax=a("./deps/ajax"),c.createBlob=a("./deps/blob");var f=a("./deps/uuid");c.Crypto=a("./deps/md5.js");var g=a("./deps/buffer"),h=a("./deps/errors"),i=a("events").EventEmitter,j=typeof d.Promise=="function"?d.Promise:a("bluebird"),k=["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree"];c.inherits=a("inherits"),c.uuids=function(a,b){typeof b!="object"&&(b={});var c=b.length,d=b.radix,e=[];while(e.push(f(c,d))<a);return e},c.uuid=function(a){return c.uuids(1,a)[0]},c.invalidIdError=function(a){if(!a)return h.MISSING_ID;if(typeof a!="string")return h.INVALID_ID;if(/^_/.test(a)&&!/^_(design|local)/.test(a))return h.RESERVED_ID},c.call=function(a){if(typeof a==typeof Function){var b=Array.prototype.slice.call(arguments,1);a.apply(this,b)}},c.isLocalId=function(a){return/^_local/.test(a)},c.isDeleted=function(a,b){b||(b=e.winningRev(a)),b.indexOf("-")>=0&&(b=b.split("-")[1]);var c=!1;return e.traverseRevTree(a.rev_tree,function(a,d,e,f,g){e===b&&(c=!!g.deleted)}),c},c.filterChange=function(a){return function(b){var c={},d=a.filter&&typeof a.filter=="function";c.query=a.query_params;if(a.filter&&d&&!a.filter.call(this,b.doc,c))return!1;if(a.doc_ids&&a.doc_ids.indexOf(b.id)===-1)return!1;if(!a.include_docs)delete b.doc;else for(var e in b.doc._attachments)b.doc._attachments.hasOwnProperty(e)&&(b.doc._attachments[e].stub=!0);return!0}},c.processChanges=function(a,b,d){b=b.filter(c.filterChange(a)),a.limit&&a.limit<b.length&&(b.length=a.limit),b.forEach(function(b){c.call(a.onChange,b)}),a.continuous||c.call(a.complete,null,{results:b,last_seq:d})},c.parseDoc=function(a,b){var d=null,e,f,g,i={status:"available"};a._deleted&&(i.deleted=!0);if(b){a._id||(a._id=c.uuid()),f=c.uuid({length:32,radix:16}).toLowerCase();if(a._rev){g=/^(\d+)-(.+)$/.exec(a._rev);if(!g)throw"invalid value for property '_rev'";a._rev_tree=[{pos:parseInt(g[1],10),ids:[g[2],{status:"missing"},[[f,i,[]]]]}],e=parseInt(g[1],10)+1}else a._rev_tree=[{pos:1,ids:[f,i,[]]}],e=1}else{a._revisions&&(a._rev_tree=[{pos:a._revisions.start-a._revisions.ids.length+1,ids:a._revisions.ids.reduce(function(a,b){return a===null?[b,i,[]]:[b,{status:"missing"},[a]]},null)}],e=a._revisions.start,f=a._revisions.ids[0]);if(!a._rev_tree){g=/^(\d+)-(.+)$/.exec(a._rev);if(!g)return h.BAD_ARG;e=parseInt(g[1],10),f=g[2],a._rev_tree=[{pos:parseInt(g[1],10),ids:[g[2],i,[]]}]}}d=c.invalidIdError(a._id);for(var j in a)a.hasOwnProperty(j)&&j[0]==="_"&&k.indexOf(j)===-1&&(d=c.extend({},h.DOC_VALIDATION),d.reason+=": "+j);return a._id=decodeURIComponent(a._id),a._rev=[e,f].join("-"),d?d:Object.keys(a).reduce(function(b,c){return/^_/.test(c)&&c!=="_attachments"?b.metadata[c.slice(1)]=a[c]:b.data[c]=a[c],b},{metadata:{},data:{}})},c.isCordova=function(){return typeof cordova!="undefined"||typeof PhoneGap!="undefined"||typeof phonegap!="undefined"},c.hasLocalStorage=function(){try{return d.localStorage}catch(a){return!1}},c.Changes=function(){var a={},b=new i,e=l(),f={},g=!1;return e||(g=c.hasLocalStorage()),e?chrome.storage.onChanged.addListener(function(a){a.db_name!=null&&b.emit(a.dbName.newValue)}):g&&d.addEventListener("storage",function(a){b.emit(a.key)}),a.addListener=function(a,d,e,g){function h(){e.changes({include_docs:g.include_docs,conflicts:g.conflicts,continuous:!1,descending:!1,filter:g.filter,view:g.view,since:g.since,query_params:g.query_params,onChange:function(a){a.seq>g.since&&!g.cancelled&&(g.since=a.seq,c.call(g.onChange,a))}})}if(f[d])return;f[d]=h,b.on(a,h)},a.removeListener=function(a,c){if(!(c in f))return;b.removeListener(a,f[c])},a.clearListeners=function(a){b.removeAllListeners(a)},a.notifyLocalWindows=function(a){e?chrome.storage.local.set({dbName:a}):g&&(localStorage[a]=localStorage[a]==="a"?"b":"a")},a.notify=function(a){b.emit(a)},a},!!b.browser&&"atob"in d?c.atob=function(a){return atob(a)}:c.atob=function(a){var b=new g(a,"base64");if(b.toString("base64")!==a)throw"Cannot base64 encode full string";return b.toString("binary")},!!b.browser&&"btoa"in d?c.btoa=function(a){return btoa(a)}:c.btoa=function(a){return(new g(a,"binary")).toString("base64")},c.fixBinary=function(a){if(!b.browser)return a;var c=a.length,d=new ArrayBuffer(c),e=new Uint8Array(d);for(var f=0;f<c;f++)e[f]=a.charCodeAt(f);return d},c.once=function(a){var b=!1;return function(){if(b)throw console.trace(),new Error("once called  more than once");b=!0,a.apply(this,arguments)}},c.toPromise=function(a,d){return function(){var e=this,f=Array.prototype.slice.call(arguments),g=typeof f[f.length-1]=="function"?f.pop():!1,h;g&&(h=function(a,c){b.nextTick(function(){g(a,c)})});var i=new j(function(g,h){try{var j=c.once(function(a,b){a?h(a):g(b)});d?b.nextTick(function(){f.push(i),f.push(j),a.apply(e,f)}):(f.push(j),a.apply(e,f))}catch(k){h(k)}});return h&&i.then(function(a){h(null,a)},h),i.cancel=function(){return this},i}}}).call(this,a("/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"),typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"./deps/ajax":6,"./deps/blob":7,"./deps/buffer":20,"./deps/errors":8,"./deps/extend":10,"./deps/md5.js":11,"./deps/uuid":12,"./merge":14,"/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":22,bluebird:24,events:21,inherits:23}],19:[function(a,b,c){b.exports=a("../package.json").version},{"../package.json":37}],20:[function(a,b,c){},{}],21:[function(a,b,c){function d(){this._events=this._events||{},this._maxListeners=this._maxListeners||undefined}function e(a){return typeof a=="function"}function f(a){return typeof a=="number"}function g(a){return typeof a=="object"&&a!==null}function h(a){return a===void 0}b.exports=d,d.EventEmitter=d,d.prototype._events=undefined,d.prototype._maxListeners=undefined,d.defaultMaxListeners=10,d.prototype.setMaxListeners=function(a){if(!f(a)||a<0||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},d.prototype.emit=function(a){var b,c,d,f,i,j;this._events||(this._events={});if(a==="error")if(!this._events.error||g(this._events.error)&&!this._events.error.length)throw b=arguments[1],b instanceof Error?b:TypeError('Uncaught, unspecified "error" event.');c=this._events[a];if(h(c))return!1;if(e(c))switch(arguments.length){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:d=arguments.length,f=new Array(d-1);for(i=1;i<d;i++)f[i-1]=arguments[i];c.apply(this,f)}else if(g(c)){d=arguments.length,f=new Array(d-1);for(i=1;i<d;i++)f[i-1]=arguments[i];j=c.slice(),d=j.length;for(i=0;i<d;i++)j[i].apply(this,f)}return!0},d.prototype.addListener=function(a,b){var c;if(!e(b))throw TypeError("listener must be a function");this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,e(b.listener)?b.listener:b),this._events[a]?g(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b;if(g(this._events[a])&&!this._events[a].warned){var c;h(this._maxListeners)?c=d.defaultMaxListeners:c=this._maxListeners,c&&c>0&&this._events[a].length>c&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),console.trace())}return this},d.prototype.on=d.prototype.addListener,d.prototype.once=function(a,b){function d(){this.removeListener(a,d),c||(c=!0,b.apply(this,arguments))}if(!e(b))throw TypeError("listener must be a function");var c=!1;return d.listener=b,this.on(a,d),this},d.prototype.removeListener=function(a,b){var c,d,f,h;if(!e(b))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;c=this._events[a],f=c.length,d=-1;if(c===b||e(c.listener)&&c.listener===b)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,b);else if(g(c)){for(h=f;h-->0;)if(c[h]===b||c[h].listener&&c[h].listener===b){d=h;break}if(d<0)return this;c.length===1?(c.length=0,delete this._events[a]):c.splice(d,1),this._events.removeListener&&this.emit("removeListener",a,b)}return this},d.prototype.removeAllListeners=function(a){var b,c;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[a]&&delete this._events[a],this;if(arguments.length===0){for(b in this._events){if(b==="removeListener")continue;this.removeAllListeners(b)}return this.removeAllListeners("removeListener"),this._events={},this}c=this._events[a];if(e(c))this.removeListener(a,c);else while(c.length)this.removeListener(a,c[c.length-1]);return delete this._events[a],this},d.prototype.listeners=function(a){var b;return!this._events||!this._events[a]?b=[]:e(this._events[a])?b=[this._events[a]]:b=this._events[a].slice(),b},d.listenerCount=function(a,b){var c;return!a._events||!a._events[b]?c=0:e(a._events[b])?c=1:c=a._events[b].length,c}},{}],22:[function(a,b,c){var d=b.exports={};d.nextTick=function(){var a=typeof window!="undefined"&&window.setImmediate,b=typeof window!="undefined"&&window.postMessage&&window.addEventListener;if(a)return function(a){return window.setImmediate(a)};if(b){var c=[];return window.addEventListener("message",function(a){var b=a.source;if((b===window||b===null)&&a.data==="process-tick"){a.stopPropagation();if(c.length>0){var d=c.shift();d()}}},!0),function(b){c.push(b),window.postMessage("process-tick","*")}}return function(b){setTimeout(b,0)}}(),d.title="browser",d.browser=!0,d.env={},d.argv=[],d.binding=function(a){throw new Error("process.binding is not supported")},d.cwd=function(){return"/"},d.chdir=function(a){throw new Error("process.chdir is not supported")}},{}],23:[function(a,b,c){typeof Object.create=="function"?b.exports=function(b,c){b.super_=c,b.prototype=Object.create(c.prototype,{constructor:{value:b,enumerable:!1,writable:!0,configurable:!0}})}:b.exports=function(b,c){b.super_=c;var d=function(){};d.prototype=c.prototype,b.prototype=new d,b.prototype.constructor=b}},{}],24:[function(a,b,c){function f(a,b,c){e?Object.defineProperty(a,b,{value:c,configurable:!0,writable:!0}):a[b]=c}function g(a){if(!(this instanceof g))return new g(a);f(this,"successQueue",[]),f(this,"failureQueue",[]),f(this,"resolved",!1),typeof a=="function"&&this.resolvePassed(a)}function h(a,b,c){c&&typeof c.then=="function"?c.then(a,b):a(c)}function i(a,b,c){function e(){var e=arguments[c];return typeof e!="function"?a:new g(function(a,c){d(j,e,b,a,c)})}return e}function j(a,b,c,d){try{h(c,d,a(b))}catch(e){d(e)}}var d=a("immediate"),e=!1;(function(){try{Object.defineProperty({},"test",{value:!0}),e=!0}catch(a){}})(),f(g.prototype,"resolvePassed",function(a){try{a(this.fulfillUnwrap.bind(this),this.reject.bind(this))}catch(b){this.reject(b)}}),f(g.prototype,"reject",function(a){this.resolve(!1,a)}),f(g.prototype,"fulfill",function(a){this.resolve(!0,a)}),f(g.prototype,"fulfillUnwrap",function(a){h(this.fulfill.bind(this),this.reject.bind(this),a)}),g.prototype.then=function(a,b){return this.resolved?this.resolved(a,b):this.pending(a,b)},function(){try{g.prototype.catch=function(a){return this.then(null,a)}}catch(a){}}(),f(g.prototype,"pending",function(a,b){var c=this;return new g(function(d,e){typeof a=="function"?c.successQueue.push({resolve:d,reject:e,callback:a}):c.successQueue.push({next:d,callback:!1}),typeof b=="function"?c.failureQueue.push({resolve:d,reject:e,callback:b}):c.failureQueue.push({next:e,callback:!1})})}),f(g.prototype,"resolve",function(a,b){if(this.resolved)return;this.resolved=i(this,b,a?0:1);var c=a?this.successQueue:this.failureQueue,e=c.length,f=-1;while(++f<e)c[f].callback?d(j,c[f].callback,b,c[f].resolve,c[f].reject):c[f].next(b)}),b.exports=g},{immediate:27}],25:[function(a,b,c){c.test=function(){return!1}},{}],26:[function(a,b,c){(function(a){b.exports=typeof a=="object"&&a?a:this}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{}],27:[function(a,b,c){function f(){var a=0,b,c=e;e=[];while(b=c[a++])b()}var d=[a("./nextTick"),a("./mutation"),a("./realSetImmediate"),a("./postMessage"),a("./messageChannel"),a("./stateChange"),a("./timeout")],e=[],g,h=-1,i=d.length;while(++h<i)if(d[h].test()){g=d[h].install(f);break}var j=function(a){var b,c,d=a;return arguments.length>1&&typeof a=="function"&&(c=Array.prototype.slice.call(arguments,1),d=function(){a.apply(undefined,c)}),(b=e.push(d))===1&&g(f),b};j.clear=function(a){return a<=e.length&&(e[a-1]=function(){}),this},b.exports=j},{"./messageChannel":28,"./mutation":29,"./nextTick":25,"./postMessage":30,"./realSetImmediate":31,"./stateChange":32,"./timeout":33}],28:[function(a,b,c){var d=a("./global");c.test=function(){return!!d.MessageChannel},c.install=function(a){var b=new d.MessageChannel;return b.port1.onmessage=a,function(){b.port2.postMessage(0)}}},{"./global":26}],29:[function(a,b,c){var d=a("./global"),e=d.MutationObserver||d.WebKitMutationObserver;c.test=function(){return e},c.install=function(a){var b=new e(a),c=d.document.createElement("div");return b.observe(c,{attributes:!0}),d.addEventListener("unload",function(){b.disconnect(),b=null},!1),function(){c.setAttribute("drainQueue","drainQueue")}}},{"./global":26}],30:[function(a,b,c){var d=a("./global");c.test=function(){if(!d.postMessage||d.importScripts)return!1;var a=!0,b=d.onmessage;return d.onmessage=function(){a=!1},d.postMessage("","*"),d.onmessage=b,a},c.install=function(a){function c(c){c.source===d&&c.data===b&&a()}var b="com.calvinmetcalf.setImmediate"+Math.random();return d.addEventListener?d.addEventListener("message",c,!1):d.attachEvent("onmessage",c),function(){d.postMessage(b,"*")}}},{"./global":26}],31:[function(a,b,c){var d=a("./global");c.test=function(){return d.setImmediate},c.install=function(a){return d.setTimeout.bind(d,a,0)}},{"./global":26}],32:[function(a,b,c){var d=a("./global");c.test=function(){return"document"in d&&"onreadystatechange"in d.document.createElement("script")},c.install=function(a){return function(){var b=d.document.createElement("script");return b.onreadystatechange=function(){a(),b.onreadystatechange=null,b.parentNode.removeChild(b),b=null},d.document.documentElement.appendChild(b),a}}},{"./global":26}],33:[function(a,b,c){c.test=function(){return!0},c.install=function(a){return function(){setTimeout(a,0)}}},{}],34:[function(_dereq_,module,exports){module.exports=function(func,emit,sum,log,isArray,toJSON){return eval(" ("+func+");")}},{}],35:[function(a,b,c){(function(b,d){function k(a){var b={};for(var c=0,d=a.length;c<d;c++){var e=j(a[c]),f=b[e];typeof f=="undefined"?b[e]=c:typeof f=="number"?b[e]=[f,c]:f.push(c)}return b}function l(a,b){var c=g(a.id,b.id);return c!==0?c:g(a.value,b.value)}function m(a,b,c){var d=c[a];typeof d=="undefined"?c[a]=b:Array.isArray(d)?d.push(b):c[a]=[d,b]}function n(a){return a.reduce(function(a,b){return a+b},0)}function p(a,b,c,d){var e=b[a];typeof e!="undefined"&&(d&&(e=encodeURIComponent(JSON.stringify(e))),c.push(a+"="+e))}function q(a,b,c){var d=new Array(b.length);a.forEach(function(a){var b=c[j(a.key)];typeof b=="number"?m(b,a,d):b.forEach(function(b){m(b,a,d)})});var e=[];return d.forEach(function(a){Array.isArray(a)?e=e.concat(a.sort(l)):e.push(a)}),e}function r(a,b,c){function r(b,d){var h={id:f.doc._id,key:b,value:d};if(typeof c.startkey!="undefined"&&g(b,c.startkey)<0)return;if(typeof c.endkey!="undefined"&&g(b,c.endkey)>0)return;if(typeof c.key!="undefined"&&g(b,c.key)!==0)return;if(typeof c.keys!="undefined"){p=p||k(c.keys);if(typeof p[j(b)]=="undefined")return}l++;if(c.include_docs){if(d&&typeof d=="object"&&d._id){a.get(d._id,function(a,b){b&&(h.doc=b),e.push(h),s()});return}h.doc=f.doc}e.push(h)}function s(){var a;if(m&&e.length===l){typeof c.keys!="undefined"&&e.length?e=q(e,c.keys,p):e.sort(function(a,b){var c=g(a.key,b.key);return c!==0?c:g(a.id,b.id)}),c.descending&&e.reverse();if(c.reduce===!1)return c.complete(null,{total_rows:e.length,offset:c.skip,rows:"limit"in c?e.slice(c.skip,c.limit+c.skip):c.skip>0?e.slice(c.skip):e});var d=[];e.forEach(function(a){var b=d[d.length-1];if(b&&g(b.key[0][0],a.key)===0){b.key.push([a.key,a.id]),b.value.push(a.value);return}d.push({key:[[a.key,a.id]],value:[a.value]})}),d.forEach(function(c){c.value=b.reduce.call(null,c.key,c.value);if(c.value.sumsqr&&c.value.sumsqr instanceof Error){a=c.value;return}c.key=c.key[0][0]});if(a){c.complete(a);return}c.complete(null,{total_rows:d.length,offset:c.skip,rows:"limit"in c?d.slice(c.skip,c.limit+c.skip):c.skip>0?d.slice(c.skip):d})}}var d;c.skip||(c.skip=0),b.reduce||(c.reduce=!1);var e=[],f,l=0,m=!1,p;typeof b.map=="function"&&b.map.length===2?(d=b.map,b.map=function(a){return d(a,r)}):b.map=h(b.map.toString(),r,n,i,Array.isArray,JSON.parse),b.reduce&&(o[b.reduce]?b.reduce=o[b.reduce]:b.reduce=h(b.reduce.toString(),r,n,i,Array.isArray,JSON.parse)),a.changes({conflicts:!0,include_docs:!0,onChange:function(a){!("deleted"in a)&&a.id[0]!=="_"&&(f={doc:a.doc},b.map.call(null,a.doc))},complete:function(){m=!0,s()}})}function s(a,b,c){var d=c.complete,e=[],f,g="GET";p("reduce",c,e),p("include_docs",c,e),p("limit",c,e),p("descending",c,e),p("group",c,e),p("group_level",c,e),p("skip",c,e),p("startkey",c,e,!0),p("endkey",c,e,!0),p("key",c,e,!0),typeof c.keys!="undefined"&&(g="POST",typeof b=="string"?f=JSON.stringify({keys:c.keys}):b.keys=c.keys),e=e.join("&"),e=e===""?"":"?"+e;if(typeof b=="string"){var h=b.split("/");a.request({method:g,url:"_design/"+h[0]+"/_view/"+h[1]+e,body:f},d);return}var i=JSON.parse(JSON.stringify(b,function(a,b){return typeof b=="function"?b+"":b}));a.request({method:"POST",url:"_temp_view"+e,body:i},d)}var e=a("pouchdb-collate"),f=typeof d.Promise=="function"?d.Promise:a("lie"),g=e.collate,h=a("./evalfunc"),i=typeof console!="undefined"?Function.prototype.bind.call(console.log,console):function(){},j=function(a){return JSON.stringify(e.normalizeKey(a))},o={_sum:function(a,b){return n(b)},_count:function(a,b,c){return b.length},_stats:function(a,b){return{sum:n(b),min:Math.min.apply(null,b),max:Math.max.apply(null,b),count:b.length,sumsqr:function(){var a=0,c;for(var d in b){if(typeof b[d]!="number")return c=new Error("builtin _stats function requires map values to be numbers"),c.name="invalid_value",c.status=500,c;a+=b[d]*b[d]}return a}()}}};c.query=function(a,c,d){var e=this;typeof c=="function"&&(d=c,c={}),c=c||{},d&&(c.complete=d);var g=c.complete,h;c.complete&&(h=function(a,c){b.nextTick(function(){g(a,c)})});var i=new f(function(b,d){c.complete=function(a,c){a?d(a):b(c)};if(e.type()==="http")return typeof a=="function"?s(e,{map:a},c):s(e,a,c);if(typeof a=="object")return r(e,a,c);if(typeof a=="function")return r(e,{map:a},c);var f=a.split("/");e.get("_design/"+f[0],function(a,b){if(a){c.complete(a);return}if(!b.views[f[1]]){c.complete({name:"not_found",message:"missing_named_view"});return}r(e,{map:b.views[f[1]].map,reduce:b.views[f[1]].reduce},c)})});return h&&i.then(function(a){h(null,a)},h),i}}).call(this,a("/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"),typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"./evalfunc":34,"/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":22,lie:24,"pouchdb-collate":36}],36:[function(a,b,c){function d(a,b){var d=Math.min(a.length,b.length);for(var e=0;e<d;e++){var f=c.collate(a[e],b[e]);if(f!==0)return f}return a.length===b.length?0:a.length>b.length?1:-1}function e(a,b){return a===b?0:a>b?1:-1}function f(a,b){var d=Object.keys(a),e=Object.keys(b),f=Math.min(d.length,e.length);for(var g=0;g<f;g++){var h=c.collate(d[g],e[g]);if(h!==0)return h;h=c.collate(a[d[g]],b[e[g]]);if(h!==0)return h}return d.length===e.length?0:d.length>e.length?1:-1}function g(a){var b=["boolean","number","string","object"];if(b.indexOf(typeof a)!==-1)return a===null?1:b.indexOf(typeof a)+2;if(Array.isArray(a))return 4.5}c.collate=function(a,b){a=c.normalizeKey(a),b=c.normalizeKey(b);var h=g(a),i=g(b);if(h-i!==0)return h-i;if(a===null)return 0;if(typeof a=="number")return a-b;if(typeof a=="boolean")return a===b?0:a<b?-1:1;if(typeof a=="string")return e(a,b);if(Array.isArray(a))return d(a,b);if(typeof a=="object")return f(a,b)},c.normalizeKey=function(a){if(typeof a=="undefined")return null;if(typeof a=="number"){if(a===Infinity||a===-Infinity||isNaN(a))return null}else if(a instanceof Date)return a.toJSON();return a}},{}],37:[function(a,b,c){b.exports={name:"pouchdb",version:"2.0.1-alpha",description:"PouchDB is a pocket-sized database.",release:"nightly",main:"./lib/index.js",homepage:"https://github.com/daleharvey/pouchdb",repository:"https://github.com/daleharvey/pouchdb",keywords:["db","couchdb","pouchdb"],tags:["db","couchdb","pouchdb"],dependencies:{bluebird:"~1.0.0",inherits:"~2.0.1","level-sublevel":"~5.2.0",leveldown:"~0.10.2",levelup:"~0.18.2",lie:"^2.5.3","pouchdb-mapreduce":"1.0.0",request:"~2.28.0"},devDependencies:{commander:"~2.1.0",watchify:"~0.4.1","uglify-js":"~2.4.6",jshint:"~2.3.0","http-proxy":"~0.10.3",corsproxy:"~0.2.13","http-server":"~0.5.5",browserify:"~3.24.13",wd:"~0.2.8",tin:"~0.4.0",mocha:"~1.17.1",chai:"~1.9.0",istanbul:"~0.2.4",ncp:"~0.5.0","sauce-connect-launcher":"0.2.2",less:"~1.7.0",bower:"~1.2.8"},scripts:{jshint:"jshint -c .jshintrc bin/ lib/ tests/*.js","build-js":"browserify lib/index.js -s PouchDB -o dist/pouchdb-nightly.js",uglify:"uglifyjs dist/pouchdb-nightly.js -mc > dist/pouchdb-nightly.min.js",build:"mkdir -p dist && npm run build-js && npm run uglify","test-node":"./bin/run-mocha.sh","test-browser":"mkdir -p dist && npm run build-js && ./bin/test-browser.js",dev:"./bin/dev-server.js",test:"npm run jshint && ./bin/run-test.sh",publish:"./bin/publish.sh","publish-site":"./bin/publish-site.sh","build-site":"./bin/build-site.sh",shell:"./bin/repl.js"},browser:{"./adapters/leveldb":!1,"./deps/buffer":!1,request:!1,levelup:!1,leveldown:!1,crypto:!1,bluebird:"lie","level-sublevel":!1}}},{}]},{},[13])(13)}),define("lib/db/pouch_db_util",["lib/db/pouchdb","lib/db/db_util"],function(a,b){function c(c){var d=b.get_store_db_name(c);return new a(d)}function d(a,b,c){b.remove(a,function(a,b){c(a)})}function e(c,d){var e=b.get_store_db_name(c);a.destroy(e,function(a,b){d(a)})}return{delete_doc:d,get_store_db:c,delete_db:e}}),define("lib/db/couch_db_util",["lib/db/db_util"],function(a){function b(b,c){return b+"/"+a.get_store_db_name(c)}function c(a){return parseInt(a._rev.split("-")[0])}function d(a,b){return b._id==a._id?c(b)-c(a):b._id>a._id?1:-1}function e(a){function b(a){var b=!0;for(var c=0;c<a.length;c++){var d=a[c];if(!d._id||!d._rev){b=!1;break}}return b}if(!b(a))return alert("list contain invalid document"),null;ret_doc_lst=[],a.sort(d);var c=null;for(var e=0;e<a.length;e++){var f=a[e];if(c!=null&&f._id==c._id)continue;ret_doc_lst.push(f),c=f}return ret_doc_lst}return{filter_old_rev:e,get_db_url:b}}),define("constance",[],function(){return{MAIN_OS_NAME:"by-sequence",PENDING_SCAN_OS_NAME:"pending_scan",DOCUMENT_TYPE_INDEX:"document_type_index",PRODUCT_NAME_INDEX_NAME:"product_name_index",PRODUCT_ID_INDEX_NAME:"product_id_index",SKU_INDEX_NAME:"sku_index",DOCUMENT_ID_INDEX_NAME:"document_id_index",STORE_PRODUCT_TYPE:"prod_bus_assoc",RECEIPT_TYPE:"receipt",STATIC_URL:"/static/",TAX_DOCUMENT_ID:"tax_document",TEST_STORE_ID:0}}),define("app/local_db_initializer/oneshot_sync",["lib/db/pouch_db_util","lib/db/couch_db_util","constance","lib/async"],function(a,b,c,d){function e(c,d,e){var f=a.get_store_db(c),g=b.get_db_url(d,c);f.replicate.from(g,function(a,b){e(a)})}return function(a,b,c){var f=e.bind(e,a,b);d.waterfall([f],function(a,b){c(a)})}}),define("app/local_db_initializer/sync_if_nessesary",["lib/db/db_util","lib/async","app/local_db_initializer/oneshot_sync"],function(a,b,c){return function(d,e,f){var g=a.is_store_idb_exist.bind(a.is_store_idb_exist,d);b.waterfall([g],function(a,g){if(a){$.unblockUI(),f(a);return}if(g===null)$.unblockUI(),f(null);else{var h=c.bind(c,d,e);b.waterfall([h],function(a,b){$.unblockUI(),f(a)})}})}}),define("app/store_product/sp_online_creator",[],function(){return function(a,b,c,d,e,f,g,h,i,j){var k={product_id:a,name:b,price:c,crv:d,is_taxable:e,is_sale_report:f,sku_str:g,p_type:h,p_tag:i};$.ajax({url:"/product/sp_creator",method:"POST",data:k,dataType:"json",success:function(a,b,c){j(null,a)},error:function(a,b,c){j(a)}})}}),define("app/sku/product_sku_online_adder",[],function(){return function(a,b,c){$.ajax({url:"/product/sku/add",type:"POST",dataType:"json",data:{product_id:a,sku_str:b},success:function(a,b,d){var e=a;c(null,e)},error:function(a,b,d){c(a)}})}}),define("app/store_product/Store_product",["constance"],function(a){function b(b,c,d,e,f,g,h,i,j,k,l,m,n){b!=null&&c!=null&&(this._id=b,this._rev=c),this.key=d,this.store_id=e,this.product_id=f,this.name=g,this.price=h==null?null:Number(h),this.crv=i==null?null:Number(i),this.is_taxable=j,this.is_sale_report=k,this.p_type=l,this.p_tag=m,this.sku_lst=n,this.d_type=a.STORE_PRODUCT_TYPE}return b}),define("app/store_product/sp_online_getter",[],function(){return function(a,b,c,d){$.ajax({url:"/product/getter_ajax",type:"GET",dataType:"json",data:{product_id:a,is_include_other_store:b,is_include_lookup_type_tag:c},success:function(a,b,c){d(null,a)},error:function(a,b,c){d(a)}})}}),define("lib/number/number",[],function(){function a(a){return+a.toFixed(5)}function b(a){return+a.toFixed(2)}function c(a,b,c){var e=prompt(a,b);return d(e)?parseInt(e):null}function d(a){return parseInt(a)%1==0}function e(a,b,c){var d=prompt(a,b);return d==null?null:h(d)?parseInt(d):(c&&alert(c),null)}function f(a,b,c){var d=prompt(a,b);if(d==null)return null;if(g(d))return parseFloat(d);if(c)return alert(c),null}function g(a){if(a==null)return!1;if(isNaN(a))return!1;var b=parseFloat(a);return b>=0?!0:!1}function h(a){var b=/^\d+$/;return b.test(a)}return{prompt_positive_integer:e,is_positive_integer:h,prompt_positive_double:f,is_positive_double:g,round_2_decimal:b,trim:a,prompt_integer:c}}),define("app/store_product/store_product_validator",["lib/number/number"],function(a){function g(g,h,i,j,k,l){var m=new Array;return(g==null||g==undefined||g.trim().length==0)&&m.push(b),(h==null||h==undefined||!a.is_positive_double(h))&&m.push(c),i!=null&&i!=undefined&&typeof i=="string"&&i.trim().length!=0&&!a.is_positive_double(i)&&m.push(d),(j==null||j==undefined||typeof j!="boolean")&&m.push(e),l&&(k==null||k==undefined||k.trim().length==0)&&m.push(f),m}var b="ERROR_STORE_PRODUCT_VALIDATION_NAME",c="ERROR_STORE_PRODUCT_VALIDATION_PRICE",d="ERROR_STORE_PRODUCT_VALIDATION_CRV",e="ERROR_STORE_PRODUCT_VALIDATION_TAXABLE",f="ERROR_STORE_PRODUCT_VALIDATION_SKU";return{validate:g,ERROR_STORE_PRODUCT_VALIDATION_NAME:b,ERROR_STORE_PRODUCT_VALIDATION_PRICE:c,ERROR_STORE_PRODUCT_VALIDATION_CRV:d,ERROR_STORE_PRODUCT_VALIDATION_TAXABLE:e,ERROR_STORE_PRODUCT_VALIDATION_SKU:f}}),define("app/store_product/sp_prompt",["app/store_product/store_product_validator"],function(a){function d(a){$("#store_product_prompt_dialog").dialog("close"),a(b)}function e(a){$("#store_product_prompt_dialog").dialog("close"),a(c,null)}function f(b,c){var d={name:$("#product_name_txt").val(),price:$("#product_price_txt").val(),is_taxable:$("#product_taxable_check").is(":checked"),is_sale_report:$("#product_sale_report_check").is(":checked"),p_type:$("#product_type_txt").val(),p_tag:$("#product_tag_txt").val(),crv:$("#product_crv_txt").val(),sku_str:$("#product_sku_txt").val()},e=a.validate(d.name,d.price,d.crv,d.is_taxable,d.sku_str,b);if(e.length!=0){g(e);return}$("#store_product_prompt_dialog").dialog("close"),c(null,d)}function g(b){$("#product_name_txt").removeClass("error"),$("#product_price_txt").removeClass("error"),$("#product_crv_txt").removeClass("error"),$("#product_sku_txt").removeClass("error"),b.indexOf(a.ERROR_STORE_PRODUCT_VALIDATION_NAME)!=-1&&$("#product_name_txt").addClass("error"),b.indexOf(a.ERROR_STORE_PRODUCT_VALIDATION_PRICE)!=-1&&$("#product_price_txt").addClass("error"),b.indexOf(a.ERROR_STORE_PRODUCT_VALIDATION_CRV)!=-1&&$("#product_crv_txt").addClass("error"),b.indexOf(a.ERROR_STORE_PRODUCT_VALIDATION_SKU)!=-1&&$("#product_sku_txt").addClass("error")}function h(a,b,c,d,e,f,g){$("#product_name_txt").val(a),$("#product_price_txt").val(b),$("#product_crv_txt").val(c),$("#product_taxable_check").prop("checked",d),$("#product_sale_report_check").prop("checked",e),$("#product_type_txt").val(f),$("#product_tag_txt").val(g)}function i(a,b,c,d,e,f,i,j,k,l){l?$("#sku_management_btn").show():$("#sku_management_btn").hide(),h(a,b,c,d,e,f,i),g([]),k?($("#product_sku_txt").show(),$('label[for="product_sku_txt"]').show(),$("#product_sku_txt").val(j),$("#product_sku_txt").attr("readonly",j!=null)):($("#product_sku_txt").hide(),$('label[for="product_sku_txt"]').hide())}function j(a,b,c,g,h,j,k,l,m,n,o,p,q){var r=f.bind(f,m,q),s=d.bind(d,q),t=p==null?"create new product":"create product "+p.name;$("#store_product_prompt_dialog").dialog({title:t,buttons:[{text:"Ok",click:r},{text:"Cancel",click:s}],modal:!0,width:600,heigh:400});var u=e.bind(e,q);$("#sku_management_btn").off("click").click(u),i(a,b,c,g,h,j,k,l,m,o);if(n){var v=Object.keys(n);$("#product_type_txt").on("autocompletechange",function(){var a=n[$(this).val()];a==undefined&&(a=[]),$("#product_tag_txt").autocomplete({source:a,minLength:0}).bind("focus",function(){$(this).autocomplete("search")})}),$("#product_type_txt").autocomplete({source:v,minLength:0}).bind("focus",function(){$(this).autocomplete("search")})}$("#store_product_prompt_dialog").dialog("open")}var b="ERROR_CANCEL_STORE_PRODUCT_PROMPT",c="MANAGE_SKU_BUTTON_PRESS";return{ERROR_CANCEL_STORE_PRODUCT_PROMPT:b,MANAGE_SKU_BUTTON_PRESS:c,show_prompt:j}}),define("app/store_product/sp_online_searcher",[],function(){function c(b,c){var b=b.trim();if(!b){c(a);return}$.ajax({url:"/product/search/name_ajax",type:"GET",data:{name_str:b},dataType:"json",success:function(a,b,d){c(null,a.prod_lst)},error:function(a,b,d){c(a)}})}function d(a,c){var a=a.trim();if(!a){c(b);return}$.ajax({url:"/product/search/sku_ajax",type:"GET",data:{sku_str:a},dataType:"json",success:function(a,b,d){c(null,a)},error:function(a,b,d){c(a)}})}var a="NAME_SEARCH_ERROR_EMPTY",b="SKU_SEARCH_ERROR_EMPTY";return{NAME_SEARCH_ERROR_EMPTY:a,SKU_SEARCH_ERROR_EMPTY:b,name_search:c,sku_search:d}}),define("app/product/product_json_helper",[],function(){function a(a,b){var c=null;for(var d=0;d<b.length;d++)if(b[d].product_id==a){c=b[d];break}return c}function b(a,b){var c=null;for(var d=0;d<b.length;d++)if(b[d].product_id==a){c=b[d];break}return c}function c(a,b){var c=null;if(b==null)c=a.store_product_set[0];else for(var d=0;d<a.store_product_set.length;d++){var e=a.store_product_set[d];if(e.store_id==b){c=e;break}}return c}function d(a){return prod_sku_assoc_set=a.prodskuassoc_set,prod_sku_assoc_set==null&&(prod_sku_assoc_set=[]),prod_sku_assoc_set}function e(a,b){var c=!1;for(var d=0;d<b.length;d++)if(b[d].store_id==a){c=!0;break}return c}function f(a,b,c){var d=!1,e=null;for(var f=0;f<b.length;f++)if(b[f].sku_str==c){e=b[f];break}for(var f=0;f<e.store_set.length;f++)if(e.store_set.indexOf(a)!=-1){d=!0;break}return d}function g(a,b,c,d,g){var h=new Array;for(var i=0;i<a.length;i++){var j=a[i],k,l;k=e(b,a[i].store_product_set)==c,g==null?l=!0:l=f(b,a[i].prodskuassoc_set,g)==d,k&&l&&h.push(j)}return h}return{get_prod_sku_assoc_set:d,get_sp_from_p:c,extract_prod_store__prod_sku:g,get_p_from_lst:b,get_sp_from_sp_lst:a}}),define("app/store_product/sp_creator",["lib/async","app/store_product/sp_prompt","app/local_db_initializer/sync_if_nessesary","app/store_product/sp_online_creator","app/product/product_json_helper","app/sku/product_sku_online_adder"],function(a,b,c,d,e,f){function h(b,c,e){var f=d.bind(d,b,c.name,c.price,c.crv,c.is_taxable,c.is_sale_report,c.sku_str,c.p_type,c.p_tag);a.waterfall([f],function(a,b){e(a,b)})}function i(a){$("#select_product_option_dialog").dialog("close"),a(g)}function j(a,b,c,d){if(a.length==0&&b.length==0)d(null,null);else{$("#product_option_create_new_btn").off("click").click(function(){d(null,null),$("#select_product_option_dialog").dialog("close")});var f=document.getElementById("select_product_option_tbl");f.innerHTML="";var g,h;h=f.insertRow(-1),g=h.insertCell(-1),g.innerHTML="product",g=h.insertCell(-1),g.innerHTML="add";for(var j=0;j<a.length;j++){var k=a[j],l=e.get_sp_from_p(k,c);h=f.insertRow(-1),g=h.insertCell(-1),g.innerHTML=l.name,g=h.insertCell(-1),g.innerHTML="sku",function(a){g.addEventListener("click",function(){$("#select_product_option_dialog").dialog("close"),d(null,a)})}(k)}for(var j=0;j<b.length;j++){var k=b[j];h=f.insertRow(-1),g=h.insertCell(-1),g.innerHTML=k.name,g=h.insertCell(-1),g.innerHTML="product",function(a){g.addEventListener("click",function(){$("#select_product_option_dialog").dialog("close"),d(null,a)})}(k)}var m=i.bind(i,d);$("#select_product_option_dialog").dialog({title:"create new product or select option",buttons:[{text:"cancel",click:m}]})}}function k(d,g,i,k,l,m){var n=e.extract_prod_store__prod_sku(g,k,!1,!1,d),o=e.extract_prod_store__prod_sku(g,k,!1,!0,d),p=e.extract_prod_store__prod_sku(g,k,!0,!1,d),q=e.extract_prod_store__prod_sku(g,k,!0,!0,d);if(q.length!=0)m("there is error: attempt to create a product that is already exist");else if(o.length!=0)m("there is error. please report bug: data integrity constrain failed");else{var r=j.bind(j,p,n,k);a.waterfall([r],function(g,j){if(g){m(g);return}var n=j;if(n!=null&&e.get_p_from_lst(n.product_id,p)){var o=f.bind(f,n.product_id,d);a.waterfall([o],function(a,b){m(a,b)})}else{var q=b.show_prompt.bind(b.show_prompt,null,null,null,!1,!0,null,null,d,!0,i,!1,n),r=n==null?null:n.product_id,s=h.bind(h,r);a.waterfall([q,s],function(b,d){if(b){m(b);return}product=d;var e=c.bind(c,k,l);a.waterfall([e],function(a,b){m(a,product)})})}})}}var g="ERROR_CANCEL_select_product_option";return{exe:k,ERROR_CANCEL_select_product_option:g}}),define("app/store_product/sp_updator",["lib/async","app/store_product/sp_prompt","app/store_product/sp_online_getter","app/local_db_initializer/sync_if_nessesary","app/product/product_json_helper"],function(a,b,c,d,e){function f(a,b,c,d,e,f,g,h,i,j,k){$.ajax({url:"/product/updator_ajax",type:"POST",dataType:"json",data:{product_id:b,name:d,price:e,crv:f,is_taxable:g,is_sale_report:h,p_type:i,p_tag:j},success:function(a,b,c){var d=a.error_message,e=a.product;d.length!=0?k(d):k(null,e)},error:function(a,b,c){k(a)}})}function g(b,c,d,e,g){var h=f.bind(f,b,c,d,e.name,e.price,e.crv,e.is_taxable,e.is_sale_report,e.p_type,e.p_tag);a.waterfall([h],function(a,b){g(a,b)})}function h(c,d,f){var g=d.product,h=d.lookup_type_tag,i=e.get_sp_from_p(g,c),j=b.show_prompt.bind(b.show_prompt,i.name,i.price,i.crv,i.is_taxable,i.is_sale_report,i.p_type,i.p_tag,null,!1,h,!0,null);a.waterfall([j],function(a,b){f(a,b)})}function i(b,e,f,i){console.assert(b,"param product_id is invalid"),console.assert(e,"param store_id is invalid"),console.assert(f,"param couch_server_url is invalid");var j=c.bind(c,b,!1,!0),k=h.bind(h,e),l=g.bind(g,e,b,f);a.waterfall([j,k,l],function(b,c){if(b)i(b,null);else{var g=c,h=d.bind(d,e,f);a.waterfall([h],function(a,b){i(a,g)})}})}return{exe:i}}),define("app/sku/product_sku_online_deletor",[],function(){return function(a,b,c){$.ajax({url:"/product/sku/delete",type:"POST",dataType:"json",data:{product_id:a,sku_str:b},success:function(a,b,d){var e=a;c(null,e)},error:function(a,b,d){c(a)}})}}),define("app/sku/product_sku_manager",["lib/async","app/store_product/sp_online_getter","app/product/product_json_helper","app/sku/product_sku_online_deletor","app/sku/product_sku_online_adder","app/local_db_initializer/sync_if_nessesary"],function(a,b,c,d,e,f){function j(a){return a.store_set.length==1&&a.creator_id==g}function k(b){if(!j(b))return;if(!confirm("delete?"))return;var c=d.bind(d,b.product_id,b.sku_str);a.waterfall([c],function(b,c){if(b)alert(b);else{var d=c,e=f.bind(f,g,h);a.waterfall([e],function(a,b){a?alert(a):l(d)})}})}function l(a){var b=c.get_prod_sku_assoc_set(a);i.innerHTML="";var d,e;d=i.insertRow(),e=d.insertCell(-1),e.innerHTML="sku",e=d.insertCell(-1),e.innerHTML="action";for(var f=0;f<b.length;f++){var g=b[f];d=i.insertRow(-1),e=d.insertCell(-1),e.innerHTML=g.sku_str,e=d.insertCell(-1),e.innerHTML=j(g)?"remove":"",function(a){e.addEventListener("click",function(){k(a)})}(g)}}function m(b){var c=prompt("enter sku");if(!c)return;var d=e.bind(e,b,c);a.waterfall([d],function(b,c){if(b)alert(b);else{var d=c,e=f.bind(f,g,h);a.waterfall([e],function(a,b){a?alert(a):l(d)})}})}var g=null,h=null,i=document.getElementById("sku_tbl");return function(d,e,f){g=e,h=f;var i=b.bind(b,d,!0,!1);a.waterfall([i],function(a,b){if(a){alert(a);return}var e=b.product,f=c.get_sp_from_p(e,g);l(e);var h=m.bind(m,d);$("#add_sku_btn").off("click").click(h),$("#sku_management_dialog").dialog({title:f.name,buttons:[{text:"exit",click:function(){$("#sku_management_dialog").dialog("close")}}]})})}}),define("lib/error_lib",[],function(){function b(a){return a.statusText!=undefined&&a.status!=undefined}function c(a){return a&&typeof a=="string"&&a.indexOf("ERROR_CANCEL_")==0}function d(b){c(b)||(e(b)?alert(a):f(b)?alert(a):alert("There is untreated error:"+b))}function e(a){return b(a)&&a.status==0}function f(a){return a.__proto__&&a.__proto__.name=="unknown_error"&&a.__proto__.message=="Database encountered an unknown error"}var a="Internet is disconnected. Try again later.";return{alert_error:d,is_xhr_obj:b,is_offline_error:e}}),requirejs.config({baseUrl:STATIC_URL+"js",paths:{app:"app",lib:"lib"}}),require(["lib/async","lib/misc/csrf_ajax_protection_setup","app/store_product/sp_creator","app/store_product/Store_product","app/store_product/sp_updator","app/store_product/sp_prompt","app/store_product/sp_online_searcher","app/product/product_json_helper","app/sku/product_sku_manager","lib/error_lib"],function(a,b,c,d,e,f,g,h,i,j){function m(b){var d=h.extract_prod_store__prod_sku(k,STORE_ID,!0,!0,l);if(d.length==0){var e=c.exe.bind(c.exe,l,k,b,STORE_ID,COUCH_SERVER_URL);a.waterfall([e],function(a,b){if(a){j.alert_error(a);return}k=[b],o()})}}function n(b){var c=e.exe.bind(e.exe,b,STORE_ID,COUCH_SERVER_URL);a.waterfall([c],function(a,c){if(a){a==f.MANAGE_SKU_BUTTON_PRESS?i(b,STORE_ID,COUCH_SERVER_URL):j.alert_error(a);return}var d=c;for(var e=0;e<k.length;e++)if(k[e].product_id==d.product_id){k[e]=d;break}o()})}function o(){var a=document.getElementById("product_tbl");a.innerHTML="";var b=h.extract_prod_store__prod_sku(k,STORE_ID,!0,!0,l);if(b.length==0)return;var c,d;c=a.insertRow();var e=["product","price","crv","taxable","is_sale_report","p_type","p_tag","edit"];for(var f=0;f<e.length;f++)d=c.insertCell(-1),d.innerHTML=e[f];for(var f=0;f<b.length;f++){var c=a.insertRow(-1),d;sp=h.get_sp_from_p(b[f],STORE_ID),d=c.insertCell(-1),d.innerHTML=sp.name,d=c.insertCell(-1),d.innerHTML=sp.price,d=c.insertCell(-1),d.innerHTML=sp.crv,d=c.insertCell(-1),d.innerHTML=sp.is_taxable,d=c.insertCell(-1),d.innerHTML=sp.is_sale_report,d=c.insertCell(-1),d.innerHTML=sp.p_type,d=c.insertCell(-1),d.innerHTML=sp.p_tag,d=c.insertCell(-1),d.innerHTML="edit",function(a){d.addEventListener("click",function(){n(a)})}(sp.product_id)}}var k=null,l=null;b(),$("#sku_txt").keypress(function(b){var c=b.keyCode?b.keyCode:b.which;if(c=="13"){var d=$("#sku_txt").val().trim();if(!d)return;l=d;var e=g.sku_search.bind(g.sku_search,d);a.waterfall([e],function(a,b){if(a)j.alert_error(a);else{k=b.prod_lst;var c=h.extract_prod_store__prod_sku(k,STORE_ID,!1,!0,l);if(c.length!=0){alert("Please report bug: data integrity constrain failed");return}o(),m(b.lookup_typ_tag)}})}}),$("#name_txt").keypress(function(b){var c=b.keyCode?b.keyCode:b.which;if(c=="13"){var d=$("#name_txt").val().trim();if(!d)return;l=null;var e=g.name_search.bind(g.name_search,d);a.waterfall([e],function(a,b){a?j.alert_error(a):(k=b,o())})}})}),define("app/product/product",function(){})