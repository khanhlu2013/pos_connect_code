// parseUri 1.2.2
// (c) Steven Levithan <stevenlevithan.com>
// MIT License

/**
*
*  MD5 (Message-Digest Algorithm)
*
*  For original source see http://www.webtoolkit.info/
*  Download: 15.02.2009 from http://www.webtoolkit.info/javascript-md5.html
*
*  Licensed under CC-BY 2.0 License
*  (http://creativecommons.org/licenses/by/2.0/uk/)
*
**/

/*!
Math.uuid.js (v1.4)
http://www.broofa.com
mailto:robert@broofa.com
 
Copyright (c) 2010 Robert Kieffer
Dual licensed under the MIT and GPL licenses.
*/

// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

/*
 * jQuery Hotkeys Plugin
 * Copyright 2010, John Resig
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Based upon the plugin by Tzury Bar Yochay:
 * http://github.com/tzuryby/hotkeys
 *
 * Original idea by:
 * Binny V A, http://www.openjs.com/scripts/events/keyboard_shortcuts/
*/

(function(){function r(e){var n=!1;return function(){if(n)throw new Error("Callback was already called.");n=!0,e.apply(t,arguments)}}var e={},t,n;t=this,t!=null&&(n=t.async),e.noConflict=function(){return t.async=n,e};var i=function(e,t){if(e.forEach)return e.forEach(t);for(var n=0;n<e.length;n+=1)t(e[n],n,e)},s=function(e,t){if(e.map)return e.map(t);var n=[];return i(e,function(e,r,i){n.push(t(e,r,i))}),n},o=function(e,t,n){return e.reduce?e.reduce(t,n):(i(e,function(e,r,i){n=t(n,e,r,i)}),n)},u=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t};typeof process=="undefined"||!process.nextTick?typeof setImmediate=="function"?(e.nextTick=function(e){setImmediate(e)},e.setImmediate=e.nextTick):(e.nextTick=function(e){setTimeout(e,0)},e.setImmediate=e.nextTick):(e.nextTick=process.nextTick,typeof setImmediate!="undefined"?e.setImmediate=setImmediate:e.setImmediate=e.nextTick),e.each=function(e,t,n){n=n||function(){};if(!e.length)return n();var s=0;i(e,function(i){t(i,r(function(t){t?(n(t),n=function(){}):(s+=1,s>=e.length&&n(null))}))})},e.forEach=e.each,e.eachSeries=function(e,t,n){n=n||function(){};if(!e.length)return n();var r=0,i=function(){t(e[r],function(t){t?(n(t),n=function(){}):(r+=1,r>=e.length?n(null):i())})};i()},e.forEachSeries=e.eachSeries,e.eachLimit=function(e,t,n,r){var i=a(t);i.apply(null,[e,n,r])},e.forEachLimit=e.eachLimit;var a=function(e){return function(t,n,r){r=r||function(){};if(!t.length||e<=0)return r();var i=0,s=0,o=0;(function u(){if(i>=t.length)return r();while(o<e&&s<t.length)s+=1,o+=1,n(t[s-1],function(e){e?(r(e),r=function(){}):(i+=1,o-=1,i>=t.length?r():u())})})()}},f=function(t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[e.each].concat(n))}},l=function(e,t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[a(e)].concat(n))}},c=function(t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[e.eachSeries].concat(n))}},h=function(e,t,n,r){var i=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n,r){i[e.index]=r,t(n)})},function(e){r(e,i)})};e.map=f(h),e.mapSeries=c(h),e.mapLimit=function(e,t,n,r){return p(t)(e,n,r)};var p=function(e){return l(e,h)};e.reduce=function(t,n,r,i){e.eachSeries(t,function(e,t){r(n,e,function(e,r){n=r,t(e)})},function(e){i(e,n)})},e.inject=e.reduce,e.foldl=e.reduce,e.reduceRight=function(t,n,r,i){var o=s(t,function(e){return e}).reverse();e.reduce(o,n,r,i)},e.foldr=e.reduceRight;var d=function(e,t,n,r){var i=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n&&i.push(e),t()})},function(e){r(s(i.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};e.filter=f(d),e.filterSeries=c(d),e.select=e.filter,e.selectSeries=e.filterSeries;var v=function(e,t,n,r){var i=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n||i.push(e),t()})},function(e){r(s(i.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};e.reject=f(v),e.rejectSeries=c(v);var m=function(e,t,n,r){e(t,function(e,t){n(e,function(n){n?(r(e),r=function(){}):t()})},function(e){r()})};e.detect=f(m),e.detectSeries=c(m),e.some=function(t,n,r){e.each(t,function(e,t){n(e,function(e){e&&(r(!0),r=function(){}),t()})},function(e){r(!1)})},e.any=e.some,e.every=function(t,n,r){e.each(t,function(e,t){n(e,function(e){e||(r(!1),r=function(){}),t()})},function(e){r(!0)})},e.all=e.every,e.sortBy=function(t,n,r){e.map(t,function(e,t){n(e,function(n,r){n?t(n):t(null,{value:e,criteria:r})})},function(e,t){if(e)return r(e);var n=function(e,t){var n=e.criteria,r=t.criteria;return n<r?-1:n>r?1:0};r(null,s(t.sort(n),function(e){return e.value}))})},e.auto=function(t,n){n=n||function(){};var r=u(t);if(!r.length)return n(null);var s={},a=[],f=function(e){a.unshift(e)},l=function(e){for(var t=0;t<a.length;t+=1)if(a[t]===e){a.splice(t,1);return}},c=function(){i(a.slice(0),function(e){e()})};f(function(){u(s).length===r.length&&(n(null,s),n=function(){})}),i(r,function(r){var a=t[r]instanceof Function?[t[r]]:t[r],h=function(t){var o=Array.prototype.slice.call(arguments,1);o.length<=1&&(o=o[0]);if(t){var a={};i(u(s),function(e){a[e]=s[e]}),a[r]=o,n(t,a),n=function(){}}else s[r]=o,e.setImmediate(c)},p=a.slice(0,Math.abs(a.length-1))||[],d=function(){return o(p,function(e,t){return e&&s.hasOwnProperty(t)},!0)&&!s.hasOwnProperty(r)};if(d())a[a.length-1](h,s);else{var v=function(){d()&&(l(v),a[a.length-1](h,s))};f(v)}})},e.waterfall=function(t,n){n=n||function(){};if(t.constructor!==Array){var r=new Error("First argument to waterfall must be an array of functions");return n(r)}if(!t.length)return n();var i=function(t){return function(r){if(r)n.apply(null,arguments),n=function(){};else{var s=Array.prototype.slice.call(arguments,1),o=t.next();o?s.push(i(o)):s.push(n),e.setImmediate(function(){t.apply(null,s)})}}};i(e.iterator(t))()};var g=function(e,t,n){n=n||function(){};if(t.constructor===Array)e.map(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.each(u(t),function(e,n){t[e](function(t){var i=Array.prototype.slice.call(arguments,1);i.length<=1&&(i=i[0]),r[e]=i,n(t)})},function(e){n(e,r)})}};e.parallel=function(t,n){g({map:e.map,each:e.each},t,n)},e.parallelLimit=function(e,t,n){g({map:p(t),each:a(t)},e,n)},e.series=function(t,n){n=n||function(){};if(t.constructor===Array)e.mapSeries(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.eachSeries(u(t),function(e,n){t[e](function(t){var i=Array.prototype.slice.call(arguments,1);i.length<=1&&(i=i[0]),r[e]=i,n(t)})},function(e){n(e,r)})}},e.iterator=function(e){var t=function(n){var r=function(){return e.length&&e[n].apply(null,arguments),r.next()};return r.next=function(){return n<e.length-1?t(n+1):null},r};return t(0)},e.apply=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t.concat(Array.prototype.slice.call(arguments)))}};var y=function(e,t,n,r){var i=[];e(t,function(e,t){n(e,function(e,n){i=i.concat(n||[]),t(e)})},function(e){r(e,i)})};e.concat=f(y),e.concatSeries=c(y),e.whilst=function(t,n,r){t()?n(function(i){if(i)return r(i);e.whilst(t,n,r)}):r()},e.doWhilst=function(t,n,r){t(function(i){if(i)return r(i);n()?e.doWhilst(t,n,r):r()})},e.until=function(t,n,r){t()?r():n(function(i){if(i)return r(i);e.until(t,n,r)})},e.doUntil=function(t,n,r){t(function(i){if(i)return r(i);n()?r():e.doUntil(t,n,r)})},e.queue=function(t,n){function s(t,r,s,o){r.constructor!==Array&&(r=[r]),i(r,function(r){var i={data:r,callback:typeof o=="function"?o:null};s?t.tasks.unshift(i):t.tasks.push(i),t.saturated&&t.tasks.length===n&&t.saturated(),e.setImmediate(t.process)})}n===undefined&&(n=1);var o=0,u={tasks:[],concurrency:n,saturated:null,empty:null,drain:null,push:function(e,t){s(u,e,!1,t)},unshift:function(e,t){s(u,e,!0,t)},process:function(){if(o<u.concurrency&&u.tasks.length){var e=u.tasks.shift();u.empty&&u.tasks.length===0&&u.empty(),o+=1;var n=function(){o-=1,e.callback&&e.callback.apply(e,arguments),u.drain&&u.tasks.length+o===0&&u.drain(),u.process()},i=r(n);t(e.data,i)}},length:function(){return u.tasks.length},running:function(){return o}};return u},e.cargo=function(t,n){var r=!1,o=[],u={tasks:o,payload:n,saturated:null,empty:null,drain:null,push:function(t,r){t.constructor!==Array&&(t=[t]),i(t,function(e){o.push({data:e,callback:typeof r=="function"?r:null}),u.saturated&&o.length===n&&u.saturated()}),e.setImmediate(u.process)},process:function a(){if(r)return;if(o.length===0){u.drain&&u.drain();return}var e=typeof n=="number"?o.splice(0,n):o.splice(0),f=s(e,function(e){return e.data});u.empty&&u.empty(),r=!0,t(f,function(){r=!1;var t=arguments;i(e,function(e){e.callback&&e.callback.apply(null,t)}),a()})},length:function(){return o.length},running:function(){return r}};return u};var b=function(e){return function(t){var n=Array.prototype.slice.call(arguments,1);t.apply(null,n.concat([function(t){var n=Array.prototype.slice.call(arguments,1);typeof console!="undefined"&&(t?console.error&&console.error(t):console[e]&&i(n,function(t){console[e](t)}))}]))}};e.log=b("log"),e.dir=b("dir"),e.memoize=function(e,t){var n={},r={};t=t||function(e){return e};var i=function(){var i=Array.prototype.slice.call(arguments),s=i.pop(),o=t.apply(null,i);o in n?s.apply(null,n[o]):o in r?r[o].push(s):(r[o]=[s],e.apply(null,i.concat([function(){n[o]=arguments;var e=r[o];delete r[o];for(var t=0,i=e.length;t<i;t++)e[t].apply(null,arguments)}])))};return i.memo=n,i.unmemoized=e,i},e.unmemoize=function(e){return function(){return(e.unmemoized||e).apply(null,arguments)}},e.times=function(t,n,r){var i=[];for(var s=0;s<t;s++)i.push(s);return e.map(i,n,r)},e.timesSeries=function(t,n,r){var i=[];for(var s=0;s<t;s++)i.push(s);return e.mapSeries(i,n,r)},e.compose=function(){var t=Array.prototype.reverse.call(arguments);return function(){var n=this,r=Array.prototype.slice.call(arguments),i=r.pop();e.reduce(t,r,function(e,t,r){t.apply(n,e.concat([function(){var e=arguments[0],t=Array.prototype.slice.call(arguments,1);r(e,t)}]))},function(e,t){i.apply(n,[e].concat(t))})}};var w=function(e,t){var n=function(){var n=this,r=Array.prototype.slice.call(arguments),i=r.pop();return e(t,function(e,t){e.apply(n,r.concat([t]))},i)};if(arguments.length>2){var r=Array.prototype.slice.call(arguments,2);return n.apply(this,r)}return n};e.applyEach=f(w),e.applyEachSeries=c(w),e.forever=function(e,t){function n(r){if(r){if(t)return t(r);throw r}e(n)}n()},typeof define!="undefined"&&define.amd?define("lib/async",[],function(){return e}):typeof module!="undefined"&&module.exports?module.exports=e:t.async=e})(),define("constance",[],function(){return{MAIN_OS_NAME:"by-sequence",PENDING_SCAN_OS_NAME:"pending_scan",DOCUMENT_TYPE_INDEX:"document_type_index",PRODUCT_NAME_INDEX_NAME:"product_name_index",PRODUCT_ID_INDEX_NAME:"product_id_index",SKU_INDEX_NAME:"sku_index",DOCUMENT_ID_INDEX_NAME:"document_id_index",STORE_PRODUCT_TYPE:"prod_bus_assoc",RECEIPT_TYPE:"receipt",STATIC_URL:"/static/",TAX_DOCUMENT_ID:"tax_document",TEST_STORE_ID:0}}),define("app/store_product/Store_product",["constance"],function(e){function t(t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){t!=null&&n!=null&&(this._id=t,this._rev=n),this.key=r,this.store_id=i,this.product_id=s,this.name=o,this.price=u==null?null:Number(u),this.crv=a==null?null:Number(a),this.is_taxable=f,this.is_sale_report=l,this.p_type=c,this.p_tag=h,this.sku_lst=p,this.d_type=e.STORE_PRODUCT_TYPE,this.cost=d==null?null:Number(d),this.vendor=v,this.buydown=m==null?null:Number(m)}return t}),define("lib/db/db_util",[],function(){function e(e){return"_pouch_"+e}function t(e){return"liquor_"+e}function n(n,r){var i=e(t(n)),s=indexedDB.open(i);s.onupgradeneeded=function(e){e.target.transaction.abort(),r(null,null)},s.onsuccess=function(e){r(null,s.result)},s.onerror=function(e){e.target.error.name=="AbortError"?indexedDB.deleteDatabase(i):alert("there is error")}}return{get_store_db_name:t,is_store_idb_exist:n,pouch_db_name_to_index_db_name:e}}),define("lib/db/couch_db_util",["lib/db/db_util"],function(e){function t(t,n){return t+"/"+e.get_store_db_name(n)}function n(e){return parseInt(e._rev.split("-")[0])}function r(e,t){return t._id==e._id?n(t)-n(e):t._id>e._id?1:-1}function i(e){function t(e){var t=!0;for(var n=0;n<e.length;n++){var r=e[n];if(!r._id||!r._rev){t=!1;break}}return t}if(!t(e))return alert("list contain invalid document"),null;ret_doc_lst=[],e.sort(r);var n=null;for(var i=0;i<e.length;i++){var s=e[i];if(n!=null&&s._id==n._id)continue;ret_doc_lst.push(s),n=s}return ret_doc_lst}return{filter_old_rev:i,get_db_url:t}}),define("lib/object_store/get_os",["constance"],function(e){function t(t,n){return r(e.PENDING_SCAN_OS_NAME,t,n)}function n(t,n){return r(e.MAIN_OS_NAME,t,n)}function r(e,t,n){var r=t?"readonly":"readwrite";return n.transaction(e,r).objectStore(e)}return{get_main_os:n,get_pending_scan_os:t}}),define("app/store_product/store_product_getter",["app/store_product/Store_product","lib/db/couch_db_util","lib/object_store/get_os","lib/async","constance"],function(e,t,n,r,i){function s(t){var n=new e(t.value._id,t.value._rev,t.primaryKey,t.value.store_id,t.value.product_id,t.value.name,t.value.price,t.value.crv,t.value.is_taxable,t.value.is_sale_report,t.value.p_type,t.value.p_tag,t.value.sku_lst,t.value.cost,t.value.vendor,t.value.buydown);return n}function o(e,r,i,o,u){var a=n.get_main_os(!0,o),f=a.index(e),l=new Array;f.openCursor(IDBKeyRange.only(r)).onsuccess=function(e){var n=e.target.result;if(n)l.push(s(n)),n.continue();else{var r=t.filter_old_rev(l);if(i){var o=r.length;o==1?u(null,r[0]):o==0?u(null,null):u("Bug: multiple result is found",null)}else u(null,r)}}}function u(e,t,n){o(i.PRODUCT_ID_INDEX_NAME,e,!0,t,n)}function a(e,t,n){o(i.SKU_INDEX_NAME,e,!1,t,n)}function f(e,n,r){var i=new Array;e.openCursor(IDBKeyRange.only(n)).onsuccess=function(e){var n=e.target.result;if(n)i.push(s(n)),n.continue();else{var o=t.filter_old_rev(i);o.length==1?r(null,o[0]):r("Bug: expect one result",null)}}}function l(e,t,s){var o=n.get_main_os(!0,t),u=o.index(i.DOCUMENT_ID_INDEX_NAME),a=new Array;for(var l=0;l<e.length;l++){var c=f.bind(f,u,e[l]);a.push(c)}r.series(a,function(e,t){s(e,t)})}function c(e,r){var o=n.get_main_os(!0,e),u=o.index(i.DOCUMENT_TYPE_INDEX),a=new Array;u.openCursor(IDBKeyRange.only(i.STORE_PRODUCT_TYPE)).onsuccess=function(e){var n=e.target.result;if(n)n.value.product_id==null&&a.push(s(n)),n.continue();else{var i=t.filter_old_rev(a);r(null,a)}}}function h(e,r){var o=n.get_main_os(!0,e),u=o.index(i.DOCUMENT_TYPE_INDEX),a=new Array;u.openCursor(IDBKeyRange.only(i.STORE_PRODUCT_TYPE)).onsuccess=function(e){var n=e.target.result;if(n)n.value.product_id!=null&&a.push(s(n)),n.continue();else{var i=t.filter_old_rev(a);r(null,a)}}}return{search_by_sku:a,search_by_doc_id:f,search_by_doc_id_lst:l,by_product_id:u,by_product_id_not_null:h,by_product_id_is_null:c,_create_store_product_from_cursor:s}}),define("app/sale/pending_scan/Pending_scan",[],function(){return function(t,n,r,i,s,o){this.key=t,this.qty=n,this.price=r,this.discount=i,this.sp_doc_id=s,this.non_product_name=o}}),define("app/sale/pending_scan/pending_scan_lst_getter",["app/sale/pending_scan/Pending_scan","lib/object_store/get_os"],function(e,t){return function(n,r){var i=new Array,s=t.get_pending_scan_os(!0,n);s.openCursor().onsuccess=function(t){var n=t.target.result;n?(i.push(new e(n.key,n.value.qty,n.value.price,n.value.discount,n.value.sp_doc_id,n.value.non_product_name)),n.continue()):r(null,i)}}}),define("app/sale/pending_scan/pending_scan_inserter",["lib/async","lib/object_store/get_os","app/sale/pending_scan/pending_scan_lst_getter","app/sale/pending_scan/Pending_scan"],function(e,t,n,r){function i(e,n,r){var i=t.get_pending_scan_os(!1,e),s;n.key!==null?s=i.put(n,n.key):s=i.put(n),s.onsuccess=function(e){r(null)},s.onerror=function(e){var t="error with code: "+evt.target.errorCode;r(t)}}function s(e,t){return e.sp_doc_id==null&&t.sp_doc_id==null?e.non_product_name===t.non_product_name:e.sp_doc_id!=null&&t.sp_doc_id!=null?e.sp_doc_id===t.sp_doc_id:!1}function o(e,t,n){var r=null,i=t.length;i>0&&(r=t[i-1]);var o;if(r===null)o=!0;else{var u=s(r,e),a=r.price===e.price,f=r.discount==undefined||r.discount==null||r.discount==0,l=e.qty*r.qty>0,c=u&&a&&f&&l;o=!c}var h;o?h=e:(h=r,h.qty+=e.qty),n(null,h)}return function(t,r,s){var u=n.bind(n,t),a=o,f=a.bind(a,r),l=i,c=l.bind(l,t);e.waterfall([u,f,c],function(e,t){s(e)})}}),define("app/sale/scan/scanner",["require","app/store_product/store_product_getter","app/sale/pending_scan/pending_scan_inserter","lib/async","app/sale/pending_scan/Pending_scan"],function(e){function u(e){var t=e.trim().split(" "),n=t.length;if(n==0)return null;if(n==1)return t[0];if(n==2){var r=t[0];return isNaN(r)?(alert("first token must be a number"),null):t[1]}return alert("scan can not be more than 2 tokens"),null}function a(e){var t=e.trim().split(" "),n=t.length;if(n==0)return null;if(n==1)return 1;if(n==2){var r=t[0];return isNaN(r)?(alert("first token must be a number"),null):Number(r)}return alert("scan can not be more than 2 tokens"),null}function f(e,t){var n=e.length,r=null;if(n===0)t("Error: unexpected empty list",null);else if(n===1)r=e[0],t(null,r);else{var i="";for(var s=0;s<n;s++)i+="select "+(s+1)+" for: "+e[s].name+"\n";var u=prompt(i);u==null?t(o,null):u>n?t("wrong selection. scan again",null):(r=e[u-1],t(null,r))}}function l(e,t,n){var r=new i(null,e,t.price,null,t._id,null);n(null,r)}function c(e,i,o){var c=a(e),h=u(e);if(c==null||h==null){var p="invalid scan string";o(p,null)}var d=null,v=t.search_by_sku.bind(t.search_by_sku,h,i);r.waterfall([v],function(e,t){if(e){o(e);return}if(t==null||t==undefined){o("Error: cant search for product");return}if(t.length==0){o(s);return}var u=f.bind(f,t),a=l.bind(l,c),h=n.bind(n,i);r.waterfall([u,a,h],function(e,t){o(e)})})}var t=e("app/store_product/store_product_getter"),n=e("app/sale/pending_scan/pending_scan_inserter"),r=e("lib/async"),i=e("app/sale/pending_scan/Pending_scan"),s="ERROR_STORE_PRODUCT_NOT_FOUND",o="ERROR_CANCEL_SHARE_SKU_BREAKER";return{exe:c,get_sku_from_scan_str:u,get_qty_from_scan_str:a,ERROR_STORE_PRODUCT_NOT_FOUND:s,ERROR_CANCEL_SHARE_SKU_BREAKER:o}}),define("app/sale/pending_scan/pending_scan_util",["lib/object_store/get_os"],function(e){function t(e,t){var n=!1;for(var r=0;r<t.length;r++)if(t[r]===e){n=!0;break}return n}function n(e){var n=new Array;for(var r=0;r<e.length;r++){var i=e[r].sp_doc_id;i!=null&&!t(i,n)&&n.push(i)}return n}function r(t,n,r,i){var s=e.get_pending_scan_os(!1,t),o=s.put(n,r);o.onsuccess=function(e){i(null)},o.onerror=function(e){var t="error with code: "+e.target.errorCode;i(t)}}function i(t,n,r){var i=e.get_pending_scan_os(!1,t),s=i.delete(n);s.onsuccess=function(e){r(null)},s.onerror=function(e){var t="error with code: "+e.target.errorCode;r(t)}}return{get_distinct_doc_id_lst:n,delete_ps:i,update_ps:r}}),define("app/sale/pending_scan/pending_scan_lst_compressor",["lib/async","app/sale/pending_scan/pending_scan_lst_getter","app/sale/pending_scan/pending_scan_util"],function(e,t,n){function r(e,t){var n=!1,r=e.sp_doc_id===t.sp_doc_id,i=e.price===t.price,s=e.discount===t.discount;return r&&i&&s}return function(i,s,o){var u=t.bind(t,s);e.waterfall([u],function(t,u){var a=u,f=a[i],l=a[i+1];if(r(f,l)){f.qty+=l.qty;var c=n.update_ps.bind(n.update_ps,s,f,f.key),h=n.delete_ps.bind(n.delete_ps,s,l.key);e.series([c,h],function(e,t){o(e)})}else o(t)})}}),define("app/store_product/store_product_util",[],function(){function e(e,t){var n=null;for(var r=0;r<t.length;r++)if(t[r]._id===e){n=t[r];break}return n}function t(e,t){var n=null;for(var r=0;r<t.length;r++)if(t[r].product_id===e){n=t[r];break}return n}function n(e){var t="";for(var n=0;n<e.length;n++)t+=","+e[n].product_id;return t.substr(1)}return{get_item_based_on_product_id:t,get_item_based_on_doc_id:e,get_comma_separated_pid_lst:n}}),define("lib/number/number",[],function(){function e(e){return+e.toFixed(5)}function t(e){return+e.toFixed(2)}function n(e,t,n){var i=prompt(e,t);return r(i)?parseInt(i):null}function r(e){return parseInt(e)%1==0}function i(e,t,n){var r=prompt(e,t);return r==null?null:u(r)?parseInt(r):(n&&alert(n),null)}function s(e,t,n){var r=prompt(e,t);if(r==null)return null;if(o(r))return parseFloat(r);if(n)return alert(n),null}function o(e){if(e==null)return!1;if(isNaN(e))return!1;var t=parseFloat(e);return t>=0?!0:!1}function u(e){var t=/^\d+$/;return t.test(e)}return{prompt_positive_integer:i,is_positive_integer:u,prompt_positive_double:s,is_positive_double:o,round_2_decimal:t,trim:e,prompt_integer:n}}),define("app/sale/displaying_scan/Displaying_scan",["lib/number/number"],function(e){function t(e,t,n,r,i){this.qty=e,this.store_product=t,this.price=n,this.discount=r,this.non_product_name=i,this.mix_match_deal=null}return t.prototype={constructor:t,get_name:function(){return this.store_product==null?this.non_product_name:this.store_product.name},get_buydown:function(){var e=0;return this.store_product!=null&&(e=this.store_product.buydown==null?0:this.store_product.buydown),e},get_total_discount:function(){var e=0;return this.discount&&(e+=this.discount),this.mix_match_deal&&(e+=this.mix_match_deal.unit_discount),e+=this.get_buydown(),e},get_total_discount_price:function(){return this.price-this.get_total_discount()},get_crv:function(){return this.store_product?this.store_product.crv?this.store_product.crv:0:0},get_otd_wot_price:function(){return this.get_total_discount_price()+this.get_crv()},get_buydown_tax:function(t){var n=this.get_buydown()*t/100;return e.round_2_decimal(n)},get_tax:function(t){if(this.store_product==null||this.store_product.is_taxable==0)return 0;var n=this.get_otd_wot_price()*t/100;return e.round_2_decimal(n)},get_otd_wt_price:function(e){return this.get_otd_wot_price()+this.get_tax(e)+this.get_buydown_tax(e)},get_line_total:function(e){return this.get_otd_wt_price(e)*this.qty}},t}),define("app/sale/displaying_scan/displaying_scan_computer",["lib/async","app/sale/pending_scan/pending_scan_util","app/store_product/store_product_getter","app/store_product/store_product_util","app/sale/displaying_scan/Displaying_scan"],function(e,t,n,r,i){function s(e,t){var n=!1;for(var r=0;r<e.mix_match_child_set.length;r++)if(e.mix_match_child_set[r].store_product.product_id==t){n=!0;break}return n}function o(e,t){var n=[];for(var r=0;r<t.length;r++)s(t[r],e)&&n.push(t[r]);return n}function u(e,t){var n=!1;for(var r=0;r<t.length;r++)if(t[r].id==e.id){n=!0;break}return n}function a(e,t){for(var n=0;n<e.length;n++)u(e[n],t)||t.push(e[n]);return t}function f(e,t){var n=[];for(var r=0;r<e.length;r++){var i=o(e[r].product_id,t);a(i,n)}return n}function l(e,t){var n=[];for(var s=0;s<e.length;s++){var o=e[s],u=r.get_item_based_on_doc_id(o.sp_doc_id,t);for(j=0;j<o.qty;j++){var a=new i(1,u,o.price,o.discount,o.non_product_name);n.push(a)}}return n}function c(e,t){var n=0;for(var r=0;r<e.length;r++){var i=e[r],o=i.store_product==null?null:i.store_product.product_id;o!=null&&i.mix_match_deal==null&&s(t,o)&&(n+=1)}var u=Math.floor(n/t.qty),a=u*t.qty;if(a==0)return;for(var r=0;r<e.length&&a>0;r++){var i=e[r],o=i.store_product==null?null:i.store_product.product_id;o!=null&&i.mix_match_deal==null&&s(t,o)&&(i.mix_match_deal=t,a-=1)}}function h(e){var t=[];for(var n=0;n<e.length;n++){if(n==0){t.push(e[0]);continue}var r=t[t.length-1],i=e[n];if(r.store_product==null||i.store_product==null){t.push(i);continue}r.store_product.product_id===i.store_product.product_id&&r.price===i.price&&r.discount===i.discount&&r.mix_match_deal===i.mix_match_deal?r.qty+=1:t.push(i)}return t}function p(e,t,n,r){var i=f(n,e),s=l(t,n);for(var o=0;o<i.length;o++)c(s,i[o]);var u=h(s);r(null,u)}function d(r,i,s){if(i.length!=0){var o=t.get_distinct_doc_id_lst(i),u=n.search_by_doc_id_lst,a=u.bind(u,o,r);e.series([a],function(e,t){s(e,t[0])})}else s(null,new Array)}return function(t,n,r,i){var s=d.bind(d,n,r),o=p.bind(p,t,r);e.waterfall([s,o],function(e,t){i(e,t)})}}),define("app/sale/displaying_scan_modifier/displaying_scan_modifier",["app/sale/pending_scan/pending_scan_lst_getter","lib/async","lib/object_store/get_os","app/sale/pending_scan/pending_scan_lst_compressor","app/sale/pending_scan/pending_scan_util","app/sale/displaying_scan/displaying_scan_computer"],function(e,t,n,r,i,s){function u(e,t,n){return f(e,t-n)+1}function a(e,t,n){return f(e,t)}function f(e,t){var n,r=0;if(t==0)return-1;for(var i=0;i<e.length;i++){r+=Math.abs(e[i].qty);if(r<t)continue;if(r==t){n=i;break}break}return n}function l(e,t){var n=t.length;if(n==0)return!1;var r=!0;for(var i=0;i<t.length;i++)if(e.sp_doc_id==null){if(t[i].store_product!=null){r=!1;break}}else if(e.sp_doc_id!==t[i].store_product._id){r=!1;break}return r}function c(e,t,n){var r=new Array,i=0,s=null;for(var o=0;o<t.length;o++){var f=t[o],c=Math.abs(f.qty);i+=c;var h=u(e,i,c),p=a(e,i,c);if(h>p){s="begin index > end index";break}var d=null;if(h!=null&&p!=null){d=new Array;for(var v=h;v<=p;v++)d.push(e[v])}var m=!1;d&&(m=l(f,d));if(!m){s="associate ds list is invalid";break}r.push({key:f,value:d})}s!=null?n("can not match with internal data: "+s):n(null,r)}function h(e,t,n,r){n.is_delete?e.delete(t.key).onsuccess=function(e){r(null)}:(t.price=n.price,t.qty=n.qty,e.put(t).onsuccess=function(e){r(null)})}function p(e,t){if(t.is_delete)return null;var n=t.new_qty-e.qty;return e.qty+=n,e.price=t.new_price,e.discount=t.new_discount,e}function d(e,n,s,o,u){var a=n,f=o[a].key,l=f.key,c=p(f,s);if(c!=null){var h=i.update_ps.bind(i.update_ps,e,f,l);t.waterfall([h],function(n,i){if(n)u(n);else{var s=new Array,f=a!=o.length-1;if(f){var l=a,c=r.bind(r,l,e);s.push(c)}var h=a!=0;if(h){var l=a-1,p=r.bind(r,l,e);s.push(p)}s.length!=0?t.waterfall(s,function(e,t){u(e)}):u(n)}})}else{var d=a!=0&&a!=o.length-1,v=i.delete_ps.bind(i.delete_ps,e,l);t.waterfall([v],function(n,i){if(n)u(n);else if(d){var s=a-1,o=r.bind(o,s,e);t.waterfall([o],function(e,t){u(e)})}else u(null)})}}var o=null;return function(n,r,i,u,a){o=n;var f=e.bind(e,r);t.waterfall([f],function(e,n){e!=null&&a(e);var f=n,l=s.bind(s,o,r,f);t.waterfall([l],function(e,n){e!=null&&a(e);var s=n,o=c.bind(c,s,f),l=d.bind(d,r,i,u);t.waterfall([o,l],function(e,t){a(e)})})})}}),define("app/sale/displaying_scan_modifier/Instruction",[],function(){return function(t,n,r,i){this.is_delete=t,this.new_qty=n,this.new_price=r,this.new_discount=i}}),define("app/sale/displaying_scan/displaying_scan_lst_getter",["lib/async","app/sale/pending_scan/pending_scan_lst_getter","app/sale/displaying_scan/displaying_scan_computer"],function(e,t,n){return function(r,i,s){var o=t.bind(t,i),u=n.bind(n,r,i);e.waterfall([o,u],function(e,t){s(e,t)})}}),define("app/sale/displaying_scan/displaying_scan_util",[],function(){function e(e,t){var n=0;for(var r=0;r<e.length;r++)n+=e[r].get_line_total(t);return n}return{get_line_total:e}}),define("app/store_product/store_product_validator",["lib/number/number"],function(e){function a(a,f,l,c,h,p,d,v,m){var g=new Array;return(a==null||a==undefined||a.trim().length==0)&&g.push(t),(f==null||f==undefined||!e.is_positive_double(f))&&g.push(n),l!=null&&l!=undefined&&typeof l=="string"&&l.trim().length!=0&&!e.is_positive_double(l)&&g.push(r),(c==null||c==undefined||typeof c!="boolean")&&g.push(i),p&&(h==null||h==undefined||h.trim().length==0)&&g.push(s),d!=null&&d!=undefined&&typeof d=="string"&&d.trim().length!=0&&!e.is_positive_double(d)&&g.push(o),m!=null&&m!=undefined&&typeof m=="string"&&m.trim().length!=0&&!e.is_positive_double(m)&&g.push(u),g}var t="ERROR_STORE_PRODUCT_VALIDATION_NAME",n="ERROR_STORE_PRODUCT_VALIDATION_PRICE",r="ERROR_STORE_PRODUCT_VALIDATION_CRV",i="ERROR_STORE_PRODUCT_VALIDATION_TAXABLE",s="ERROR_STORE_PRODUCT_VALIDATION_SKU",o="ERROR_STORE_PRODUCT_VALIDATION_COST",u="ERROR_STORE_PRODUCT_VALIDATION_BUYDOWN";return{validate:a,ERROR_STORE_PRODUCT_VALIDATION_NAME:t,ERROR_STORE_PRODUCT_VALIDATION_PRICE:n,ERROR_STORE_PRODUCT_VALIDATION_CRV:r,ERROR_STORE_PRODUCT_VALIDATION_TAXABLE:i,ERROR_STORE_PRODUCT_VALIDATION_SKU:s,ERROR_STORE_PRODUCT_VALIDATION_COST:o,ERROR_STORE_PRODUCT_VALIDATION_BUYDOWN:u}}),define("app/store_product/sp_prompt",["app/store_product/store_product_validator"],function(e){function r(e){$("#store_product_prompt_dialog").dialog("close"),e(t)}function i(e){$("#store_product_prompt_dialog").dialog("close"),e(n,null)}function s(t,n){var r={name:$("#product_name_txt").val(),price:$("#product_price_txt").val(),is_taxable:$("#product_taxable_check").is(":checked"),is_sale_report:$("#product_sale_report_check").is(":checked"),p_type:$("#product_type_txt").val(),p_tag:$("#product_tag_txt").val(),crv:$("#product_crv_txt").val(),sku_str:$("#product_sku_txt").val(),cost:$("#product_cost_txt").val(),vendor:$("#product_vendor_txt").val(),buydown:$("#product_buydown_txt").val()},i=e.validate(r.name,r.price,r.crv,r.is_taxable,r.sku_str,t,r.cost,r.vendor,r.buydown);if(i.length!=0){o(i);return}$("#store_product_prompt_dialog").dialog("close"),n(null,r)}function o(t){$("#product_name_txt").removeClass("error"),$("#product_price_txt").removeClass("error"),$("#product_crv_txt").removeClass("error"),$("#product_sku_txt").removeClass("error"),$("#product_cost_txt").removeClass("error"),$("#product_buydown_txt").removeClass("error"),t.indexOf(e.ERROR_STORE_PRODUCT_VALIDATION_NAME)!=-1&&$("#product_name_txt").addClass("error"),t.indexOf(e.ERROR_STORE_PRODUCT_VALIDATION_PRICE)!=-1&&$("#product_price_txt").addClass("error"),t.indexOf(e.ERROR_STORE_PRODUCT_VALIDATION_CRV)!=-1&&$("#product_crv_txt").addClass("error"),t.indexOf(e.ERROR_STORE_PRODUCT_VALIDATION_SKU)!=-1&&$("#product_sku_txt").addClass("error"),t.indexOf(e.ERROR_STORE_PRODUCT_VALIDATION_COST)!=-1&&$("#product_cost_txt").addClass("error"),t.indexOf(e.ERROR_STORE_PRODUCT_VALIDATION_BUYDOWN)!=-1&&$("#product_buydown_txt").addClass("error")}function u(e,t,n,r,i,s,o,u,a,f){$("#product_name_txt").val(e),$("#product_price_txt").val(t),$("#product_crv_txt").val(n),$("#product_taxable_check").prop("checked",r),$("#product_sale_report_check").prop("checked",i),$("#product_type_txt").val(s),$("#product_tag_txt").val(o),$("#product_cost_txt").val(u),$("#product_vendor_txt").val(a),$("#product_buydown_txt").val(f)}function a(e,t,n,r,i,s,a,f,l,c,h,p,d){p?$("#sku_management_btn").show():$("#sku_management_btn").hide(),u(e,t,n,r,i,s,a,c,h,d),o([]),l?($("#product_sku_txt").show(),$('label[for="product_sku_txt"]').show(),$("#product_sku_txt").val(f),$("#product_sku_txt").attr("readonly",f!=null)):($("#product_sku_txt").hide(),$('label[for="product_sku_txt"]').hide())}function f(e,t,n,o,u,f,l,c,h,p,d,v,m,g,y,b){var w=s.bind(s,h,b),E=r.bind(r,b),S=y==null?"create new product":"create product "+y.name;$("#store_product_prompt_dialog").dialog({title:S,buttons:[{text:"Ok",click:w},{text:"Cancel",click:E}],modal:!0,width:600,heigh:400}),$("#store_product_prompt_dialog").keypress(function(e){e.keyCode==$.ui.keyCode.ENTER&&s(h,b)});var x=i.bind(i,b);$("#sku_management_btn").off("click").click(x),a(e,t,n,o,u,f,l,c,h,p,d,g,v);if(m){var T=Object.keys(m);$("#product_type_txt").on("autocompletechange",function(){var e=m[$(this).val()];e==undefined&&(e=[]),$("#product_tag_txt").autocomplete({source:e,minLength:0}).bind("focus",function(){$(this).autocomplete("search")})}),$("#product_type_txt").autocomplete({source:T,minLength:0}).bind("focus",function(){$(this).autocomplete("search")})}$("#store_product_prompt_dialog").dialog("open")}var t="ERROR_CANCEL_STORE_PRODUCT_PROMPT",n="MANAGE_SKU_BUTTON_PRESS";return{ERROR_CANCEL_STORE_PRODUCT_PROMPT:t,MANAGE_SKU_BUTTON_PRESS:n,show_prompt:f}}),define("app/store_product/sp_online_getter",[],function(){return function(e,t,n,r){$.ajax({url:"/product/search_by_pid",type:"GET",dataType:"json",data:{product_id:e,is_include_other_store:t,is_include_lookup_type_tag:n},success:function(e,t,n){r(null,e)},error:function(e,t,n){r(e)}})}}),!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define("lib/db/pouchdb",e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.PouchDB=e()}}(function(){var define,module,exports;return function e(t,n,r){function i(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(s)return s(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return i(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var s=typeof require=="function"&&require;for(var o=0;o<r.length;o++)i(r[o]);return i}({1:[function(_dereq_,module,exports){function arrayFirst(e,t){for(var n=0;n<e.length;n++)if(t(e[n],n)===!0)return e[n];return!1}function yankError(e){return function(t,n){t||n[0].error?e(t||n[0]):e(null,n[0])}}function computeHeight(e){var t={},n=[];return merge.traverseRevTree(e,function(e,r,i,s){var o=r+"-"+i;return e&&(t[o]=0),s!==undefined&&n.push({from:s,to:o}),o}),n.reverse(),n.forEach(function(e){t[e.from]===undefined?t[e.from]=1+t[e.to]:t[e.from]=Math.min(t[e.from],1+t[e.to])}),t}function AbstractPouchDB(){var e=this;EventEmitter.call(this),e.autoCompact=function(t){return e.auto_compaction?function(n,r){if(n)t(n);else{var i=r.length,s=function(){i--,i||t(null,r)};r.forEach(function(t){t.ok?e.compactDocument(t.id,1,s):s()})}}:t};var t=0,n,r=["change","delete","create","update"];this.on("newListener",function(i){if(!~r.indexOf(i))return;if(t){t++;return}t++;var s=0;n=this.changes({conflicts:!0,include_docs:!0,continuous:!0,since:"latest",onChange:function(t){if(t.seq<=s)return;s=t.seq,e.emit("change",t),t.doc._deleted?e.emit("delete",t):t.doc._rev.split("-")[0]==="1"?e.emit("create",t):e.emit("update",t)}})}),this.on("removeListener",function(e){if(!~r.indexOf(e))return;t--;if(t)return;n.cancel()})}function adapterFun(e,t){return utils.toPromise(function(){if(!this.taskqueue.isReady){this.taskqueue.addTask(e,arguments);return}t.apply(this,arguments)})}function processChange(e,t,n){var r=[{rev:e._rev}];n.style==="all_docs"&&(r=merge.collectLeaves(t.rev_tree).map(function(e){return{rev:e.rev}}));var i={id:t.id,changes:r,doc:e};return utils.isDeleted(t,e._rev)&&(i.deleted=!0),n.conflicts&&(i.doc._conflicts=merge.collectConflicts(t),i.doc._conflicts.length||delete i.doc._conflicts),i}function doChanges(api,opts,promise,callback){opts=utils.extend(!0,{},opts),"live"in opts&&!("continuous"in opts)&&(opts.continuous=opts.live),opts.processChange=processChange,opts.since||(opts.since=0);if(opts.since==="latest"){api.info(function(e,t){if(promise.isCancelled){callback(null,{status:"cancelled"});return}if(e){callback(e);return}opts.since=t.update_seq-1,doChanges(api,opts,promise,callback)});return}if(api.type()!=="http"&&opts.filter&&typeof opts.filter=="string"){if(opts.filter==="_view"){if(!opts.view||typeof opts.view!="string"){var err=errors.error(errors.BAD_REQUEST,"`view` filter parameter is not provided.");callback(err);return}var viewName=opts.view.split("/");api.get("_design/"+viewName[0],function(err,ddoc){if(promise.isCancelled){callback(null,{status:"cancelled"});return}if(err){callback(err);return}if(ddoc&&ddoc.views&&ddoc.views[viewName[1]]){var filter=eval("(function () {  return function (doc) {    var emitted = false;    var emit = function (a, b) {      emitted = true;    };    var view = "+ddoc.views[viewName[1]].map+";"+"    view(doc);"+"    if (emitted) {"+"      return true;"+"    }"+"  }"+"})()");opts.filter=filter,doChanges(api,opts,promise,callback);return}var msg=ddoc.views?"missing json key: "+viewName[1]:"missing json key: views";err=err||errors.error(errors.MISSING_DOC,msg),callback(err);return})}else{var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){if(promise.isCancelled){callback(null,{status:"cancelled"});return}if(err){callback(err);return}if(ddoc&&ddoc.filters&&ddoc.filters[filterName[1]]){var filter=eval("(function () { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter,doChanges(api,opts,promise,callback);return}var msg=ddoc&&ddoc.filters?"missing json key: "+filterName[1]:"missing json key: filters";err=err||errors.error(errors.MISSING_DOC,msg),callback(err);return})}return}"descending"in opts||(opts.descending=!1),opts.limit=opts.limit===0?1:opts.limit,opts.complete=callback;var newPromise=api._changes(opts);if(newPromise&&typeof newPromise.cancel=="function"){var cancel=promise.cancel;promise.cancel=function(){newPromise.cancel(),cancel.apply(this,arguments)}}}var utils=_dereq_("./utils"),merge=_dereq_("./merge"),errors=_dereq_("./deps/errors"),EventEmitter=_dereq_("events").EventEmitter;utils.inherits(AbstractPouchDB,EventEmitter),module.exports=AbstractPouchDB,AbstractPouchDB.prototype.post=adapterFun("post",function(e,t,n){return typeof t=="function"&&(n=t,t={}),typeof e!="object"||Array.isArray(e)?n(errors.NOT_AN_OBJECT):this.bulkDocs({docs:[e]},t,this.autoCompact(yankError(n)))}),AbstractPouchDB.prototype.put=adapterFun("put",function(){var e=Array.prototype.slice.call(arguments),t,n,r,i,s=e.shift(),o="_id"in s;if(typeof s!="object"||Array.isArray(s))return i=e.pop(),i(errors.NOT_AN_OBJECT);s=utils.extend(!0,{},s);for(;;){t=e.shift(),n=typeof t,n==="string"&&!o?(s._id=t,o=!0):n!=="string"||!o||"_rev"in s?n==="object"?r=t:n==="function"&&(i=t):s._rev=t;if(!e.length)break}r=r||{};var u=utils.invalidIdError(s._id);return u?i(u):this.bulkDocs({docs:[s]},r,this.autoCompact(yankError(i)))}),AbstractPouchDB.prototype.putAttachment=adapterFun("putAttachment",function(e,t,n,r,i,s){function u(e){e._attachments=e._attachments||{},e._attachments[t]={content_type:i,data:r},o.put(e,s)}var o=this;typeof i=="function"&&(s=i,i=r,r=n,n=null),typeof i=="undefined"&&(i=r,r=n,n=null),o.get(e,function(t,r){if(t&&t.error===errors.MISSING_DOC.error){u({_id:e});return}if(t){s(t);return}if(r._rev!==n){s(errors.REV_CONFLICT);return}u(r)})}),AbstractPouchDB.prototype.removeAttachment=adapterFun("removeAttachment",function(e,t,n,r){var i=this;i.get(e,function(e,s){if(e){r(e);return}if(s._rev!==n){r(errors.REV_CONFLICT);return}if(!s._attachments)return r();delete s._attachments[t],Object.keys(s._attachments).length===0&&delete s._attachments,i.put(s,r)})}),AbstractPouchDB.prototype.remove=adapterFun("remove",function(e,t,n){typeof t=="function"&&(n=t,t={}),t===undefined&&(t={}),t=utils.extend(!0,{},t),t.was_delete=!0;var r={_id:e._id,_rev:e._rev};return r._deleted=!0,this.bulkDocs({docs:[r]},t,yankError(n))}),AbstractPouchDB.prototype.revsDiff=adapterFun("revsDiff",function(e,t,n){function o(e,t){s[e]||(s[e]={missing:[]}),s[e].missing.push(t)}function u(t,n){var r=e[t].slice(0);merge.traverseRevTree(n,function(e,n,i,s,u){var a=n+"-"+i,f=r.indexOf(a);if(f===-1)return;r.splice(f,1),u.status!=="available"&&o(t,a)}),r.forEach(function(e){o(t,e)})}typeof t=="function"&&(n=t,t={}),t=utils.extend(!0,{},t);var r=Object.keys(e),i=0,s={};r.map(function(t){this._getRevisionTree(t,function(o,a){if(o&&o.name==="not_found"&&o.message==="missing")s[t]={missing:e[t]};else{if(o)return n(o);u(t,a)}if(++i===r.length)return n(null,s)})},this)}),AbstractPouchDB.prototype.compactDocument=function(e,t,n){var r=this;this._getRevisionTree(e,function(i,s){if(i)return n(i);var o=computeHeight(s),u=[],a=[];Object.keys(o).forEach(function(e){o[e]>t&&u.push(e)}),merge.traverseRevTree(s,function(e,t,n,r,i){var s=t+"-"+n;i.status==="available"&&u.indexOf(s)!==-1&&(i.status="missing",a.push(s))}),r._doCompaction(e,s,a,n)})},AbstractPouchDB.prototype.compact=adapterFun("compact",function(e,t){typeof e=="function"&&(t=e,e={});var n=this;this.changes({complete:function(e,r){if(e){t();return}var i=r.results.length;if(!i){t();return}r.results.forEach(function(e){n.compactDocument(e.id,0,function(){i--,i||t()})})}})}),AbstractPouchDB.prototype.get=adapterFun("get",function(e,t,n){function s(){var s=[],o=r.length;if(!o)return n(null,s);r.forEach(function(r){i.get(e,{rev:r,revs:t.revs,attachments:t.attachments},function(e,t){e?s.push({missing:r}):s.push({ok:t}),o--,o||n(null,s)})})}typeof t=="function"&&(n=t,t={});if(typeof e!="string")return n(errors.INVALID_ID);var r=[],i=this;if(t.open_revs){if(t.open_revs==="all")this._getRevisionTree(e,function(e,t){e&&(t=[]),r=merge.collectLeaves(t).map(function(e){return e.rev}),s()});else{if(!Array.isArray(t.open_revs))return n(errors.error(errors.UNKNOWN_ERROR,"function_clause"));r=t.open_revs;for(var o=0;o<r.length;o++){var u=r[o];if(typeof u!="string"||!/^\d+-/.test(u))return n(errors.error(errors.BAD_REQUEST,"Invalid rev format"))}s()}return}return this._get(e,t,function(e,r){t=utils.extend(!0,{},t);if(e)return n(e);var s=r.doc,o=r.metadata,u=r.ctx;if(t.conflicts){var a=merge.collectConflicts(o);a.length&&(s._conflicts=a)}if(t.revs||t.revs_info){var f=merge.rootToLeaf(o.rev_tree),l=arrayFirst(f,function(e){return e.ids.map(function(e){return e.id}).indexOf(s._rev.split("-")[1])!==-1});l.ids.splice(l.ids.map(function(e){return e.id}).indexOf(s._rev.split("-")[1])+1),l.ids.reverse(),t.revs&&(s._revisions={start:l.pos+l.ids.length-1,ids:l.ids.map(function(e){return e.id})});if(t.revs_info){var c=l.pos+l.ids.length;s._revs_info=l.ids.map(function(e){return c--,{rev:c+"-"+e.id,status:e.opts.status}})}}t.local_seq&&(s._local_seq=r.metadata.seq);if(t.attachments&&s._attachments){var h=s._attachments,p=Object.keys(h).length;if(p===0)return n(null,s);Object.keys(h).forEach(function(e){this._getAttachment(h[e],{encode:!0,ctx:u},function(t,r){s._attachments[e].data=r,--p||n(null,s)})},i)}else{if(s._attachments)for(var d in s._attachments)s._attachments.hasOwnProperty(d)&&(s._attachments[d].stub=!0);n(null,s)}})}),AbstractPouchDB.prototype.getAttachment=adapterFun("getAttachment",function(e,t,n,r){var i=this;n instanceof Function&&(r=n,n={}),n=utils.extend(!0,{},n),this._get(e,n,function(e,s){if(e)return r(e);if(!s.doc._attachments||!s.doc._attachments[t])return r(errors.MISSING_DOC);n.ctx=s.ctx,i._getAttachment(s.doc._attachments[t],n,r)})}),AbstractPouchDB.prototype.allDocs=adapterFun("allDocs",function(e,t){typeof e=="function"&&(t=e,e={}),e=utils.extend(!0,{},e);if("keys"in e){var n=["startkey","endkey","key"].filter(function(t){return t in e})[0];if(n){t(errors.error(errors.QUERY_PARSE_ERROR,"Query parameter `"+n+"` is not compatible with multi-get"));return}}return typeof e.skip=="undefined"&&(e.skip=0),this._allDocs(e,t)}),AbstractPouchDB.prototype.changes=function(e,t,n){typeof t=="function"&&(n=t,t=null);if(t)return doChanges(this,e,t,n),t;var r=utils.toPromise(function(e,t,n){typeof e=="function"&&(t=n,n=e,e={}),e?e=utils.extend(!0,{},e):e={};if(e.complete){var r=e.complete;t.then(function(e){r(null,e)},r)}delete e.complete;var i=t.cancel;t.cancel=function(e){typeof i=="function"&&i.apply(this),n(null,{status:"cancelled",reason:e})};if(t.isCancelled){n(null,{status:"cancelled"});return}if(!this.taskqueue.isReady){this.taskqueue.addTask("changes",[e,t,n]);return}doChanges(this,e,t,n)},!0);t=r.apply(this,arguments);var i=t.cancel;return t.isCancelled=!1,t.cancel=function(){t.isCancelled=!0,i.apply(this,arguments)},t},AbstractPouchDB.prototype.close=adapterFun("close",function(e){return this._close(e)}),AbstractPouchDB.prototype.info=adapterFun("info",function(e){var t=this;this._info(function(n,r){if(n)return e(n);var i=t.prefix.length;r.db_name.length>i&&r.db_name.slice(0,i)===t.prefix&&(r.db_name=r.db_name.slice(i)),e(null,r)})}),AbstractPouchDB.prototype.id=adapterFun("id",function(e){return this._id(e)}),AbstractPouchDB.prototype.type=function(){return typeof this._type=="function"?this._type():this.adapter},AbstractPouchDB.prototype.bulkDocs=adapterFun("bulkDocs",function(e,t,n){typeof t=="function"&&(n=t,t={}),t?t=utils.extend(!0,{},t):t={};if(!e||!e.docs)return n(errors.MISSING_BULK_DOCS);if(!Array.isArray(e.docs))return n(errors.QUERY_PARSE_ERROR);for(var r=0;r<e.docs.length;++r)if(typeof e.docs[r]!="object"||Array.isArray(e.docs[r]))return n(errors.NOT_AN_OBJECT);return e=utils.extend(!0,{},e),"new_edits"in t||("new_edits"in e?t.new_edits=e.new_edits:t.new_edits=!0),this._bulkDocs(e,t,this.autoCompact(n))})},{"./deps/errors":8,"./merge":14,"./utils":18,events:21}],2:[function(e,t,n){function s(e){var t=s.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),r={},i=14;while(i--)r[t.key[i]]=n[i]||"";return r[t.q.name]={},r[t.key[12]].replace(t.q.parser,function(e,n,i){n&&(r[t.q.name][n]=i)}),r}function o(e){return/^_(design|local)/.test(e)?e:encodeURIComponent(e)}function u(e,t){if(/http(s?):/.test(e)){var n=s(e);n.remote=!0;if(n.user||n.password)n.auth={username:n.user,password:n.password};var i=n.path.replace(/(^\/|\/$)/g,"").split("/");n.db=i.pop(),n.path=i.join("/"),t=t||{},t=r.extend(!0,{},t),n.headers=t.headers||{};if(t.auth||n.auth){var o=t.auth||n.auth,u=r.btoa(o.username+":"+o.password);n.headers.Authorization="Basic "+u}return t.headers&&(n.headers=t.headers),n}return{host:"",path:"/",db:e,auth:!1}}function a(e,t){if(e.remote){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+e.db+"/"+t}return"/"+e.db+"/"+t}function f(e,t){if(e.remote){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+t}return"/"+t}function l(e,t){function h(e,t){return r.ajax(r.extend({},c,e),t)}function v(e,i,s,o){i=r.extend(!0,{},i);var a=u(o),f={source:n.db,target:a.protocol===n.protocol&&a.authority===n.authority?a.db:a.source};i.continuous&&(f.continuous=!0),i.create_target&&(f.create_target=!0),i.doc_ids&&(f.doc_ids=i.doc_ids),i.filter&&typeof i.filter=="string"&&(f.filter=i.filter),i.query_params&&(f.query_params=i.query_params);var l={},c={headers:n.headers,method:"POST",url:n.protocol+"://"+n.host+(n.port===80?"":":"+n.port)+"/_replicate",body:f},p;s.cancel=function(){this.cancelled=!0,p&&!l.ok&&p.abort(),l._local_id&&(c.body={replication_id:l._local_id}),c.body.cancel=!0,h(c,function(e,n,s){if(e)return t(e);r.call(i.complete,null,l,s)})};if(s.cancelled)return;p=h(c,function(e,n,s){if(e)return t(e);l.ok=!0,n._local_id&&(l._local_id=n._local_id),r.call(i.complete,null,n,s)})}var n=u(e.name,e),s=a(n,""),l=this,c=e.ajax||{};e=r.extend(!0,{},e);var p={list:[],get:function(e,t){typeof e=="function"&&(t=e,e={count:10});var r=function(e,n){!e&&"uuids"in n?(p.list=p.list.concat(n.uuids),t(null,"OK")):t(e||i.UNKNOWN_ERROR)},s="?count="+e.count;h({headers:n.headers,method:"GET",url:f(n,"_uuids")+s},r)}},d=function(){h({headers:n.headers,method:"PUT",url:s},function(e,r){e&&e.status===401?h({headers:n.headers,method:"HEAD",url:s},function(e,n){e?t(e):t(null,l)}):!e||e.status===412?t(null,l):t(e)})};e.skipSetup||h({headers:n.headers,method:"GET",url:s},function(e,n){e?e.status===404?d():t(e):t(null,l)}),l.type=function(){return"http"},l.id=r.toPromise(function(e){if(!l.taskqueue.isReady){l.taskqueue.addTask("id",arguments);return}h({headers:n.headers,method:"GET",url:f(n,"")},function(t,r){if(t)e(t);else{var i=r&&r.uuid?r.uuid+n.db:a(n,"");e(null,i)}})}),l.request=r.toPromise(function(e,t){if(!l.taskqueue.isReady){l.taskqueue.addTask("request",arguments);return}e.headers=n.headers,e.url=a(n,e.url),h(e,t)}),l.compact=r.toPromise(function(e,t){if(!l.taskqueue.isReady){l.taskqueue.addTask("compact",arguments);return}typeof e=="function"&&(t=e,e={}),e=r.extend(!0,{},e),h({headers:n.headers,url:a(n,"_compact"),method:"POST"},function(){function n(){l.info(function(r,i){i.compact_running?setTimeout(n,e.interval||200):t()})}typeof t=="function"&&n()})}),l._info=r.toPromise(function(e){if(!l.taskqueue.isReady){l.taskqueue.addTask("info",arguments);return}h({headers:n.headers,method:"GET",url:a(n,"")},function(t,r){t?e(t):(r.host=a(n,""),e(null,r))})}),l.get=r.toPromise(function(e,t,i){if(!l.taskqueue.isReady){l.taskqueue.addTask("get",arguments);return}typeof t=="function"&&(i=t,t={}),t=r.extend(!0,{},t),t.auto_encode===undefined&&(t.auto_encode=!0);var s=[];t.revs&&s.push("revs=true"),t.revs_info&&s.push("revs_info=true"),t.local_seq&&s.push("local_seq=true"),t.open_revs&&(t.open_revs!=="all"&&(t.open_revs=JSON.stringify(t.open_revs)),s.push("open_revs="+t.open_revs)),t.attachments&&s.push("attachments=true"),t.rev&&s.push("rev="+t.rev),t.conflicts&&s.push("conflicts="+t.conflicts),s=s.join("&"),s=s===""?"":"?"+s,t.auto_encode&&(e=o(e));var u={headers:n.headers,method:"GET",url:a(n,e+s)},f=e.split("/");if(f.length>1&&f[0]!=="_design"&&f[0]!=="_local"||f.length>2&&f[0]==="_design"&&f[0]!=="_local")u.binary=!0;h(u,function(e,t,n){if(e)return i(e);i(null,t,n)})}),l.remove=r.toPromise(function(e,t,r){if(!l.taskqueue.isReady){l.taskqueue.addTask("remove",arguments);return}typeof t=="function"&&(r=t,t={}),h({headers:n.headers,method:"DELETE",url:a(n,o(e._id))+"?rev="+e._rev},r)}),l.getAttachment=r.toPromise(function(e,t,n,i){typeof n=="function"&&(i=n,n={}),n=r.extend(!0,{},n),n.auto_encode===undefined&&(n.auto_encode=!0),n.auto_encode&&(e=o(e)),n.auto_encode=!1,l.get(e+"/"+t,n,i)}),l.removeAttachment=r.toPromise(function(e,t,r,i){if(!l.taskqueue.isReady){l.taskqueue.addTask("removeAttachment",arguments);return}h({headers:n.headers,method:"DELETE",url:a(n,o(e)+"/"+t)+"?rev="+r},i)}),l.putAttachment=r.toPromise(function(e,t,r,i,s,u){if(!l.taskqueue.isReady){l.taskqueue.addTask("putAttachment",arguments);return}typeof s=="function"&&(u=s,s=i,i=r,r=null),typeof s=="undefined"&&(s=i,i=r,r=null);var f=o(e)+"/"+t,c=a(n,f);r&&(c+="?rev="+r);var p={headers:n.headers,method:"PUT",url:c,processData:!1,body:i,timeout:6e4};p.headers["Content-Type"]=s,h(p,u)}),l.put=r.toPromise(function(){var e=Array.prototype.slice.call(arguments);if(!l.taskqueue.isReady){l.taskqueue.addTask("put",e);return}var t,s,u,f,c=e.shift(),p="_id"in c;if(typeof c!="object"||Array.isArray(c))return f=e.pop(),f(i.NOT_AN_OBJECT);c=r.extend(!0,{},c);for(;;){t=e.shift(),s=typeof t,s==="string"&&!p?(c._id=t,p=!0):s!=="string"||!p||"_rev"in c?s==="object"?u=r.extend(!0,{},t):s==="function"&&(f=t):c._rev=t;if(!e.length)break}u=u||{};var d=r.invalidIdError(c._id);if(d)return f(d);var v=[];u&&typeof u.new_edits!="undefined"&&v.push("new_edits="+u.new_edits),v=v.join("&"),v!==""&&(v="?"+v),h({headers:n.headers,method:"PUT",url:a(n,o(c._id))+v,body:c},f)}),l.post=r.toPromise(function(e,t,n){if(!l.taskqueue.isReady){l.taskqueue.addTask("post",arguments);return}typeof t=="function"&&(n=t,t={}),t=r.extend(!0,{},t);if(typeof e!="object")return n(i.NOT_AN_OBJECT);"_id"in e?l.put(e,t,n):p.list.length>0?(e._id=p.list.pop(),l.put(e,t,n)):p.get(function(r,s){if(r)return n(i.UNKNOWN_ERROR);e._id=p.list.pop(),l.put(e,t,n)})}),l.bulkDocs=r.toPromise(function(e,t,s){if(!l.taskqueue.isReady){l.taskqueue.addTask("bulkDocs",arguments);return}typeof t=="function"&&(s=t,t={}),t||(t={});if(!Array.isArray(e.docs))return s(i.error(i.NOT_AN_OBJECT,"Missing JSON list of 'docs'"));var o=e.docs.filter(function(e){return typeof e!="object"||Array.isArray(e)});if(o.length)return s(i.NOT_AN_OBJECT);e=r.extend(!0,{},e),t=r.extend(!0,{},t),typeof t.new_edits!="undefined"&&(e.new_edits=t.new_edits),h({headers:n.headers,method:"POST",url:a(n,"_bulk_docs"),body:e},s)}),l.allDocs=r.toPromise(function(e,t){if(!l.taskqueue.isReady){l.taskqueue.addTask("allDocs",arguments);return}typeof e=="function"&&(t=e,e={}),e=r.extend(!0,{},e);var i=[],s,o="GET";e.conflicts&&i.push("conflicts=true"),e.descending&&i.push("descending=true"),e.include_docs&&i.push("include_docs=true"),e.key&&i.push("key="+encodeURIComponent(JSON.stringify(e.key))),e.startkey&&i.push("startkey="+encodeURIComponent(JSON.stringify(e.startkey))),e.endkey&&i.push("endkey="+encodeURIComponent(JSON.stringify(e.endkey))),e.limit&&i.push("limit="+e.limit),typeof e.skip!="undefined"&&i.push("skip="+e.skip),i=i.join("&"),i!==""&&(i="?"+i);if(typeof e.keys!="undefined"){var u=2e3,f="keys="+encodeURIComponent(JSON.stringify(e.keys));f.length+i.length+1<=u?i+=(i.indexOf("?")!==-1?"&":"?")+f:(o="POST",s=JSON.stringify({keys:e.keys}))}h({headers:n.headers,method:o,url:a(n,"_all_docs"+i),body:s},t)}),l._changes=function(e){var t=25;e=r.extend(!0,{},e),e.timeout=e.timeout||0;var s={},o=typeof e.limit!="undefined"?e.limit:!1;o===0&&(o=1);var u=o;e.style&&(s.style=e.style);if(e.include_docs||e.filter&&typeof e.filter=="function")s.include_docs=!0;e.continuous&&(s.feed="longpoll"),e.conflicts&&(s.conflicts=!0),e.descending&&(s.descending=!0),e.filter&&typeof e.filter=="string"&&(s.filter=e.filter,e.filter==="_view"&&e.view&&typeof e.view=="string"&&(s.view=e.view));if(e.query_params&&typeof e.query_params=="object")for(var f in e.query_params)e.query_params.hasOwnProperty(f)&&(s[f]=e.query_params[f]);var l,c,p=function(r,i){if(e.aborted)return;s.since=r,e.descending?o&&(s.limit=u):s.limit=!o||u>t?t:u;var f="?"+Object.keys(s).map(function(e){return e+"="+s[e]}).join("&"),p={headers:n.headers,method:"GET",url:a(n,"_changes"+f),timeout:e.timeout};c=r;if(e.aborted)return;l=h(p,i)},d=10,v=0,m={results:[]},g=function(n,s){if(e.aborted)return;var a=0;if(s&&s.results){a=s.results.length,m.last_seq=s.last_seq;var f={};f.query=e.query_params,s.results=s.results.filter(function(t){u--;var n=r.filterChange(e)(t);return n&&(m.results.push(t),r.call(e.onChange,t)),n})}else if(n){e.aborted=!0,r.call(e.complete,n);return}s&&s.last_seq&&(c=s.last_seq);var l=o&&u<=0||s&&a<t||e.descending;if(e.continuous||!l){n?v+=1:v=0;var h=1<<v,y=d*h,b=e.maximumWait||3e4;if(y>b){r.call(e.complete,n||i.UNKNOWN_ERROR);return}setTimeout(function(){p(c,g)},y)}else r.call(e.complete,null,m)};return p(e.since||0,g),{cancel:function(){e.aborted=!0,l.abort()}}},l.revsDiff=r.toPromise(function(e,t,r){if(!l.taskqueue.isReady){l.taskqueue.addTask("revsDiff",arguments);return}typeof t=="function"&&(r=t,t={}),h({headers:n.headers,method:"POST",url:a(n,"_revs_diff"),body:e},function(e,t){r(e,t)})}),l.close=r.toPromise(function(e){if(!l.taskqueue.isReady){l.taskqueue.addTask("close",arguments);return}e()}),l.replicateOnServer=function(e,t,n){if(!l.taskqueue.isReady)return l.taskqueue.addTask("replicateOnServer",arguments),n;e.info(function(r,i){v(e,t,n,i.host)})},l.destroy=r.toPromise(function(e){if(!l.taskqueue.isReady){l.taskqueue.addTask("destroy",arguments);return}r.ajax({url:a(n,""),method:"DELETE"},function(t,n){t?(l.emit("error",t),e(t)):(l.emit("destroyed"),e(null,n))})})}var r=e("../utils"),i=e("../deps/errors");s.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},l.destroy=r.toPromise(function(e,t,n){var i=u(e,t);t=t||{},typeof t=="function"&&(n=t,t={}),t=r.extend(!0,{},t),t.headers=i.headers,t.method="DELETE",t.url=a(i,""),r.ajax(t,n)}),l.valid=function(){return!0},t.exports=l},{"../deps/errors":8,"../utils":18}],3:[function(e,t,n){(function(n){function o(e){return function(t){e(s.error(s.IDB_ERROR,t.target,t.type))}}function u(){var e="_pouch__checkModernIdb_"+(n.navigator&&n.navigator.appVersion),t=r.hasLocalStorage()&&n.localStorage[e];if(t)return JSON.parse(t);var i="_pouch__checkModernIdb",s=n.indexedDB.open(i,1).onupgradeneeded===null;return n.indexedDB.deleteDatabase&&n.indexedDB.deleteDatabase(i),r.hasLocalStorage()&&(n.localStorage[e]=JSON.stringify(s)),s}function a(e,t){function b(e){e.createObjectStore(u,{keyPath:"id"}).createIndex("seq","seq",{unique:!0}),e.createObjectStore(f,{autoIncrement:!0}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0}),e.createObjectStore(l,{keyPath:"digest"}),e.createObjectStore(c,{keyPath:"id",autoIncrement:!1}),e.createObjectStore(h)}function w(e){var t=e.currentTarget.transaction.objectStore(u);t.openCursor().onsuccess=function(e){var n=e.target.result;if(n){var i=n.value,s=r.isDeleted(i),o=r.isLocalId(i.id);i.deletedOrLocal=s||o?"1":"0",t.put(i),n["continue"]()}else t.createIndex("deletedOrLocal","deletedOrLocal",{unique:!1})}}function E(e,t){return e._bulk_seq-t._bulk_seq}function S(e,t,n){var i=t.keys,s="descending"in t?t.descending:!1;if(!i.length)n(null,{offset:t.skip,rows:[],total_rows:e});else{var o=[];i.forEach(function(u){var a=r.extend(!0,{},t);a.keys_request=!0,a.key=u,delete a.keys,delete a.skip,delete a.limit,x(e,a,function(r,a){o.push({err:r,res:a,key:u});if(o.length===i.length){var f={};for(var l=0;l<o.length;l++){var c=o[l];if(c.err){n(r);return}f[c.key]=c}var h=[];i.forEach(function(e){var t=f[e];t.res.rows.length?h.push(t.res.rows[0]):h.push({key:e,error:"not_found"})}),s&&(h=h.reverse()),n(null,{total_rows:e,offset:t.skip,rows:"limit"in t?h.slice(t.skip,t.limit+t.skip):t.skip>0?h.slice(t.skip):h})}})})}}function x(e,t,o){var a="startkey"in t?t.startkey:!1,l="endkey"in t?t.endkey:!1,c="key"in t?t.key:!1,h="descending"in t&&t.descending?"prev":null,p=0,d=!1;h&&a&&l&&(d=l,l=!1);var v;try{v=a&&l?n.IDBKeyRange.bound(a,l):a?h?n.IDBKeyRange.upperBound(a):n.IDBKeyRange.lowerBound(a):l?h?n.IDBKeyRange.lowerBound(l):n.IDBKeyRange.upperBound(l):c?n.IDBKeyRange.only(c):null}catch(m){return m.name==="DataError"&&m.code===0?o(null,{total_rows:e,offset:t.skip,rows:[]}):o(s.error(s.IDB_ERROR,m.name,m.message))}var g=y.transaction([u,f],"readonly");g.oncomplete=function(){o(null,{total_rows:e,offset:t.skip,rows:E})};var b=g.objectStore(u),w=h?b.openCursor(v,h):b.openCursor(v),E=[];w.onsuccess=function(e){function o(e,s){if(r.isLocalId(e.id))return n["continue"]();var o={id:e.id,key:e.id,value:{rev:i.winningRev(e)}};if(t.include_docs){o.doc=s,o.doc._rev=i.winningRev(e),o.doc._doc_id_rev&&delete o.doc._doc_id_rev,t.conflicts&&(o.doc._conflicts=i.collectConflicts(e));for(var u in o.doc._attachments)o.doc._attachments.hasOwnProperty(u)&&(o.doc._attachments[u].stub=!0)}if(t.keys_request)r.isDeleted(e)&&(o.value.deleted=!0,o.doc=null),E.push(o);else if(!r.isDeleted(e))if(!E.length&&t.skip>0&&p<t.skip)p++;else{if(d&&o.key<=d){o.key===d&&E.push(o);return}if("limit"in t&&E.length===t.limit)return;E.push(o)}n["continue"]()}if(!e.target.result)return;var n=e.target.result,s=n.value;if(!t.include_docs)o(s);else{var u=g.objectStore(f).index("_doc_id_rev"),a=i.winningRev(s),l=s.id+"::"+a;u.get(l).onsuccess=function(e){o(n.value,e.target.result)}}}}var u="document-store",f="by-sequence",l="attach-store",c="meta-store",h="detect-blob-support",p=e.name,d=n.indexedDB.open(p);"openReqList"in a||(a.openReqList={}),a.openReqList[p]=d;var v=null,m=null,g=this,y=null;d.onupgradeneeded=function(e){var t=e.target.result;e.oldVersion<1&&b(t),e.oldVersion<2&&w(e)},d.onsuccess=function(e){y=e.target.result,y.onversionchange=function(){y.close()};var n=y.transaction([c,h],"readwrite"),i=n.objectStore(c).get(c);i.onsuccess=function(e){var i=!1,s=function(){if(v===null||!i)return;t(null,g)},o=e.target.result||{id:c};p+"_id"in o?(m=o[p+"_id"],i=!0,s()):(m=r.uuid(),o[p+"_id"]=m,n.objectStore(c).put(o).onsuccess=function(){i=!0,s()});try{n.objectStore(h).put(r.createBlob(),"key"),v=!0}catch(u){v=!1}finally{s()}}},d.onerror=o(t),g.type=function(){return"idb"},g._id=r.toPromise(function(e){e(null,m)}),g._bulkDocs=function(t,n,h){function x(e){var t=e.target.result;t.updateSeq=(t.updateSeq||0)+S,D.objectStore(c).put(t)}function T(){if(!g.length){D.objectStore(c).get(c).onsuccess=x;return}var e=g.shift(),t=D.objectStore(u).get(e.metadata.id);t.onsuccess=function(n){var r=n.target.result;r?A(r,e):O(e)}}function N(e){var t=[];w.sort(E),w.forEach(function(e){delete e._bulk_seq;if(e.error){t.push(e);return}var n=e.metadata,s=i.winningRev(n);t.push({ok:!0,id:n.id,rev:s});if(r.isLocalId(n.id))return;a.Changes.notify(p),a.Changes.notifyLocalWindows(p)}),h(null,t)}function C(e,t){if(e.stub)return t();if(typeof e.data=="string"){var n;try{n=atob(e.data)}catch(i){var o=s.error(s.BAD_ARG,"Attachments need to be base64 encoded");return h(o)}e.digest="md5-"+r.Crypto.MD5(n);if(v){var u=e.content_type;n=r.fixBinary(n),e.data=r.createBlob([n],{type:u})}return t()}var a=new FileReader;a.onloadend=function(n){e.digest="md5-"+r.Crypto.MD5(this.result),v||(e.data=btoa(this.result)),t()},a.readAsBinaryString(e.data)}function k(e){function n(){t++,g.length===t&&e()}if(!g.length)return e();var t=0;g.forEach(function(e){function i(){r++,r===t.length&&n()}var t=e.data&&e.data._attachments?Object.keys(e.data._attachments):[];if(!t.length)return n();var r=0;for(var s in e.data._attachments)e.data._attachments.hasOwnProperty(s)&&C(e.data._attachments[s],i)})}function L(e,t){function o(e){n||(e?(n=e,t(n)):i===s.length&&p())}function a(e){i++,o(e)}function p(){e.data._doc_id_rev=e.data._id+"::"+e.data._rev;var n=D.objectStore(f).put(e.data);n.onsuccess=function(n){e.metadata.seq=n.target.result,delete e.metadata.rev;var i=r.isDeleted(e.metadata),s=r.isLocalId(e.metadata.id),o=r.extend(!0,{deletedOrLocal:i||s?"1":"0"},e.metadata),a=D.objectStore(u).put(o);a.onsuccess=function(){w.push(e),r.call(t)}}}var n=null,i=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,S++,r.isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var s=e.data._attachments?Object.keys(e.data._attachments):[];for(var l in e.data._attachments)if(!e.data._attachments[l].stub){var c=e.data._attachments[l].data;delete e.data._attachments[l].data;var h=e.data._attachments[l].digest;_(e,h,c,a)}else i++,o();s.length||p()}function A(e,t){var n=i.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),o=r.isDeleted(e),u=o&&r.isDeleted(t.metadata)||!o&&d&&n.conflicts!=="new_leaf";if(u)return w.push(M(s.REV_CONFLICT,t._bulk_seq)),T();t.metadata.rev_tree=n.tree,L(t,T)}function O(e){if("was_delete"in n&&r.isDeleted(e.metadata))return w.push(s.MISSING_DOC),T();L(e,T)}function M(e,t){return e._bulk_seq=t,e}function _(e,t,n,i){var s=D.objectStore(l);s.get(t).onsuccess=function(o){var u=o.target.result&&o.target.result.refs||{},a=[e.metadata.id,e.metadata.rev].join("@"),f={digest:t,body:n,refs:u};f.refs[a]=!0,s.put(f).onsuccess=function(e){r.call(i)}}}var d=n.new_edits,m=t.docs,g=m.map(function(e,t){var n=r.parseDoc(e,d);return n._bulk_seq=t,n}),b=g.filter(function(e){return e.error});if(b.length)return h(b[0]);var w=[],S=0,D;k(function(){D=y.transaction([u,f,l,c],"readwrite"),D.onerror=o(h),D.ontimeout=o(h),D.oncomplete=N,T()})},g._get=function(t,n,o){function d(){o(h,{doc:a,metadata:c,ctx:p})}var a,c,h,p;n=r.extend(!0,{},n),n.ctx?p=n.ctx:p=y.transaction([u,f,l],"readonly"),p.objectStore(u).get(t).onsuccess=function(e){c=e.target.result;if(!c)return h=s.MISSING_DOC,d();if(r.isDeleted(c)&&!n.rev)return h=s.error(s.MISSING_DOC,"deleted"),d();var t=i.winningRev(c),o=c.id+"::"+(n.rev?n.rev:t),u=p.objectStore(f).index("_doc_id_rev");u.get(o).onsuccess=function(e){a=e.target.result,a&&a._doc_id_rev&&delete a._doc_id_rev;if(!a)return h=s.MISSING_DOC,d();d()}}},g._getAttachment=function(e,t,n){var i,s;t=r.extend(!0,{},t),t.ctx?s=t.ctx:s=y.transaction([u,f,l],"readonly");var o=e.digest,a=e.content_type;s.objectStore(l).get(o).onsuccess=function(e){var s=e.target.result.body;if(t.encode)if(v){var o=new FileReader;o.onloadend=function(e){i=btoa(this.result),n(null,i)},o.readAsBinaryString(s)}else i=s,n(null,i);else v?i=s:(s=r.fixBinary(atob(s)),i=r.createBlob([s],{type:a})),n(null,i)}},g._allDocs=function(t,r){function a(e){s=e.target.result}var i=y.transaction([u],"readonly"),s,f=i.objectStore(u).index("deletedOrLocal");f.count(n.IDBKeyRange.only("0")).onsuccess=a,i.onerror=o(r),i.oncomplete=function(){"keys"in t?S(s,t,r):x(s,t,r)}},g._info=function(t){function s(e){r=e.target.result&&e.target.result.updateSeq||0}function o(e){var t=e.target.result;if(!t){i.objectStore(c).get(c).onsuccess=s;return}t.value.deleted!==!0&&n++,t["continue"]()}var n=0,r=0,i=y.transaction([u,c],"readonly");i.oncomplete=function(){t(null,{db_name:p,doc_count:n,update_seq:r})},i.objectStore(u).openCursor().onsuccess=o},g._changes=function(t){function m(){v=y.transaction([u,f]),v.oncomplete=w;var e;o?e=v.objectStore(f).openCursor(n.IDBKeyRange.lowerBound(t.since,!0),o):e=v.objectStore(f).openCursor(n.IDBKeyRange.lowerBound(t.since,!0)),e.onsuccess=b,e.onerror=onerror}function b(e){if(!e.target.result){for(var n=0,s=c.length;n<s;n++){var o=c[n];o&&d.push(o)}return!1}var a=e.target.result,p=a.value._id,m=h[p];if(m!==undefined)return c[m].seq=a.key,c.push(c[m]),c[m]=null,h[p]=c.length-1,a["continue"]();var g=v.objectStore(u);g.get(a.value._id).onsuccess=function(e){var n=e.target.result;if(r.isLocalId(n.id))return a["continue"]();l<n.seq&&(l=n.seq);var s=i.winningRev(n),o=n.id+"::"+s,u=v.objectStore(f).index("_doc_id_rev");u.get(o).onsuccess=function(e){var r=e.target.result;delete r._doc_id_rev,r._rev=s;var i=t.processChange(r,n,t);i.seq=a.key;var o=i.id,u=h[o];u!==undefined&&(c[u]=null),c.push(i),h[o]=c.length-1,a["continue"]()}}}function w(){r.processChanges(t,d,l)}t=r.extend(!0,{},t);if(t.continuous){var s=p+":"+r.uuid();return a.Changes.addListener(p,s,g,t),a.Changes.notify(p),{cancel:function(){a.Changes.removeListener(p,s)}}}var o=t.descending?"prev":null,l=0;t.since=t.since&&!o?t.since:0;var c=[],h={},d=[],v;m()},g._close=function(e){if(y===null)return e(s.NOT_OPEN);y.close(),e()},g._getRevisionTree=function(e,t){var n=y.transaction([u],"readonly"),r=n.objectStore(u).get(e);r.onsuccess=function(e){var n=e.target.result;n?t(null,n.rev_tree):t(s.MISSING_DOC)}},g._doCompaction=function(e,t,n,i){var s=y.transaction([u,f],"readwrite"),o=s.objectStore(u);o.get(e).onsuccess=function(i){var o=i.target.result;o.rev_tree=t;var a=n.length;n.forEach(function(t){var n=s.objectStore(f).index("_doc_id_rev"),i=e+"::"+t;n.getKey(i).onsuccess=function(e){var t=e.target.result;if(!t)return;s.objectStore(f)["delete"](t),a--;if(!a){if(o){var n=r.isDeleted(o),i=r.isLocalId(o.id);o=r.extend(!0,{deletedOrLocal:n||i?"1":"0"},o)}s.objectStore(u).put(o)}}})},s.oncomplete=function(){r.call(i)}}}var r=e("../utils"),i=e("../merge"),s=e("../deps/errors");a.valid=function(){return n.indexedDB&&u()},a.destroy=r.toPromise(function(e,t,r){"openReqList"in a||(a.openReqList={}),a.Changes.clearListeners(e),a.openReqList[e]&&a.openReqList[e].result&&a.openReqList[e].result.close();var i=n.indexedDB.deleteDatabase(e);i.onsuccess=function(){a.openReqList[e]&&(a.openReqList[e]=null),r()},i.onerror=o(r)}),a.Changes=new r.Changes,t.exports=a}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"../deps/errors":8,"../merge":14,"../utils":18}],4:[function(e,t,n){(function(n){function o(e){return"'"+e+"'"}function u(){if(typeof n!="undefined")return n.navigator&&n.navigator.sqlitePlugin&&n.navigator.sqlitePlugin.openDatabase?navigator.sqlitePlugin.openDatabase.apply(navigator.sqlitePlugin,arguments):n.sqlitePlugin&&n.sqlitePlugin.openDatabase?n.sqlitePlugin.openDatabase.apply(n.sqlitePlugin,arguments):n.openDatabase.apply(n,arguments)}function w(e){return function(t){var n=t&&t.constructor.toString().match(/function ([^\(]+)/),r=n&&n[1]||t.type,i=t.target||t.message;e(s.error(s.WSQ_ERROR,i,r))}}function E(e){var t="";for(var n=0,r=e.length;n<r;n+=2)t+=String.fromCharCode(parseInt(e.substring(n,n+2),16));return t}function S(e){for(var t=1,n=e.length;t<n;t+=2)if(e.charAt(t)!=="\0")return!1;return!0}function x(e){var t="";for(var n=0,r=e.length;n<r;n+=2)t+=e.charAt(n);return t}function T(e){var t;try{t=decodeURIComponent(window.escape(e))}catch(n){t=e}return S(t)?x(t):t}function N(e,t){function L(){r.hasLocalStorage()&&(n.localStorage["_pouch__websqldb_"+C]=!0),t(null,S)}function A(e){e.executeSql(g),e.executeSql("ALTER TABLE "+h+" ADD COLUMN deleted TINYINT(1) DEFAULT 0",[],function(){e.executeSql(v),e.executeSql("ALTER TABLE "+c+" ADD COLUMN local TINYINT(1) DEFAULT 0",[],function(){e.executeSql(m);var t="SELECT "+c+".winningseq AS seq, "+c+".json AS metadata FROM "+h+" JOIN "+c+" ON "+h+".seq = "+c+".winningseq";e.executeSql(t,[],function(e,t){var n=[],i=[];for(var s=0;s<t.rows.length;s++){var o=t.rows.item(s),u=o.seq,a=JSON.parse(o.metadata);r.isDeleted(a)&&n.push(u),r.isLocalId(a.id)&&i.push(a.id)}e.executeSql("UPDATE "+c+"SET local = 1 WHERE id IN ("+i.map(function(){return"?"}).join(",")+")",i),e.executeSql("UPDATE "+h+" SET deleted = 1 WHERE seq IN ("+n.map(function(){return"?"}).join(",")+")",n)})})})}function O(){while(y.length>0){var e=y.pop();e(null,x)}}function M(e,t){if(t===0){var n="CREATE TABLE IF NOT EXISTS "+d+" (update_seq, dbid, db_version INTEGER)",i="CREATE TABLE IF NOT EXISTS "+p+" (digest, json, body BLOB)",s="CREATE TABLE IF NOT EXISTS "+c+" (id unique, seq, json, winningseq, local TINYINT(1))",o="CREATE TABLE IF NOT EXISTS "+h+" (seq INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, doc_id_rev UNIQUE, json, deleted TINYINT(1))";e.executeSql(i),e.executeSql(s,[],function(){e.executeSql(g),e.executeSql(m)}),e.executeSql(o,[],function(){e.executeSql(v)}),e.executeSql(n,[],function(){var t="INSERT INTO "+d+" (update_seq, db_version, dbid) VALUES (?, ?, ?)";x=r.uuid(),e.executeSql(t,[0,l,x]),O()})}else t===1&&(A(e),e.executeSql("UPDATE "+d+" SET db_version = "+l)),e.executeSql("SELECT dbid FROM "+d,[],function(e,t){x=t.rows.item(0).dbid,O()})}function _(){k.transaction(function(e){e.executeSql("SELECT sql FROM sqlite_master WHERE tbl_name = "+d,[],function(e,t){t.rows.length?/db_version/.test(t.rows.item(0).sql)?e.executeSql("SELECT db_version FROM "+d,[],function(e,t){var n=t.rows.item(0).db_version;M(e,n)}):e.executeSql("ALTER TABLE "+d+" ADD COLUMN db_version INTEGER",[],function(){M(e,1)}):M(e,0)})},w(t),L)}var S=this,x=null,C=e.name,k=b[C];k||(b[C]=k=u(C,a,C,f));if(!k)return t(s.UNKNOWN_ERROR);r.isCordova()&&typeof n!="undefined"?n.addEventListener(C+"_pouch",function D(){n.removeEventListener(C+"_pouch",D,!1),_()},!1):_(),S.type=function(){return"websql"},S._id=r.toPromise(function(e){e(null,x)}),S._info=function(e){k.transaction(function(t){var n="SELECT COUNT(id) AS count FROM "+c;t.executeSql(n,[],function(t,n){var r=n.rows.item(0).count,i="SELECT update_seq FROM "+d;t.executeSql(i,[],function(t,n){var i=n.rows.item(0).update_seq;e(null,{db_name:C,doc_count:r,update_seq:i})})})})},S._bulkDocs=function(e,t,n){function y(e,t){return e._bulk_seq-t._bulk_seq}function b(e){var t=[];m.sort(y),m.forEach(function(e){delete e._bulk_seq;if(e.error){t.push(e);return}var n=e.metadata,s=i.winningRev(n);t.push({ok:!0,id:n.id,rev:s});if(r.isLocalId(n.id))return;a++,N.Changes.notify(C),N.Changes.notifyLocalWindows(C)});var s="SELECT update_seq FROM "+d;v.executeSql(s,[],function(e,r){var i=r.rows.item(0).update_seq+a,s="UPDATE "+d+" SET update_seq=?";e.executeSql(s,[i],function(){n(null,t)})})}function E(e,t){if(e.stub)return t();if(typeof e.data=="string"){try{e.data=atob(e.data)}catch(i){var o=s.error(s.BAD_ARG,"Attachments need to be base64 encoded");return n(o)}var u=r.fixBinary(e.data);e.data=r.createBlob([u],{type:e.content_type})}var a=new FileReader;a.onloadend=function(n){e.data=this.result,e.digest="md5-"+r.Crypto.MD5(this.result),t()},a.readAsBinaryString(e.data)}function S(e){function n(){t++,f.length===t&&e()}if(!f.length)return e();var t=0;f.forEach(function(e){function i(){r++,r===t.length&&n()}var t=e.data&&e.data._attachments?Object.keys(e.data._attachments):[],r=0;if(!t.length)return n();for(var s in e.data._attachments)e.data._attachments.hasOwnProperty(s)&&E(e.data._attachments[s],i)})}function x(e,t,n){function s(){var t=e.data,n="INSERT INTO "+h+" (doc_id_rev, json, deleted) VALUES (?, ?, ?);",i=[t._id+"::"+t._rev,JSON.stringify(t),r.isDeleted(e.metadata,e.metadata.rev)?1:0];v.executeSql(n,i,y)}function o(e){u||(e?(u=e,t(u)):a===f.length&&s())}function l(e){a++,o(e)}function y(s,o){var u=e.metadata.seq=o.insertId;delete e.metadata.rev;var a=i.winningRev(e.metadata),f=n?"UPDATE "+c+" SET seq=?, json=?, winningseq=(SELECT seq FROM "+h+" WHERE doc_id_rev=?) WHERE id=?":"INSERT INTO "+c+" (id, seq, winningseq, json, local) VALUES (?, ?, ?, ?, ?);",l=JSON.stringify(e.metadata),p=e.metadata.id+"::"+a,d=r.isLocalId(e.metadata.id)?1:0,v=n?[u,l,p,e.metadata.id]:[e.metadata.id,u,u,l,d];s.executeSql(f,v,function(n,r){m.push(e),t()})}var u=null,a=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,r.isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var f=e.data._attachments?Object.keys(e.data._attachments):[];for(var p in e.data._attachments)if(!e.data._attachments[p].stub){var d=e.data._attachments[p].data;delete e.data._attachments[p].data;var g=e.data._attachments[p].digest;M(e,g,d,l)}else a++,o();f.length||s()}function T(e,t){var n=i.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),u=r.isDeleted(e)&&r.isDeleted(t.metadata)||!r.isDeleted(e)&&o&&n.conflicts!=="new_leaf";if(u)return m.push(O(s.REV_CONFLICT,t._bulk_seq)),A();t.metadata.rev_tree=n.tree,x(t,A,!0)}function L(e){if("was_delete"in t&&r.isDeleted(e.metadata))return m.push(s.MISSING_DOC),A();x(e,A,!1)}function A(){if(!f.length)return b();var e=f.shift(),t=e.metadata.id;t in g?T(g[t],e):(g[t]=e.metadata,L(e))}function O(e,t){return e._bulk_seq=t,e}function M(e,t,n,r){var i=[e.metadata.id,e.metadata.rev].join("@"),s={digest:t},o="SELECT digest, json FROM "+p+" WHERE digest=?";v.executeSql(o,[t],function(e,u){u.rows.length?(s.refs=JSON.parse(u.rows.item(0).json).refs,o="UPDATE "+p+" SET json=?, body=? WHERE digest=?",e.executeSql(o,[JSON.stringify(s),n,t],function(){r()})):(s.refs={},s.refs[i]=!0,o="INSERT INTO "+p+"(digest, json, body) VALUES (?, ?, ?)",e.executeSql(o,[t,JSON.stringify(s),n],function(){r()}))})}function _(e,t){for(var n=0;n<t.rows.length;n++){var r=t.rows.item(n);g[r.id]=JSON.parse(r.json)}A()}var o=t.new_edits,u=e.docs,a=0,f=u.map(function(e,t){var n=r.parseDoc(e,o);return n._bulk_seq=t,n}),l=f.filter(function(e){return e.error});if(l.length)return n(l[0]);var v,m=[],g={};S(function(){k.transaction(function(e){v=e;var t="SELECT * FROM "+c+" WHERE id IN "+"("+f.map(function(){return"?"}).join(",")+")",n=f.map(function(e){return e.metadata.id});v.executeSql(t,n,_)},w(n))})},S._get=function(e,t,n){function l(){n(a,{doc:o,metadata:u,ctx:f})}t=r.extend(!0,{},t);var o,u,a;if(!t.ctx){k.transaction(function(r){t.ctx=r,S._get(e,t,n)});return}var f=t.ctx,p="SELECT * FROM "+c+" WHERE id=?";f.executeSql(p,[e],function(e,n){if(!n.rows.length)return a=s.MISSING_DOC,l();u=JSON.parse(n.rows.item(0).json);if(r.isDeleted(u)&&!t.rev)return a=s.error(s.MISSING_DOC,"deleted"),l();var c=i.winningRev(u),p=t.rev?t.rev:c;p=u.id+"::"+p;var d="SELECT * FROM "+h+" WHERE doc_id_rev=?";f.executeSql(d,[p],function(e,t){if(!t.rows.length)return a=s.MISSING_DOC,l();o=JSON.parse(t.rows.item(0).json),l()})})},S._allDocs=function(e,t){var n=[],s={},o,u=h+" JOIN "+c+" ON "+h+".seq = "+c+".winningseq",a="startkey"in e?e.startkey:!1,f="endkey"in e?e.endkey:!1,l="key"in e?e.key:!1,p="descending"in e?e.descending:!1,d="keys"in e?e.keys:!1,v="limit"in e?e.limit:!1,m="skip"in e?e.skip:!1,g=[],y=[c+".local = 0"];if(l!==!1)y.push(c+".id = ?"),g.push(l);else if(d!==!1)y.push(c+".id in ("+d.map(function(){return"?"}).join(",")+")"),g=g.concat(d);else if(a!==!1||f!==!1)a!==!1&&(y.push(c+".id "+(p?"<=":">=")+" ?"),g.push(a)),f!==!1&&(y.push(c+".id "+(p?">=":"<=")+" ?"),g.push(f)),l!==!1&&(y.push(c+".id = ?"),g.push(l));d===!1&&y.push(h+".deleted = 0"),k.transaction(function(t){var a="SELECT COUNT("+c+".id) AS 'num' FROM "+u+" WHERE "+h+".deleted = 0 AND "+c+".local = 0";t.executeSql(a,[],function(t,a){o=a.rows.item(0).num;var f="SELECT "+c+".id, "+h+".seq, "+h+".json AS data, "+c+".json AS metadata FROM "+u;y.length&&(f+=" WHERE "+y.join(" AND ")),f+=" ORDER BY "+c+".id "+(p?"DESC":"ASC"),v!==!1&&(f+=" LIMIT "+v),m!==!1&&m>0&&(v===!1&&(f+=" LIMIT -1"),f+=" OFFSET "+m),t.executeSql(f,g,function(t,o){for(var u=0,a=o.rows.length;u<a;u++){var f=o.rows.item(u),l=JSON.parse(f.metadata),c=JSON.parse(f.data);f={id:l.id,key:l.id,value:{rev:i.winningRev(l)}};if(e.include_docs){f.doc=c,f.doc._rev=i.winningRev(l),e.conflicts&&(f.doc._conflicts=i.collectConflicts(l));for(var h in f.doc._attachments)f.doc._attachments.hasOwnProperty(h)&&(f.doc._attachments[h].stub=!0)}"keys"in e?e.keys.indexOf(l.id)>-1&&(r.isDeleted(l)&&(f.value.deleted=!0,f.doc=null),s[f.id]=f):n.push(f)}})})},w(t),function(){"keys"in e&&(e.keys.forEach(function(e){e in s?n.push(s[e]):n.push({key:e,error:"not_found"})}),e.descending&&n.reverse()),t(null,{total_rows:o,offset:e.skip,rows:n})})},S._changes=function(t){function o(){var e="SELECT "+c+".id, "+h+".seq, "+h+".json AS data, "+c+".json AS metadata FROM "+h+" JOIN "+c+" ON "+h+".seq = "+c+".winningseq WHERE "+c+".seq > "+t.since+" ORDER BY "+c+".seq "+(i?"DESC":"ASC");k.transaction(function(n){n.executeSql(e,[],function(e,n){var i=0;for(var o=0,u=n.rows.length;o<u;o++){var a=n.rows.item(o),f=JSON.parse(a.metadata);if(!r.isLocalId(f.id)){i<a.seq&&(i=a.seq);var l=JSON.parse(a.data),c=t.processChange(l,f,t);c.seq=a.seq,s.push(c)}}r.processChanges(t,s,i)})})}t=r.extend(!0,{},t);if(t.continuous){var n=C+":"+r.uuid();return N.Changes.addListener(C,n,S,t),N.Changes.notify(C),{cancel:function(){N.Changes.removeListener(C,n)}}}var i=t.descending;t.since=t.since&&!i?t.since:0;var s=[];o()},S._close=function(e){e()},S._getAttachment=function(e,t,n){var i,s=t.ctx,o=e.digest,u=e.content_type,a="SELECT hex(body) as body FROM "+p+" WHERE digest=?";s.executeSql(a,[o],function(e,s){var o=T(E(s.rows.item(0).body));t.encode?i=btoa(o):(o=r.fixBinary(o),i=r.createBlob([o],{type:u})),n(null,i)})},S._getRevisionTree=function(e,t){k.transaction(function(n){var r="SELECT json AS metadata FROM "+c+" WHERE id = ?";n.executeSql(r,[e],function(e,n){if(!n.rows.length)t(s.MISSING_DOC);else{var r=JSON.parse(n.rows.item(0).metadata);t(null,r.rev_tree)}})})},S._doCompaction=function(e,t,n,i){k.transaction(function(s){var u="SELECT json AS metadata FROM "+c+" WHERE id = ?";s.executeSql(u,[e],function(s,u){if(!u.rows.length)return r.call(i);var a=JSON.parse(u.rows.item(0).metadata);a.rev_tree=t;var f="DELETE FROM "+h+" WHERE doc_id_rev IN ("+n.map(function(t){return o(e+"::"+t)}).join(",")+")";s.executeSql(f,[],function(t,n){var r="UPDATE "+c+" SET json = ? WHERE id = ?";t.executeSql(r,[JSON.stringify(a),e],function(e,t){i()})})})})}}var r=e("../utils"),i=e("../merge"),s=e("../deps/errors"),a=1,f=5242880,l=2,c=o("document-store"),h=o("by-sequence"),p=o("attach-store"),d=o("metadata-store"),v="CREATE INDEX IF NOT EXISTS 'by-seq-deleted-idx' ON "+h+" (seq, deleted)",m="CREATE INDEX IF NOT EXISTS 'doc-store-local-idx' ON "+c+" (local, id)",g="CREATE INDEX IF NOT EXISTS 'doc-winningseq-idx' ON "+c+" (winningseq)",y=[],b={};N.valid=function(){if(typeof n!="undefined"){if(n.navigator&&n.navigator.sqlitePlugin&&n.navigator.sqlitePlugin.openDatabase)return!0;if(n.sqlitePlugin&&n.sqlitePlugin.openDatabase)return!0;if(n.openDatabase)return!0}return!1},N.destroy=r.toPromise(function(e,t,i){var s=u(e,a,e,f);s.transaction(function(e){e.executeSql("DROP TABLE IF EXISTS "+c,[]),e.executeSql("DROP TABLE IF EXISTS "+h,[]),e.executeSql("DROP TABLE IF EXISTS "+p,[]),e.executeSql("DROP TABLE IF EXISTS "+d,[])},w(i),function(){r.hasLocalStorage()&&delete n.localStorage["_pouch__websqldb_"+e],i()})}),N.Changes=new r.Changes,t.exports=N}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"../deps/errors":8,"../merge":14,"../utils":18}],5:[function(e,t,n){(function(n){function u(e){e&&n.debug&&console.error(e)}function a(e,t,n){if(!(this instanceof a))return new a(e,t,n);var f=this;if(typeof t=="function"||typeof t=="undefined")n=t,t={};typeof e=="object"&&(t=e,e=undefined),typeof n=="undefined"&&(n=u),t=t||{};var l=n;f.auto_compaction=t.auto_compaction,f.prefix=a.prefix,r.call(f),f.taskqueue=new o;var c=new s(function(r,s){n=function(e,t){if(e)return s(e);delete t.then,r(t)},t=i.extend(!0,{},t);var o=t.name||e,u,l;(function(){try{if(typeof o!="string")throw l=new Error("Missing/invalid DB name"),l.code=400,l;u=a.parseAdapter(o),t.originalName=o,t.name=u.name,t.adapter=t.adapter||u.adapter;if(!a.adapters[t.adapter])throw l=new Error("Adapter is missing"),l.code=404,l;if(!a.adapters[t.adapter].valid())throw l=new Error("Invalid Adapter"),l.code=404,l}catch(e){f.taskqueue.fail(e),f.changes=i.toPromise(function(t){t.complete&&t.complete(e)})}})();if(l)return s(l);f.adapter=t.adapter,f.replicate=a.replicate.bind(f,f),f.replicate.from=function(e,t,n){return typeof t=="function"&&(n=t,t={}),a.replicate(e,f,t,n)},f.replicate.to=function(e,t,n){return typeof t=="function"&&(n=t,t={}),f.replicate(e,t,n)},f.replicate.sync=function(e,t,n){return typeof t=="function"&&(n=t,t={}),a.sync(f,e,t,n)},f.destroy=i.toPromise(function(e){var t=this;if(!t.taskqueue.isReady){t.taskqueue.addTask("destroy",arguments);return}t.info(function(t,n){if(t)return e(t);a.destroy(n.db_name,e)})}),a.adapters[t.adapter].call(f,t,function(e,r){function i(e){e==="destroyed"&&(f.emit("destroyed"),a.removeListener(t.name,i))}if(e){n&&(f.taskqueue.fail(e),n(e));return}a.on(t.name,i),f.emit("created",f),a.emit("created",t.originalName),f.taskqueue.ready(f),n(null,f)}),t.skipSetup&&f.taskqueue.ready(f),i.isCordova()&&cordova.fireWindowEvent(t.name+"_pouch",{})});c.then(function(e){l(null,e)},l),f.then=c.then.bind(c),function(){try{f.catch=c.catch.bind(c)}catch(e){}}()}var r=e("./adapter"),i=e("./utils"),s=typeof n.Promise=="function"?n.Promise:e("bluebird"),o=e("./taskqueue");i.inherits(a,r),t.exports=a}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"./adapter":1,"./taskqueue":17,"./utils":18,bluebird:24}],6:[function(e,t,n){(function(n){function a(e,t){function h(t,n,r){if(!e.binary&&!e.json&&e.processData&&typeof t!="string")t=JSON.stringify(t);else if(!e.binary&&e.json&&typeof t=="string")try{t=JSON.parse(t)}catch(i){return r(i)}Array.isArray(t)&&(t=t.map(function(e){var t;return e.ok?e:e.error&&e.error==="conflict"?(t=o.REV_CONFLICT,t.id=e.id,t):e.error&&e.error==="forbidden"?(t=o.FORBIDDEN,t.id=e.id,t.reason=e.reason,t):e.missing?(t=o.MISSING_DOC,t.missing=e.missing,t):e})),r(null,t,n)}function p(e,t){var n,r,i,s;try{n=JSON.parse(e.responseText);for(s in o)if(o.hasOwnProperty(s)&&o[s].name===n.error){i=o[s];break}i||(i=o.UNKNOWN_ERROR,e.status&&(i.status=e.status),e.statusText&&(e.name=e.statusText)),r=o.error(i,n.reason)}catch(u){for(var s in o)if(o.hasOwnProperty(s)&&o[s].status===e.status){i=o[s];break}i||(i=o.UNKNOWN_ERROR,e.status&&(i.status=e.status),e.statusText&&(e.name=e.statusText)),r=o.error(i)}t(r)}var a=!1,f=function(){if(a)return;t.apply(this,arguments),a=!0};typeof e=="function"&&(f=e,e={}),e=i(!0,{},e);var l={method:"GET",headers:{},json:!0,processData:!0,timeout:1e4,cache:!1};e=i(!0,l,e);if(e.method==="GET"&&!e.cache){var c=e.url.indexOf("?")!==-1;e.url+=(c?"&":"?")+"_nonce="+u(16)}if(n.browser){var d,v;e.xhr?v=new e.xhr:v=new XMLHttpRequest,v.open(e.method,e.url),v.withCredentials=!0,e.json&&(e.headers.Accept="application/json",e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.body&&e.processData&&typeof e.body!="string"&&(e.body=JSON.stringify(e.body))),e.binary&&(v.responseType="arraybuffer");var m=function(e,t,n){var r="";if(n){var i=new Date;i.setTime(i.getTime()+n*24*60*60*1e3),r="; expires="+i.toGMTString()}document.cookie=e+"="+t+r+"; path=/"};for(var g in e.headers)if(g==="Cookie"){var y=e.headers[g].split("=");m(y[0],y[1],10)}else v.setRequestHeader(g,e.headers[g]);"body"in e||(e.body=null);var b=function(){if(a)return;v.abort(),p(v,f)};return v.onreadystatechange=function(){if(v.readyState!==4||a)return;clearTimeout(d);if(v.status>=200&&v.status<300){var t;e.binary?t=s([v.response||""],{type:v.getResponseHeader("Content-Type")}):t=v.responseText,h(t,v,f)}else p(v,f)},e.timeout>0&&(d=setTimeout(b,e.timeout),v.onprogress=function(){clearTimeout(d),d=setTimeout(b,e.timeout)},v.upload&&(v.upload.onprogress=v.onprogress)),v.send(e.body),{abort:b}}return e.json&&(e.binary||(e.headers.Accept="application/json"),e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json"),e.binary&&(e.encoding=null,e.json=!1),e.processData||(e.json=!1),r(e,function(t,n,r){if(t)return t.status=n?n.statusCode:400,p(t,f);var i,s=n.headers["content-type"],u=r||"";!e.binary&&(e.json||!e.processData)&&typeof u!="object"&&(/json/.test(s)||/^[\s]*\{/.test(u)&&/\}[\s]*$/.test(u))&&(u=JSON.parse(u)),n.statusCode>=200&&n.statusCode<300?h(u,n,f):(e.binary&&(u=JSON.parse(u.toString())),u.reason==="missing"?i=o.MISSING_DOC:u.reason==="no_db_file"?i=o.error(o.DB_MISSING,u.reason):u.error==="conflict"?i=o.REV_CONFLICT:i=o.error(o.UNKNOWN_ERROR,u.reason,u.error),i.status=n.statusCode,f(i))})}var r=e("request"),i=e("./extend.js"),s=e("./blob.js"),o=e("./errors"),u=e("../deps/uuid");t.exports=a}).call(this,e("/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))},{"../deps/uuid":12,"./blob.js":7,"./errors":8,"./extend.js":10,"/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":22,request:20}],7:[function(e,t,n){(function(e){function n(t,n){t=t||[],n=n||{};try{return new Blob(t,n)}catch(r){if(r.name!=="TypeError")throw r;var i=e.BlobBuilder||e.MSBlobBuilder||e.MozBlobBuilder||e.WebKitBlobBuilder,s=new i;for(var o=0;o<t.length;o+=1)s.append(t[o]);return s.getBlob(n.type)}}t.exports=n}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{}],8:[function(e,t,n){function r(e){this.status=e.status,this.name=e.error,this.message=e.reason,this.error=!0}r.prototype__proto__=Error.prototype,r.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message})},n.UNAUTHORIZED=new r({status:401,error:"unauthorized",reason:"Name or password is incorrect."}),n.MISSING_BULK_DOCS=new r({status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"}),n.MISSING_DOC=new r({status:404,error:"not_found",reason:"missing"}),n.REV_CONFLICT=new r({status:409,error:"conflict",reason:"Document update conflict"}),n.INVALID_ID=new r({status:400,error:"invalid_id",reason:"_id field must contain a string"}),n.MISSING_ID=new r({status:412,error:"missing_id",reason:"_id is required for puts"}),n.RESERVED_ID=new r({status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."}),n.NOT_OPEN=new r({status:412,error:"precondition_failed",reason:"Database not open so cannot close"}),n.UNKNOWN_ERROR=new r({status:500,error:"unknown_error",reason:"Database encountered an unknown error"}),n.BAD_ARG=new r({status:500,error:"badarg",reason:"Some query argument is invalid"}),n.INVALID_REQUEST=new r({status:400,error:"invalid_request",reason:"Request was invalid"}),n.QUERY_PARSE_ERROR=new r({status:400,error:"query_parse_error",reason:"Some query parameter is invalid"}),n.DOC_VALIDATION=new r({status:500,error:"doc_validation",reason:"Bad special document member"}),n.BAD_REQUEST=new r({status:400,error:"bad_request",reason:"Something wrong with the request"}),n.NOT_AN_OBJECT=new r({status:400,error:"bad_request",reason:"Document must be a JSON object"}),n.DB_MISSING=new r({status:404,error:"not_found",reason:"Database not found"}),n.IDB_ERROR=new r({status:500,error:"indexed_db_went_bad",reason:"unknown"}),n.WSQ_ERROR=new r({status:500,error:"web_sql_went_bad",reason:"unknown"}),n.LDB_ERROR=new r({status:500,error:"levelDB_went_went_bad",reason:"unknown"}),n.FORBIDDEN=new r({status:403,error:"forbidden",reason:"Forbidden by design doc validate_doc_update function"}),n.error=function(e,t,n){function r(e){this.message=t,n&&(this.name=n)}return r.prototype=e,new r(t)}},{}],9:[function(e,t,n){Object.keys||(Object.keys=function(t){if(typeof t!="object"&&typeof t!="function"||t===null)throw new TypeError("Object.keys called on a non-object");var n=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&n.push(r);return n}),Array.isArray||(Array.isArray=function(t){return Object.prototype.toString.call(t)==="[object Array]"}),"forEach"in Array.prototype||(Array.prototype.forEach=function(e,t){for(var n=0,r=this.length;n<r;n++)n in this&&e.call(t,this[n],n,this)}),"map"in Array.prototype||(Array.prototype.map=function(e,t){var n=new Array(this.length);for(var r=0,i=this.length;r<i;r++)r in this&&(n[r]=e.call(t,this[r],r,this));return n})},{}],10:[function(e,t,n){function f(e){return e===null?String(e):typeof e=="object"||typeof e=="function"?r[u.call(e)]||"object":typeof e}function l(e){return e!==null&&e===e.window}function c(e){if(!e||f(e)!=="object"||e.nodeType||l(e))return!1;try{if(e.constructor&&!a.call(e,"constructor")&&!a.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}var n;for(n in e);return n===undefined||a.call(e,n)}function h(e){return f(e)==="function"}function d(){var e,t,n,r,i,s,o=arguments[0]||{},u=1,a=arguments.length,f=!1;typeof o=="boolean"&&(f=o,o=arguments[1]||{},u=2),typeof o!="object"&&!h(o)&&(o={}),a===u&&(o=this,--u);for(;u<a;u++)if((e=arguments[u])!=null)for(t in e)if(!(t in Object.prototype)){n=o[t],r=e[t];if(o===r)continue;f&&r&&(c(r)||(i=p(r)))?(i?(i=!1,s=n&&p(n)?n:[]):s=n&&c(n)?n:{},o[t]=d(f,s,r)):r!==undefined&&(!p(e)||!h(r))&&(o[t]=r)}return o}var r={},i=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"];for(var s=0;s<i.length;s++){var o=i[s];r["[object "+o+"]"]=o.toLowerCase()}var u=r.toString,a=r.hasOwnProperty,p=Array.isArray||function(e){return f(e)==="array"};t.exports=d},{}],11:[function(e,t,n){(function(t){var r=e("crypto");n.MD5=function(e){function n(e,t){return e<<t|e>>>32-t}function i(e,t){var n,r,i,s,o;return i=e&2147483648,s=t&2147483648,n=e&1073741824,r=t&1073741824,o=(e&1073741823)+(t&1073741823),n&r?o^2147483648^i^s:n|r?o&1073741824?o^3221225472^i^s:o^1073741824^i^s:o^i^s}function s(e,t,n){return e&t|~e&n}function o(e,t,n){return e&n|t&~n}function u(e,t,n){return e^t^n}function a(e,t,n){return t^(e|~n)}function f(e,t,r,o,u,a,f){return e=i(e,i(i(s(t,r,o),u),f)),i(n(e,a),t)}function l(e,t,r,s,u,a,f){return e=i(e,i(i(o(t,r,s),u),f)),i(n(e,a),t)}function c(e,t,r,s,o,a,f){return e=i(e,i(i(u(t,r,s),o),f)),i(n(e,a),t)}function h(e,t,r,s,o,u,f){return e=i(e,i(i(a(t,r,s),o),f)),i(n(e,u),t)}function p(e){var t,n=e.length,r=n+8,i=(r-r%64)/64,s=(i+1)*16,o=new Array(s-1),u=0,a=0;while(a<n)t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|e.charCodeAt(a)<<u,a++;return t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|128<<u,o[s-2]=n<<3,o[s-1]=n>>>29,o}function d(e){var t="",n="",r,i;for(i=0;i<=3;i++)r=e>>>i*8&255,n="0"+r.toString(16),t+=n.substr(n.length-2,2);return t}if(!t.browser)return r.createHash("md5").update(e).digest("hex");var v=[],m,g,y,b,w,E,S,x,T,N=7,C=12,k=17,L=22,A=5,O=9,M=14,_=20,D=4,P=11,H=16,B=23,j=6,F=10,I=15,q=21;v=p(e),E=1732584193,S=4023233417,x=2562383102,T=271733878;for(m=0;m<v.length;m+=16)g=E,y=S,b=x,w=T,E=f(E,S,x,T,v[m+0],N,3614090360),T=f(T,E,S,x,v[m+1],C,3905402710),x=f(x,T,E,S,v[m+2],k,606105819),S=f(S,x,T,E,v[m+3],L,3250441966),E=f(E,S,x,T,v[m+4],N,4118548399),T=f(T,E,S,x,v[m+5],C,1200080426),x=f(x,T,E,S,v[m+6],k,2821735955),S=f(S,x,T,E,v[m+7],L,4249261313),E=f(E,S,x,T,v[m+8],N,1770035416),T=f(T,E,S,x,v[m+9],C,2336552879),x=f(x,T,E,S,v[m+10],k,4294925233),S=f(S,x,T,E,v[m+11],L,2304563134),E=f(E,S,x,T,v[m+12],N,1804603682),T=f(T,E,S,x,v[m+13],C,4254626195),x=f(x,T,E,S,v[m+14],k,2792965006),S=f(S,x,T,E,v[m+15],L,1236535329),E=l(E,S,x,T,v[m+1],A,4129170786),T=l(T,E,S,x,v[m+6],O,3225465664),x=l(x,T,E,S,v[m+11],M,643717713),S=l(S,x,T,E,v[m+0],_,3921069994),E=l(E,S,x,T,v[m+5],A,3593408605),T=l(T,E,S,x,v[m+10],O,38016083),x=l(x,T,E,S,v[m+15],M,3634488961),S=l(S,x,T,E,v[m+4],_,3889429448),E=l(E,S,x,T,v[m+9],A,568446438),T=l(T,E,S,x,v[m+14],O,3275163606),x=l(x,T,E,S,v[m+3],M,4107603335),S=l(S,x,T,E,v[m+8],_,1163531501),E=l(E,S,x,T,v[m+13],A,2850285829),T=l(T,E,S,x,v[m+2],O,4243563512),x=l(x,T,E,S,v[m+7],M,1735328473),S=l(S,x,T,E,v[m+12],_,2368359562),E=c(E,S,x,T,v[m+5],D,4294588738),T=c(T,E,S,x,v[m+8],P,2272392833),x=c(x,T,E,S,v[m+11],H,1839030562),S=c(S,x,T,E,v[m+14],B,4259657740),E=c(E,S,x,T,v[m+1],D,2763975236),T=c(T,E,S,x,v[m+4],P,1272893353),x=c(x,T,E,S,v[m+7],H,4139469664),S=c(S,x,T,E,v[m+10],B,3200236656),E=c(E,S,x,T,v[m+13],D,681279174),T=c(T,E,S,x,v[m+0],P,3936430074),x=c(x,T,E,S,v[m+3],H,3572445317),S=c(S,x,T,E,v[m+6],B,76029189),E=c(E,S,x,T,v[m+9],D,3654602809),T=c(T,E,S,x,v[m+12],P,3873151461),x=c(x,T,E,S,v[m+15],H,530742520),S=c(S,x,T,E,v[m+2],B,3299628645),E=h(E,S,x,T,v[m+0],j,4096336452),T=h(T,E,S,x,v[m+7],F,1126891415),x=h(x,T,E,S,v[m+14],I,2878612391),S=h(S,x,T,E,v[m+5],q,4237533241),E=h(E,S,x,T,v[m+12],j,1700485571),T=h(T,E,S,x,v[m+3],F,2399980690),x=h(x,T,E,S,v[m+10],I,4293915773),S=h(S,x,T,E,v[m+1],q,2240044497),E=h(E,S,x,T,v[m+8],j,1873313359),T=h(T,E,S,x,v[m+15],F,4264355552),x=h(x,T,E,S,v[m+6],I,2734768916),S=h(S,x,T,E,v[m+13],q,1309151649),E=h(E,S,x,T,v[m+4],j,4149444226),T=h(T,E,S,x,v[m+11],F,3174756917),x=h(x,T,E,S,v[m+2],I,718787259),S=h(S,x,T,E,v[m+9],q,3951481745),E=i(E,g),S=i(S,y),x=i(x,b),T=i(T,w);var R=d(E)+d(S)+d(x)+d(T);return R.toLowerCase()}}).call(this,e("/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))},{"/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":22,crypto:20}],12:[function(e,t,n){function r(e,t){var n=r.CHARS,i=[],s;t=t||n.length;if(e)for(s=0;s<e;s++)i[s]=n[0|Math.random()*t];else{var o;i[8]=i[13]=i[18]=i[23]="-",i[14]="4";for(s=0;s<36;s++)i[s]||(o=0|Math.random()*16,i[s]=n[s===19?o&3|8:o])}return i.join("")}r.CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),t.exports=r},{}],13:[function(e,t,n){(function(n){e("./deps/es5_shims");var r=e("./setup");t.exports=r,r.ajax=e("./deps/ajax"),r.extend=e("./deps/extend"),r.utils=e("./utils"),r.Errors=e("./deps/errors");var i=e("./replicate");r.replicate=i.replicate,r.sync=i.sync,r.version=e("./version");var s=e("./adapters/http");r.adapter("http",s),r.adapter("https",s),r.adapter("idb",e("./adapters/idb")),r.adapter("websql",e("./adapters/websql")),r.plugin(e("pouchdb-mapreduce"));if(!n.browser){var o=e("./adapters/leveldb");r.adapter("ldb",o),r.adapter("leveldb",o)}}).call(this,e("/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))},{"./adapters/http":2,"./adapters/idb":3,"./adapters/leveldb":20,"./adapters/websql":4,"./deps/ajax":6,"./deps/errors":8,"./deps/es5_shims":9,"./deps/extend":10,"./replicate":15,"./setup":16,"./utils":18,"./version":19,"/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":22,"pouchdb-mapreduce":35}],14:[function(e,t,n){function i(e){var t=e.shift(),n=[t.id,t.opts,[]],r=n,i;while(e.length)t=e.shift(),i=[t.id,t.opts,[]],r[2].push(i),r=i;return n}function s(e,t){var n=[{tree1:e,tree2:t}],r=!1;while(n.length>0){var i=n.pop(),s=i.tree1,o=i.tree2;if(s[1].status||o[1].status)s[1].status=s[1].status==="available"||o[1].status==="available"?"available":"missing";for(var u=0;u<o[2].length;u++){if(!s[2][0]){r="new_leaf",s[2][0]=o[2][u];continue}var a=!1;for(var f=0;f<s[2].length;f++)s[2][f][0]===o[2][u][0]&&(n.push({tree1:s[2][f],tree2:o[2][u]}),a=!0);a||(r="new_branch",s[2].push(o[2][u]),s[2].sort())}}return{conflicts:r,tree:e}}function o(e,t,n){var r=[],i=!1,o=!1,u;return e.length?(e.forEach(function(e){if(e.pos===t.pos&&e.ids[0]===t.ids[0])u=s(e.ids,t.ids),r.push({pos:e.pos,ids:u.tree}),i=i||u.conflicts,o=!0;else if(n!==!0){var a=e.pos<t.pos?e:t,f=e.pos<t.pos?t:e,l=f.pos-a.pos,c=[],h=[];h.push({ids:a.ids,diff:l,parent:null,parentIdx:null});while(h.length>0){var p=h.pop();if(p.diff===0){p.ids[0]===f.ids[0]&&c.push(p);continue}if(!p.ids)continue;p.ids[2].forEach(function(e,t){h.push({ids:e,diff:p.diff-1,parent:p.ids,parentIdx:t})})}var d=c[0];d?(u=s(d.ids,f.ids),d.parent[2][d.parentIdx]=u.tree,r.push({pos:a.pos,ids:a.ids}),i=i||u.conflicts,o=!0):r.push(e)}else r.push(e)}),o||r.push(t),r.sort(function(e,t){return e.pos-t.pos}),{tree:r,conflicts:i||"internal_node"}):{tree:[t],conflicts:"new_leaf"}}function u(e,t){var n=a.rootToLeaf(e).map(function(e){var n=e.ids.slice(-t);return{pos:e.pos+(e.ids.length-n.length),ids:i(n)}});return n.reduce(function(e,t,n,r){return o(e,t,!0).tree},[n.shift()])}var r=e("./deps/extend"),a={};a.merge=function(e,t,n){e=r(!0,[],e),t=r(!0,{},t);var i=o(e,t);return{tree:u(i.tree,n),conflicts:i.conflicts}},a.winningRev=function(e){var t=[];return a.traverseRevTree(e.rev_tree,function(e,n,r,i,s){e&&t.push({pos:n,id:r,deleted:!!s.deleted})}),t.sort(function(e,t){return e.deleted!==t.deleted?e.deleted>t.deleted?1:-1:e.pos!==t.pos?t.pos-e.pos:e.id<t.id?1:-1}),t[0].pos+"-"+t[0].id},a.traverseRevTree=function(e,t){var n=[];e.forEach(function(e){n.push({pos:e.pos,ids:e.ids})});while(n.length>0){var r=n.pop(),i=r.pos,s=r.ids,o=t(s[2].length===0,i,s[0],r.ctx,s[1]);s[2].forEach(function(e){n.push({pos:i+1,ids:e,ctx:o})})}},a.collectLeaves=function(e){var t=[];return a.traverseRevTree(e,function(e,n,r,i,s){e&&t.unshift({rev:n+"-"+r,pos:n,opts:s})}),t.sort(function(e,t){return t.pos-e.pos}),t.map(function(e){delete e.pos}),t},a.collectConflicts=function(e){var t=a.winningRev(e),n=a.collectLeaves(e.rev_tree),r=[];return n.forEach(function(e){e.rev!==t&&!e.opts.deleted&&r.push(e.rev)}),r},a.rootToLeaf=function(e){var t=[];return a.traverseRevTree(e,function(e,n,r,i,s){i=i?i.slice(0):[],i.push({id:r,opts:s});if(e){var o=n+1-i.length;t.unshift({pos:o,ids:i})}return i}),t},t.exports=a},{"./deps/extend":10}],15:[function(e,t,n){function s(){var e=this;this.cancelled=!1,this.cancel=function(){e.cancelled=!0}}function o(){this.seq=0,this.state="start",this.changes=[],this.docs=[]}function u(e,t,n,i){var s=n.filter?n.filter.toString():"";e.id(function(e,o){t.id(function(e,t){var u=o+t+s+JSON.stringify(n.query_params);i("_local/"+r.Crypto.MD5(u))})})}function a(e,t,n,r){t.get(n,function(t,i){t&&t.status===404?r(null,0):t?r(t):e.get(n,function(e,t){e&&e.status===404||!e&&i.last_seq!==t.last_seq?r(null,0):e?r(e):r(null,t.last_seq)})})}function f(e,t,n,r,i){function s(e,t){e.get(n,function(i,s){if(i&&i.status===404)s={_id:n};else if(i)return t(i);s.last_seq=r,e.put(s,t)})}s(t,function(t,n){if(t)return i(t);s(e,function(e,t){if(e)return i(e);i()})})}function l(e,t,n,i,s){function b(){if(u[0].docs.length===0)return x();var e=u[0].docs;n.bulkDocs({docs:e},{new_edits:!1},function(t,n){if(t)return S("target.bulkDocs completed with error",t);y.docs_written+=e.length,x()})}function w(e,t){if(s.cancelled)return L();if(e)return S("src.get completed with error",e);Object.keys(t).forEach(function(e){var n=t[e].ok;n&&(y.docs_read++,u[0].pendingRevs++,u[0].docs.push(n))}),E()}function E(){var e=u[0].diffs;if(Object.keys(e).length===0){b();return}var n=Object.keys(e)[0],r=e[n].missing;delete e[n],t.get(n,{revs:!0,open_revs:r,attachments:!0},w)}function S(e,t){if(p)return;y.ok=!1,y.status="aborted",y.errors.push(t),y.end_time=new Date,y.last_seq=d,u=[],l=new o;var n={status:500,error:"Replication aborted",reason:e,details:t};p=!0,r.call(i.complete,n,y),s.cancel()}function x(){c=!0,f(t,n,e,u[0].seq,function(e,t){c=!1;if(s.cancelled)return L();if(e)return S("writeCheckpoint completed with error",e);d=u[0].seq,y.last_seq=d,r.call(i.onChange,null,y),u.shift(),C()})}function T(e,t){if(s.cancelled)return L();if(e)return S("target.revsDiff completed with error",e);if(Object.keys(t).length===0){x();return}u[0].diffs=t,u[0].pendingRevs=0,E()}function N(){var e={};u[0].changes.forEach(function(t){e[t.id]=t.changes.map(function(e){return e.rev})}),n.revsDiff(e,T)}function C(){if(s.cancelled)return L();if(u.length===0){k();return}u[0].state==="start"&&(u[0].state="processing",N())}function k(){if(l.changes.length===0){h&&u.length===0&&A();return}if(h||l.changes.length>=m)u.push(l),l=new o,C()}function L(){y.status="cancelled",c||A()}function A(){if(p)return;return y.status=y.status||"complete",y.end_time=new Date,y.last_seq=d,p=!0,r.call(i.complete,null,y)}function O(e){if(s.cancelled)return L();if(p)return;l.seq=e.seq,l.changes.push(e),k()}function M(e,t){h=!0;if(s.cancelled)return L();if(e)return S("src.changes completed with error",e);k()}function _(){a(t,n,e,function(e,n){if(e)return S("fetchCheckpoint completed with error",e);d=n;if(s.cancelled)return L();var r={continuous:v,since:d,style:"all_docs",onChange:O,complete:M,doc_ids:g};i.filter&&(r.filter=i.filter),i.query_params&&(r.query_params=i.query_params);var o=t.changes(r),u=s.cancel;s.cancel=function(){u(),L(),o&&o.cancel instanceof Function&&o.cancel()}})}var u=[],l=new o,c=!1,h=!1,p=!1,d=0,v=i.continuous||i.live||!1,m=i.batch_size||1,g=i.doc_ids,y={ok:!0,start_time:new Date,docs_read:0,docs_written:0,errors:[]};typeof i.since=="undefined"?_():f(t,n,e,i.since,function(e,t){if(e)return S("writeCheckpoint completed with error",e);d=i.since,_()})}function c(e,t){if(typeof e=="string")return new i(e,t);t(null,e)}function h(e,t,n,i){n instanceof Function&&(i=n,n={}),n===undefined&&(n={}),n.complete||(n.complete=i),n=r.extend(!0,{},n),n.continuous=n.continuous||n.live;var o=new s;return c(e,function(e,r){if(e)return i(e);c(t,function(e,t){if(e)return i(e);if(n.server){if(typeof r.replicateOnServer!="function")return i({error:"Server replication not supported for "+r.type()+"adapter"});if(r.type()!==t.type())return i({error:"Server replication for different adapter types ("+r.type()+" and "+t.type()+") is not supported"});r.replicateOnServer(t,n,o)}else u(r,t,n,function(e){l(e,r,t,n,o)})})}),o}function p(e,t,n,i){function u(e,t){return function(n,r){n&&p(),r.direction=t,e(n,r)}}function a(e,t){return t=t||function(){},function(n){return{source:e,change:t(n)}}}function f(e,t,n){return t=r.extend(!0,{},t),t.complete=u(t.complete,n),t.onChange=a(e,t.onChange),t.continuous=t.continuous||t.live,t}function l(){return s=h(e,t,f(e,n,"push"),i),s}function c(){return o=h(t,e,f(t,n,"pull"),i),o}function p(){s&&s.cancel(),o&&o.cancel()}var s,o;return n instanceof Function&&(i=n,n={}),n===undefined&&(n={}),i instanceof Function&&!n.complete&&(n.complete=i),{push:l(),pull:c(),cancel:p}}var r=e("./utils"),i=e("./index");n.replicate=h,n.sync=p},{"./index":13,"./utils":18}],16:[function(e,t,n){(function(n){var r=e("./constructor"),i=e("./utils"),s=e("events").EventEmitter;r.adapters={},r.prefix="_pouch_";var o=new s,u=["on","addListener","emit","listeners","once","removeAllListeners","removeListener","setMaxListeners"],a=["idb","leveldb","websql"];u.forEach(function(e){r[e]=o[e].bind(o)}),r.setMaxListeners(0),r.parseAdapter=function(e){var t=e.match(/([a-z\-]*):\/\/(.*)/),s;if(t){e=/http(s?)/.test(t[1])?t[1]+"://"+t[2]:t[2],s=t[1];if(!r.adapters[s].valid())throw"Invalid adapter";return{name:e,adapter:t[1]}}var o="idb"in r.adapters&&"websql"in r.adapters&&i.hasLocalStorage()&&n.localStorage["_pouch__websqldb_"+r.prefix+e];for(var u=0;u<a.length;++u){var f=a[u];if(f in r.adapters){if(o&&f==="idb")continue;s=r.adapters[f];var l="use_prefix"in s?s.use_prefix:!0;return{name:l?r.prefix+e:e,adapter:f}}}throw"No valid adapter found"},r.destroy=i.toPromise(function(e,t,n){if(typeof t=="function"||typeof t=="undefined")n=t,t={};typeof e=="object"&&(t=e,e=undefined);var i=r.parseAdapter(t.name||e),s=i.name;r.adapters[i.adapter].destroy(s,t,function(e,t){e?n(e):(r.emit("destroyed",s),r.emit(s,"destroyed"),n(null,t))})}),r.allDbs=i.toPromise(function(e){var t=new Error("allDbs method removed");t.stats="400",e(t)}),r.adapter=function(e,t){t.valid()&&(r.adapters[e]=t)},r.plugin=function(e){Object.keys(e).forEach(function(t){r.prototype[t]=e[t]})},t.exports=r}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"./constructor":5,"./utils":18,events:21}],17:[function(e,t,n){function r(){this.isReady=!1,this.failed=!1,this.queue=[]}t.exports=r,r.prototype.execute=function(){var e,t;if(this.failed)while(e=this.queue.shift())t=e.parameters[e.parameters.length-1],typeof t=="function"?t(this.failed):e.name==="changes"&&typeof t.complete=="function"&&t.complete(this.failed);else if(this.isReady)while(e=this.queue.shift())e.task=this.db[e.name].apply(this.db,e.parameters)},r.prototype.fail=function(e){this.failed=e,this.execute()},r.prototype.ready=function(e){if(this.failed)return!1;if(arguments.length===0)return this.isReady;this.isReady=e?!0:!1,this.db=e,this.execute()},r.prototype.addTask=function(e,t){var n={name:e,parameters:t};return this.queue.push(n),this.failed&&this.execute(),n}},{}],18:[function(e,t,n){(function(t,r){function c(){return typeof chrome!="undefined"&&typeof chrome.storage!="undefined"&&typeof chrome.storage.local!="undefined"}var i=e("./merge");n.extend=e("./deps/extend"),n.ajax=e("./deps/ajax"),n.createBlob=e("./deps/blob");var s=e("./deps/uuid");n.Crypto=e("./deps/md5.js");var o=e("./deps/buffer"),u=e("./deps/errors"),a=e("events").EventEmitter,f=typeof r.Promise=="function"?r.Promise:e("bluebird"),l=["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree"];n.inherits=e("inherits"),n.uuids=function(e,t){typeof t!="object"&&(t={});var n=t.length,r=t.radix,i=[];while(i.push(s(n,r))<e);return i},n.uuid=function(e){return n.uuids(1,e)[0]},n.invalidIdError=function(e){if(!e)return u.MISSING_ID;if(typeof e!="string")return u.INVALID_ID;if(/^_/.test(e)&&!/^_(design|local)/.test(e))return u.RESERVED_ID},n.call=function(e){if(typeof e==typeof Function){var t=Array.prototype.slice.call(arguments,1);e.apply(this,t)}},n.isLocalId=function(e){return/^_local/.test(e)},n.isDeleted=function(e,t){t||(t=i.winningRev(e)),t.indexOf("-")>=0&&(t=t.split("-")[1]);var n=!1;return i.traverseRevTree(e.rev_tree,function(e,r,i,s,o){i===t&&(n=!!o.deleted)}),n},n.filterChange=function(e){return function(t){var n={},r=e.filter&&typeof e.filter=="function";n.query=e.query_params;if(e.filter&&r&&!e.filter.call(this,t.doc,n))return!1;if(e.doc_ids&&e.doc_ids.indexOf(t.id)===-1)return!1;if(!e.include_docs)delete t.doc;else for(var i in t.doc._attachments)t.doc._attachments.hasOwnProperty(i)&&(t.doc._attachments[i].stub=!0);return!0}},n.processChanges=function(e,t,r){t=t.filter(n.filterChange(e)),e.limit&&e.limit<t.length&&(t.length=e.limit),t.forEach(function(t){n.call(e.onChange,t)}),e.continuous||n.call(e.complete,null,{results:t,last_seq:r})},n.parseDoc=function(e,t){var r=null,i,s,o,a={status:"available"};e._deleted&&(a.deleted=!0);if(t){e._id||(e._id=n.uuid()),s=n.uuid({length:32,radix:16}).toLowerCase();if(e._rev){o=/^(\d+)-(.+)$/.exec(e._rev);if(!o)throw"invalid value for property '_rev'";e._rev_tree=[{pos:parseInt(o[1],10),ids:[o[2],{status:"missing"},[[s,a,[]]]]}],i=parseInt(o[1],10)+1}else e._rev_tree=[{pos:1,ids:[s,a,[]]}],i=1}else{e._revisions&&(e._rev_tree=[{pos:e._revisions.start-e._revisions.ids.length+1,ids:e._revisions.ids.reduce(function(e,t){return e===null?[t,a,[]]:[t,{status:"missing"},[e]]},null)}],i=e._revisions.start,s=e._revisions.ids[0]);if(!e._rev_tree){o=/^(\d+)-(.+)$/.exec(e._rev);if(!o)return u.BAD_ARG;i=parseInt(o[1],10),s=o[2],e._rev_tree=[{pos:parseInt(o[1],10),ids:[o[2],a,[]]}]}}r=n.invalidIdError(e._id);for(var f in e)e.hasOwnProperty(f)&&f[0]==="_"&&l.indexOf(f)===-1&&(r=n.extend({},u.DOC_VALIDATION),r.reason+=": "+f);return e._id=decodeURIComponent(e._id),e._rev=[i,s].join("-"),r?r:Object.keys(e).reduce(function(t,n){return/^_/.test(n)&&n!=="_attachments"?t.metadata[n.slice(1)]=e[n]:t.data[n]=e[n],t},{metadata:{},data:{}})},n.isCordova=function(){return typeof cordova!="undefined"||typeof PhoneGap!="undefined"||typeof phonegap!="undefined"},n.hasLocalStorage=function(){try{return r.localStorage}catch(e){return!1}},n.Changes=function(){var e={},t=new a,i=c(),s={},o=!1;return i||(o=n.hasLocalStorage()),i?chrome.storage.onChanged.addListener(function(e){e.db_name!=null&&t.emit(e.dbName.newValue)}):o&&r.addEventListener("storage",function(e){t.emit(e.key)}),e.addListener=function(e,r,i,o){function u(){i.changes({include_docs:o.include_docs,conflicts:o.conflicts,continuous:!1,descending:!1,filter:o.filter,view:o.view,since:o.since,query_params:o.query_params,onChange:function(e){e.seq>o.since&&!o.cancelled&&(o.since=e.seq,n.call(o.onChange,e))}})}if(s[r])return;s[r]=u,t.on(e,u)},e.removeListener=function(e,n){if(!(n in s))return;t.removeListener(e,s[n])},e.clearListeners=function(e){t.removeAllListeners(e)},e.notifyLocalWindows=function(e){i?chrome.storage.local.set({dbName:e}):o&&(localStorage[e]=localStorage[e]==="a"?"b":"a")},e.notify=function(e){t.emit(e)},e},!!t.browser&&"atob"in r?n.atob=function(e){return atob(e)}:n.atob=function(e){var t=new o(e,"base64");if(t.toString("base64")!==e)throw"Cannot base64 encode full string";return t.toString("binary")},!!t.browser&&"btoa"in r?n.btoa=function(e){return btoa(e)}:n.btoa=function(e){return(new o(e,"binary")).toString("base64")},n.fixBinary=function(e){if(!t.browser)return e;var n=e.length,r=new ArrayBuffer(n),i=new Uint8Array(r);for(var s=0;s<n;s++)i[s]=e.charCodeAt(s);return r},n.once=function(e){var t=!1;return function(){if(t)throw console.trace(),new Error("once called  more than once");t=!0,e.apply(this,arguments)}},n.toPromise=function(e,r){return function(){var i=this,s=Array.prototype.slice.call(arguments),o=typeof s[s.length-1]=="function"?s.pop():!1,u;o&&(u=function(e,n){t.nextTick(function(){o(e,n)})});var a=new f(function(o,u){try{var f=n.once(function(e,t){e?u(e):o(t)});r?t.nextTick(function(){s.push(a),s.push(f),e.apply(i,s)}):(s.push(f),e.apply(i,s))}catch(l){u(l)}});return u&&a.then(function(e){u(null,e)},u),a.cancel=function(){return this},a}}}).call(this,e("/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"),typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"./deps/ajax":6,"./deps/blob":7,"./deps/buffer":20,"./deps/errors":8,"./deps/extend":10,"./deps/md5.js":11,"./deps/uuid":12,"./merge":14,"/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":22,bluebird:24,events:21,inherits:23}],19:[function(e,t,n){t.exports=e("../package.json").version},{"../package.json":37}],20:[function(e,t,n){},{}],21:[function(e,t,n){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||undefined}function i(e){return typeof e=="function"}function s(e){return typeof e=="number"}function o(e){return typeof e=="object"&&e!==null}function u(e){return e===void 0}t.exports=r,r.EventEmitter=r,r.prototype._events=undefined,r.prototype._maxListeners=undefined,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if(!s(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,n,r,s,a,f;this._events||(this._events={});if(e==="error")if(!this._events.error||o(this._events.error)&&!this._events.error.length)throw t=arguments[1],t instanceof Error?t:TypeError('Uncaught, unspecified "error" event.');n=this._events[e];if(u(n))return!1;if(i(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:r=arguments.length,s=new Array(r-1);for(a=1;a<r;a++)s[a-1]=arguments[a];n.apply(this,s)}else if(o(n)){r=arguments.length,s=new Array(r-1);for(a=1;a<r;a++)s[a-1]=arguments[a];f=n.slice(),r=f.length;for(a=0;a<r;a++)f[a].apply(this,s)}return!0},r.prototype.addListener=function(e,t){var n;if(!i(t))throw TypeError("listener must be a function");this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,i(t.listener)?t.listener:t),this._events[e]?o(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t;if(o(this._events[e])&&!this._events[e].warned){var n;u(this._maxListeners)?n=r.defaultMaxListeners:n=this._maxListeners,n&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),console.trace())}return this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function r(){this.removeListener(e,r),n||(n=!0,t.apply(this,arguments))}if(!i(t))throw TypeError("listener must be a function");var n=!1;return r.listener=t,this.on(e,r),this},r.prototype.removeListener=function(e,t){var n,r,s,u;if(!i(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;n=this._events[e],s=n.length,r=-1;if(n===t||i(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(o(n)){for(u=s;u-->0;)if(n[u]===t||n[u].listener&&n[u].listener===t){r=u;break}if(r<0)return this;n.length===1?(n.length=0,delete this._events[e]):n.splice(r,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[e]&&delete this._events[e],this;if(arguments.length===0){for(t in this._events){if(t==="removeListener")continue;this.removeAllListeners(t)}return this.removeAllListeners("removeListener"),this._events={},this}n=this._events[e];if(i(n))this.removeListener(e,n);else while(n.length)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){var t;return!this._events||!this._events[e]?t=[]:i(this._events[e])?t=[this._events[e]]:t=this._events[e].slice(),t},r.listenerCount=function(e,t){var n;return!e._events||!e._events[t]?n=0:i(e._events[t])?n=1:n=e._events[t].length,n}},{}],22:[function(e,t,n){var r=t.exports={};r.nextTick=function(){var e=typeof window!="undefined"&&window.setImmediate,t=typeof window!="undefined"&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};if(t){var n=[];return window.addEventListener("message",function(e){var t=e.source;if((t===window||t===null)&&e.data==="process-tick"){e.stopPropagation();if(n.length>0){var r=n.shift();r()}}},!0),function(t){n.push(t),window.postMessage("process-tick","*")}}return function(t){setTimeout(t,0)}}(),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")}},{}],23:[function(e,t,n){typeof Object.create=="function"?t.exports=function(t,n){t.super_=n,t.prototype=Object.create(n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(t,n){t.super_=n;var r=function(){};r.prototype=n.prototype,t.prototype=new r,t.prototype.constructor=t}},{}],24:[function(e,t,n){function s(e,t,n){i?Object.defineProperty(e,t,{value:n,configurable:!0,writable:!0}):e[t]=n}function o(e){if(!(this instanceof o))return new o(e);s(this,"successQueue",[]),s(this,"failureQueue",[]),s(this,"resolved",!1),typeof e=="function"&&this.resolvePassed(e)}function u(e,t,n){n&&typeof n.then=="function"?n.then(e,t):e(n)}function a(e,t,n){function i(){var i=arguments[n];return typeof i!="function"?e:new o(function(e,n){r(f,i,t,e,n)})}return i}function f(e,t,n,r){try{u(n,r,e(t))}catch(i){r(i)}}var r=e("immediate"),i=!1;(function(){try{Object.defineProperty({},"test",{value:!0}),i=!0}catch(e){}})(),s(o.prototype,"resolvePassed",function(e){try{e(this.fulfillUnwrap.bind(this),this.reject.bind(this))}catch(t){this.reject(t)}}),s(o.prototype,"reject",function(e){this.resolve(!1,e)}),s(o.prototype,"fulfill",function(e){this.resolve(!0,e)}),s(o.prototype,"fulfillUnwrap",function(e){u(this.fulfill.bind(this),this.reject.bind(this),e)}),o.prototype.then=function(e,t){return this.resolved?this.resolved(e,t):this.pending(e,t)},function(){try{o.prototype.catch=function(e){return this.then(null,e)}}catch(e){}}(),s(o.prototype,"pending",function(e,t){var n=this;return new o(function(r,i){typeof e=="function"?n.successQueue.push({resolve:r,reject:i,callback:e}):n.successQueue.push({next:r,callback:!1}),typeof t=="function"?n.failureQueue.push({resolve:r,reject:i,callback:t}):n.failureQueue.push({next:i,callback:!1})})}),s(o.prototype,"resolve",function(e,t){if(this.resolved)return;this.resolved=a(this,t,e?0:1);var n=e?this.successQueue:this.failureQueue,i=n.length,s=-1;while(++s<i)n[s].callback?r(f,n[s].callback,t,n[s].resolve,n[s].reject):n[s].next(t)}),t.exports=o},{immediate:27}],25:[function(e,t,n){n.test=function(){return!1}},{}],26:[function(e,t,n){(function(e){t.exports=typeof e=="object"&&e?e:this}).call(this,typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{}],27:[function(e,t,n){function s(){var e=0,t,n=i;i=[];while(t=n[e++])t()}var r=[e("./nextTick"),e("./mutation"),e("./realSetImmediate"),e("./postMessage"),e("./messageChannel"),e("./stateChange"),e("./timeout")],i=[],o,u=-1,a=r.length;while(++u<a)if(r[u].test()){o=r[u].install(s);break}var f=function(e){var t,n,r=e;return arguments.length>1&&typeof e=="function"&&(n=Array.prototype.slice.call(arguments,1),r=function(){e.apply(undefined,n)}),(t=i.push(r))===1&&o(s),t};f.clear=function(e){return e<=i.length&&(i[e-1]=function(){}),this},t.exports=f},{"./messageChannel":28,"./mutation":29,"./nextTick":25,"./postMessage":30,"./realSetImmediate":31,"./stateChange":32,"./timeout":33}],28:[function(e,t,n){var r=e("./global");n.test=function(){return!!r.MessageChannel},n.install=function(e){var t=new r.MessageChannel;return t.port1.onmessage=e,function(){t.port2.postMessage(0)}}},{"./global":26}],29:[function(e,t,n){var r=e("./global"),i=r.MutationObserver||r.WebKitMutationObserver;n.test=function(){return i},n.install=function(e){var t=new i(e),n=r.document.createElement("div");return t.observe(n,{attributes:!0}),r.addEventListener("unload",function(){t.disconnect(),t=null},!1),function(){n.setAttribute("drainQueue","drainQueue")}}},{"./global":26}],30:[function(e,t,n){var r=e("./global");n.test=function(){if(!r.postMessage||r.importScripts)return!1;var e=!0,t=r.onmessage;return r.onmessage=function(){e=!1},r.postMessage("","*"),r.onmessage=t,e},n.install=function(e){function n(n){n.source===r&&n.data===t&&e()}var t="com.calvinmetcalf.setImmediate"+Math.random();return r.addEventListener?r.addEventListener("message",n,!1):r.attachEvent("onmessage",n),function(){r.postMessage(t,"*")}}},{"./global":26}],31:[function(e,t,n){var r=e("./global");n.test=function(){return r.setImmediate},n.install=function(e){return r.setTimeout.bind(r,e,0)}},{"./global":26}],32:[function(e,t,n){var r=e("./global");n.test=function(){return"document"in r&&"onreadystatechange"in r.document.createElement("script")},n.install=function(e){return function(){var t=r.document.createElement("script");return t.onreadystatechange=function(){e(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},r.document.documentElement.appendChild(t),e}}},{"./global":26}],33:[function(e,t,n){n.test=function(){return!0},n.install=function(e){return function(){setTimeout(e,0)}}},{}],34:[function(_dereq_,module,exports){module.exports=function(func,emit,sum,log,isArray,toJSON){return eval(" ("+func+");")}},{}],35:[function(e,t,n){(function(t,r){function l(e){var t={};for(var n=0,r=e.length;n<r;n++){var i=f(e[n]),s=t[i];typeof s=="undefined"?t[i]=n:typeof s=="number"?t[i]=[s,n]:s.push(n)}return t}function c(e,t){var n=o(e.id,t.id);return n!==0?n:o(e.value,t.value)}function h(e,t,n){var r=n[e];typeof r=="undefined"?n[e]=t:Array.isArray(r)?r.push(t):n[e]=[r,t]}function p(e){return e.reduce(function(e,t){return e+t},0)}function v(e,t,n,r){var i=t[e];typeof i!="undefined"&&(r&&(i=encodeURIComponent(JSON.stringify(i))),n.push(e+"="+i))}function m(e,t,n){var r=new Array(t.length);e.forEach(function(e){var t=n[f(e.key)];typeof t=="number"?h(t,e,r):t.forEach(function(t){h(t,e,r)})});var i=[];return r.forEach(function(e){Array.isArray(e)?i=i.concat(e.sort(c)):i.push(e)}),i}function g(e,t,n){function g(t,r){var u={id:s.doc._id,key:t,value:r};if(typeof n.startkey!="undefined"&&o(t,n.startkey)<0)return;if(typeof n.endkey!="undefined"&&o(t,n.endkey)>0)return;if(typeof n.key!="undefined"&&o(t,n.key)!==0)return;if(typeof n.keys!="undefined"){v=v||l(n.keys);if(typeof v[f(t)]=="undefined")return}c++;if(n.include_docs){if(r&&typeof r=="object"&&r._id){e.get(r._id,function(e,t){t&&(u.doc=t),i.push(u),y()});return}u.doc=s.doc}i.push(u)}function y(){var e;if(h&&i.length===c){typeof n.keys!="undefined"&&i.length?i=m(i,n.keys,v):i.sort(function(e,t){var n=o(e.key,t.key);return n!==0?n:o(e.id,t.id)}),n.descending&&i.reverse();if(n.reduce===!1)return n.complete(null,{total_rows:i.length,offset:n.skip,rows:"limit"in n?i.slice(n.skip,n.limit+n.skip):n.skip>0?i.slice(n.skip):i});var r=[];i.forEach(function(e){var t=r[r.length-1];if(t&&o(t.key[0][0],e.key)===0){t.key.push([e.key,e.id]),t.value.push(e.value);return}r.push({key:[[e.key,e.id]],value:[e.value]})}),r.forEach(function(n){n.value=t.reduce.call(null,n.key,n.value);if(n.value.sumsqr&&n.value.sumsqr instanceof Error){e=n.value;return}n.key=n.key[0][0]});if(e){n.complete(e);return}n.complete(null,{total_rows:r.length,offset:n.skip,rows:"limit"in n?r.slice(n.skip,n.limit+n.skip):n.skip>0?r.slice(n.skip):r})}}var r;n.skip||(n.skip=0),t.reduce||(n.reduce=!1);var i=[],s,c=0,h=!1,v;typeof t.map=="function"&&t.map.length===2?(r=t.map,t.map=function(e){return r(e,g)}):t.map=u(t.map.toString(),g,p,a,Array.isArray,JSON.parse),t.reduce&&(d[t.reduce]?t.reduce=d[t.reduce]:t.reduce=u(t.reduce.toString(),g,p,a,Array.isArray,JSON.parse)),e.changes({conflicts:!0,include_docs:!0,onChange:function(e){!("deleted"in e)&&e.id[0]!=="_"&&(s={doc:e.doc},t.map.call(null,e.doc))},complete:function(){h=!0,y()}})}function y(e,t,n){var r=n.complete,i=[],s,o="GET";v("reduce",n,i),v("include_docs",n,i),v("limit",n,i),v("descending",n,i),v("group",n,i),v("group_level",n,i),v("skip",n,i),v("startkey",n,i,!0),v("endkey",n,i,!0),v("key",n,i,!0),typeof n.keys!="undefined"&&(o="POST",typeof t=="string"?s=JSON.stringify({keys:n.keys}):t.keys=n.keys),i=i.join("&"),i=i===""?"":"?"+i;if(typeof t=="string"){var u=t.split("/");e.request({method:o,url:"_design/"+u[0]+"/_view/"+u[1]+i,body:s},r);return}var a=JSON.parse(JSON.stringify(t,function(e,t){return typeof t=="function"?t+"":t}));e.request({method:"POST",url:"_temp_view"+i,body:a},r)}var i=e("pouchdb-collate"),s=typeof r.Promise=="function"?r.Promise:e("lie"),o=i.collate,u=e("./evalfunc"),a=typeof console!="undefined"?Function.prototype.bind.call(console.log,console):function(){},f=function(e){return JSON.stringify(i.normalizeKey(e))},d={_sum:function(e,t){return p(t)},_count:function(e,t,n){return t.length},_stats:function(e,t){return{sum:p(t),min:Math.min.apply(null,t),max:Math.max.apply(null,t),count:t.length,sumsqr:function(){var e=0,n;for(var r in t){if(typeof t[r]!="number")return n=new Error("builtin _stats function requires map values to be numbers"),n.name="invalid_value",n.status=500,n;e+=t[r]*t[r]}return e}()}}};n.query=function(e,n,r){var i=this;typeof n=="function"&&(r=n,n={}),n=n||{},r&&(n.complete=r);var o=n.complete,u;n.complete&&(u=function(e,n){t.nextTick(function(){o(e,n)})});var a=new s(function(t,r){n.complete=function(e,n){e?r(e):t(n)};if(i.type()==="http")return typeof e=="function"?y(i,{map:e},n):y(i,e,n);if(typeof e=="object")return g(i,e,n);if(typeof e=="function")return g(i,{map:e},n);var s=e.split("/");i.get("_design/"+s[0],function(e,t){if(e){n.complete(e);return}if(!t.views[s[1]]){n.complete({name:"not_found",message:"missing_named_view"});return}g(i,{map:t.views[s[1]].map,reduce:t.views[s[1]].reduce},n)})});return u&&a.then(function(e){u(null,e)},u),a}}).call(this,e("/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"),typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"./evalfunc":34,"/home/calvin/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":22,lie:24,"pouchdb-collate":36}],36:[function(e,t,n){function r(e,t){var r=Math.min(e.length,t.length);for(var i=0;i<r;i++){var s=n.collate(e[i],t[i]);if(s!==0)return s}return e.length===t.length?0:e.length>t.length?1:-1}function i(e,t){return e===t?0:e>t?1:-1}function s(e,t){var r=Object.keys(e),i=Object.keys(t),s=Math.min(r.length,i.length);for(var o=0;o<s;o++){var u=n.collate(r[o],i[o]);if(u!==0)return u;u=n.collate(e[r[o]],t[i[o]]);if(u!==0)return u}return r.length===i.length?0:r.length>i.length?1:-1}function o(e){var t=["boolean","number","string","object"];if(t.indexOf(typeof e)!==-1)return e===null?1:t.indexOf(typeof e)+2;if(Array.isArray(e))return 4.5}n.collate=function(e,t){e=n.normalizeKey(e),t=n.normalizeKey(t);var u=o(e),a=o(t);if(u-a!==0)return u-a;if(e===null)return 0;if(typeof e=="number")return e-t;if(typeof e=="boolean")return e===t?0:e<t?-1:1;if(typeof e=="string")return i(e,t);if(Array.isArray(e))return r(e,t);if(typeof e=="object")return s(e,t)},n.normalizeKey=function(e){if(typeof e=="undefined")return null;if(typeof e=="number"){if(e===Infinity||e===-Infinity||isNaN(e))return null}else if(e instanceof Date)return e.toJSON();return e}},{}],37:[function(e,t,n){t.exports={name:"pouchdb",version:"2.0.1-alpha",description:"PouchDB is a pocket-sized database.",release:"nightly",main:"./lib/index.js",homepage:"https://github.com/daleharvey/pouchdb",repository:"https://github.com/daleharvey/pouchdb",keywords:["db","couchdb","pouchdb"],tags:["db","couchdb","pouchdb"],dependencies:{bluebird:"~1.0.0",inherits:"~2.0.1","level-sublevel":"~5.2.0",leveldown:"~0.10.2",levelup:"~0.18.2",lie:"^2.5.3","pouchdb-mapreduce":"1.0.0",request:"~2.28.0"},devDependencies:{commander:"~2.1.0",watchify:"~0.4.1","uglify-js":"~2.4.6",jshint:"~2.3.0","http-proxy":"~0.10.3",corsproxy:"~0.2.13","http-server":"~0.5.5",browserify:"~3.24.13",wd:"~0.2.8",tin:"~0.4.0",mocha:"~1.17.1",chai:"~1.9.0",istanbul:"~0.2.4",ncp:"~0.5.0","sauce-connect-launcher":"0.2.2",less:"~1.7.0",bower:"~1.2.8"},scripts:{jshint:"jshint -c .jshintrc bin/ lib/ tests/*.js","build-js":"browserify lib/index.js -s PouchDB -o dist/pouchdb-nightly.js",uglify:"uglifyjs dist/pouchdb-nightly.js -mc > dist/pouchdb-nightly.min.js",build:"mkdir -p dist && npm run build-js && npm run uglify","test-node":"./bin/run-mocha.sh","test-browser":"mkdir -p dist && npm run build-js && ./bin/test-browser.js",dev:"./bin/dev-server.js",test:"npm run jshint && ./bin/run-test.sh",publish:"./bin/publish.sh","publish-site":"./bin/publish-site.sh","build-site":"./bin/build-site.sh",shell:"./bin/repl.js"},browser:{"./adapters/leveldb":!1,"./deps/buffer":!1,request:!1,levelup:!1,leveldown:!1,crypto:!1,bluebird:"lie","level-sublevel":!1}}},{}]},{},[13])(13)}),define("lib/db/pouch_db_util",["lib/db/pouchdb","lib/db/db_util"],function(e,t){function n(n){var r=t.get_store_db_name(n);return new e(r)}function r(e,t,n){t.remove(e,function(e,t){n(e)})}function i(n,r){var i=t.get_store_db_name(n);e.destroy(i,function(e,t){r(e)})}return{delete_doc:r,get_store_db:n,delete_db:i}}),define("app/local_db_initializer/oneshot_sync",["lib/db/pouch_db_util","lib/db/couch_db_util","constance","lib/async","lib/db/pouchdb","lib/db/db_util"],function(e,t,n,r,i,s){function o(){}function u(){}function a(n,r,i){var s=e.get_store_db(n),o=t.get_db_url(r,n);s.replicate.from(o,function(e,t){i(e)})}return function(e,t,n){var i=a.bind(a,e,t);r.waterfall([i],function(e,t){n(e)})}}),define("app/local_db_initializer/sync_if_nessesary",["lib/db/db_util","lib/async","app/local_db_initializer/oneshot_sync"],function(e,t,n){return function(r,i,s){var o=e.is_store_idb_exist.bind(e.is_store_idb_exist,r);t.waterfall([o],function(e,o){if(e){$.unblockUI(),s(e);return}if(o===null)$.unblockUI(),s(null);else{var u=n.bind(n,r,i);t.waterfall([u],function(e,t){$.unblockUI(),s(e)})}})}}),define("app/product/product_json_helper",[],function(){function e(e,t){var n=null;for(var r=0;r<t.length;r++)if(t[r].product_id==e){n=t[r];break}return n}function t(e,t){var n=null;for(var r=0;r<t.length;r++)if(t[r].product_id==e){n=t[r];break}return n}function n(e,t){var n=null;if(t==null)n=e.store_product_set[0];else for(var r=0;r<e.store_product_set.length;r++){var i=e.store_product_set[r];if(i.store_id==t){n=i;break}}return n}function r(e){return prod_sku_assoc_set=e.prodskuassoc_set,prod_sku_assoc_set==null&&(prod_sku_assoc_set=[]),prod_sku_assoc_set}function i(e,t){var n=!1;for(var r=0;r<t.length;r++)if(t[r].store_id==e){n=!0;break}return n}function s(e,t,n){var r=!1,i=null;for(var s=0;s<t.length;s++)if(t[s].sku_str==n){i=t[s];break}for(var s=0;s<i.store_set.length;s++)if(i.store_set.indexOf(e)!=-1){r=!0;break}return r}function o(e,t,n,r,o){var u=new Array;for(var a=0;a<e.length;a++){var f=e[a],l,c;l=i(t,e[a].store_product_set)==n,o==null?c=!0:c=s(t,e[a].prodskuassoc_set,o)==r,l&&c&&u.push(f)}return u}return{get_prod_sku_assoc_set:r,get_sp_from_p:n,extract_prod_store__prod_sku:o,get_p_from_lst:t,get_sp_from_sp_lst:e}}),define("app/store_product/sp_updator",["lib/async","app/store_product/sp_prompt","app/store_product/sp_online_getter","app/local_db_initializer/sync_if_nessesary","app/product/product_json_helper"],function(e,t,n,r,i){function s(e,t,n,r,i,s,o,u,a,f,l,c,h,p){$.ajax({url:"/product/update_sp",type:"POST",dataType:"json",data:{product_id:t,name:r,price:i,crv:s,is_taxable:o,is_sale_report:u,p_type:a,p_tag:f,cost:l,vendor:c,buydown:h},success:function(e,t,n){p(null,e)},error:function(e,t,n){p(e)}})}function o(t,n,r,i,o){var u=s.bind(s,t,n,r,i.name,i.price,i.crv,i.is_taxable,i.is_sale_report,i.p_type,i.p_tag,i.cost,i.vendor,i.buydown);e.waterfall([u],function(e,t){o(e,t)})}function u(n,r,s){var o=r.product,u=r.lookup_type_tag,a=i.get_sp_from_p(o,n),f=t.show_prompt.bind(t.show_prompt,a.name,a.price,a.crv,a.is_taxable,a.is_sale_report,a.p_type,a.p_tag,null,!1,a.cost,a.vendor,a.buydown,u,!0,null);e.waterfall([f],function(e,t){s(e,t)})}function a(t,i,s,a){console.assert(t,"param product_id is invalid"),console.assert(i,"param store_id is invalid"),console.assert(s,"param couch_server_url is invalid");var f=n.bind(n,t,!1,!0),l=u.bind(u,i),c=o.bind(o,i,t,s);e.waterfall([f,l,c],function(t,n){if(t)a(t,null);else{var o=n,u=r.bind(r,i,s);e.waterfall([u],function(e,t){a(e,o)})}})}return{exe:a}}),define("lib/error_lib",[],function(){function t(){var e="dummy",t={statusText:e,status:e,status:0};return t}function n(e){return e.statusText!=undefined&&e.status!=undefined}function r(e){return e&&typeof e=="string"&&e.indexOf("ERROR_CANCEL_")==0}function i(t){r(t)||(s(t)?alert(e):o(t)?alert(e):alert("There is untreated error:"+t))}function s(e){return n(e)&&e.status==0}function o(e){return e.__proto__&&e.__proto__.name=="unknown_error"&&e.__proto__.message=="Database encountered an unknown error"}var e="Internet is disconnected. Try again later.";return{alert_error:i,is_xhr_obj:n,is_offline_error:s,create_offline_error_for_test_purpose:t}}),define("app/store_product/sp_offline_updator",["lib/async","app/store_product/sp_prompt"],function(e,t){function n(e,t,n,r){e.name=n.name,e.price=n.price,e.crv=n.crv,e.is_taxable=n.is_taxable,e.is_sale_report=n.is_sale_report,e.p_type=n.p_type,e.p_tag=n.p_tag,t.put(e,function(t,n){if(t){r(t);return}r(null,e)})}return function(r,i,s){console.assert(r.product_id==null);var o=t.show_prompt.bind(t.show_prompt,r.name,r.price,r.crv,r.is_taxable,r.is_sale_report,r.p_type,r.p_tag,null,!1,r.cost,r.vendor,r.buydown,null,!1,null),u=n.bind(n,r,i);e.waterfall([o,u],function(e,t){s(e,t)})}}),define("lib/ui/confirm",["jquery","jquery_ui"],function(){function e(e,t,n){$("<div></div>").appendTo("body").html("<div><h6>"+e+"</h6></div>").dialog({modal:!0,title:"confirm",zIndex:1e4,autoOpen:!0,width:"auto",resizable:!1,buttons:{Yes:function(){t(),$(this).dialog("close")},No:function(){n(),$(this).dialog("close")}},close:function(e,t){$(this).remove()}})}return{exe:e}}),define("app/sale/displaying_scan/displaying_scan_2_ui",["lib/async","app/sale/displaying_scan_modifier/displaying_scan_modifier","app/sale/displaying_scan_modifier/Instruction","app/sale/displaying_scan/displaying_scan_lst_getter","lib/number/number","app/sale/displaying_scan/displaying_scan_util","app/store_product/sp_updator","app/product/product_json_helper","lib/error_lib","app/store_product/sp_offline_updator","lib/ui/confirm"],function(e,t,n,r,i,s,o,u,a,f,l){function b(n,i,s){var o=t.bind(t,h,v,n,i),u=r.bind(r,h,v);e.waterfall([o,u],function(e,t){if(e)a.alert_error(e);else{var n=t;E(n)}})}function w(t,r){var s=r[t],c=g.insertRow(-1),h;h=c.insertCell(-1),h.innerHTML=s.qty,h.addEventListener("click",function(){var e=i.prompt_integer("enter qty",s.qty,"wrong input");if(e==null)return;var o=new n(e==0,e,s.price,s.discount);b(t,o,r)}),h=c.insertCell(-1),h.innerHTML=s.get_name(),h.addEventListener("click",function(){if(s.store_product==null)return;var i=s.store_product.product_id;if(i==null)l.exe("this product is created offline. Modification to this product will be saved offline until sale data is push. Continue?",function(){var i=f.bind(f,s.store_product,m);e.waterfall([i],function(e,i){if(e){a.alert_error(e);return}var o=i,u=o.price,f=new n(!1,s.qty,u,s.discount);b(t,f,r)})},function(){});else{var c=o.exe.bind(o.exe,i,d,p);e.waterfall([c],function(e,i){if(e){a.alert_error(e);return}var o=u.get_sp_from_p(i,d),f=o.price,l=new n(!1,s.qty,f,s.discount);b(t,l,r)})}}),h=c.insertCell(-1),h.innerHTML=s.get_total_discount_price(),h.addEventListener("click",function(){var e="";e+="price info:\n",e+="---------\n",e+="regular price: "+s.price+"\n",s.mix_match_deal&&(e+="Mix match discount("+s.mix_match_deal.name+")"+":"+s.mix_match_deal.unit_discount+"\n");var o=s.get_crv();o&&(e+="crv: "+o+"\n");var u=s.get_buydown();u&&(e+="buydown discount: "+u+"\n");var a=s.get_buydown_tax(TAX_RATE);a&&(e+="buydown tax: "+a+"\n");var f=s.get_tax(TAX_RATE);e+="tax: "+f+"\n",e+="out the door price: "+s.get_otd_wt_price(TAX_RATE),e+="\n\n\n",e+="enter new ONE TIME regular price\n",e+="-------------------";var l=i.prompt_positive_double(e,s.price,"wrong input");if(l==null)return;var c=new n(!1,s.qty,l,s.discount);b(t,c,r)}),h=c.insertCell(-1),h.innerHTML=s.get_line_total(TAX_RATE),h=c.insertCell(-1),h.innerHTML="x",h.addEventListener("click",function(){var e=new n(!0,null,null,null);b(t,e,r)})}function E(e){g.innerHTML="";var t=g.insertRow(),n;for(var r=0;r<c.length;r++)n=t.insertCell(-1),n.innerHTML=c[r];for(var r=0;r<e.length;r++)w(r,e);var i=s.get_line_total(e,TAX_RATE);y.innerHTML=i}var c=["qty","product","price","line total","X"],h=null,p=null,d=null,v=null,m=null,g=null,y=null;return function(t,n,i,s,o,u,a,f,l){h=t,p=o,TAX_RATE=u,d=s,v=n,m=i,g=a,y=f;var c=r.bind(r,h,v);e.waterfall([c],function(e,t){var n=t;E(n);var t={sale_table:g,total_button:y};l(e,t)})}}),define("app/receipt/Receipt",["constance"],function(e){function t(t,n,r,i,s,o,u,a){t!=null&&n!=null&&r!=null&&(this._id=t,this._rev=n,this._doc_id_rev=r),this.key=i,this.time_stamp=s,this.tax_rate=o,this.ds_lst=u,this.collect_amount=a,this.d_type=e.RECEIPT_TYPE}return t}),define("app/receipt/receipt_inserter",["lib/object_store/get_os","lib/async","app/receipt/Receipt"],function(e,t,n){return function(e,t,r,i,s){var o=new n(null,null,null,null,(new Date).getTime(),r,t,i);e.post(o,function(e,t){s(e)})}}),define("app/sale/voider/voider",["lib/object_store/get_os"],function(e){return function(t,n){var r=e.get_pending_scan_os(!1,t),i=r.clear();i.onsuccess=function(e){n(null)},i.onerror=function(e){n(i.error)}}}),define("app/sale/sale_finalizer/sale_finalizer",["lib/async","app/receipt/receipt_inserter","lib/object_store/get_os","lib/number/number","app/sale/displaying_scan/displaying_scan_util","app/sale/voider/voider","app/sale/displaying_scan/displaying_scan_lst_getter"],function(e,t,n,r,i,s,o){var u=null;return function(n,a,f,l,c,h){u=n;if(!r.is_positive_double(l))h("wrong input");else{var p=o.bind(o,u,f);e.waterfall([p],function(n,r){if(n)h(n);else{var o=r;if(o.length!=0){var u=i.get_line_total(o,c);if(u>l)h("should collect at least "+u);else{var p=t.bind(t,a,o,c,l),d=s.bind(s,f);e.waterfall([p,d],function(e,t){h(e)})}}else h("scan list is empty")}})}}}),define("lib/misc/csrf_ajax_protection_setup",[],function(){return function(){$.ajaxSetup({beforeSend:function(e,t){function n(e){var t=null;if(document.cookie&&document.cookie!=""){var n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=jQuery.trim(n[r]);if(i.substring(0,e.length+1)==e+"="){t=decodeURIComponent(i.substring(e.length+1));break}}}return t}!/^http:.*/.test(t.url)&&!/^https:.*/.test(t.url)&&e.setRequestHeader("X-CSRFToken",n("csrftoken"))}})}}),define("app/receipt/receipt_lst_getter",["app/receipt/Receipt","lib/object_store/get_os","constance","lib/db/couch_db_util"],function(e,t,n,r){return function(i,s){var o=new Array,u=t.get_main_os(!0,i),a=u.index(n.DOCUMENT_TYPE_INDEX);a.openCursor(IDBKeyRange.only(n.RECEIPT_TYPE)).onsuccess=function(t){var n=t.target.result;if(n){var i=new e(n.value._id,n.value._rev,n.value._doc_id_rev,n.primaryKey,n.value.time_stamp,n.value.tax_rate,n.value.ds_lst,n.value.collect_amount);o.push(i),n.continue()}else o=r.filter_old_rev(o),s(null,o)}}}),define("lib/db/index_db_util",["lib/object_store/get_os","lib/db/couch_db_util","lib/db/db_util"],function(e,t,n){function r(t,n,r){var i=e.get_main_os(!1,t),s=i.delete(n);s.onsuccess=function(e){r(null)},s.onerror=function(e){r(e.target.errorCode)}}return{delete_item:r}}),define("app/receipt/receipt_pusher",["lib/db/pouchdb","app/receipt/receipt_lst_getter","constance","lib/async","lib/db/couch_db_util","app/store_product/store_product_getter","lib/db/index_db_util","lib/db/db_util","lib/object_store/get_os","constance","lib/db/index_db_util","lib/db/pouch_db_util"],function(e,t,n,r,i,s,o,u,a,n,o,f){function c(e,t){var n=s.by_product_id_is_null.bind(s.by_product_id_is_null,e);r.waterfall([n],function(n,i){var s=[],u=i;if(u.length==0){t(null,!1);return}for(var a=0;a<u.length;a++){var f=o.delete_item.bind(o.delete_item,e,u[a].key);s.push(f)}r.series(s,function(e,n){t(e,!0)})})}function h(e,t,n){if(e.length==0){n("receipt list is empty");return}var i=new Array;for(var s=0;s<e.length;s++){var u=o.delete_item.bind(o.delete_item,t,e[s].key);i.push(u)}r.series(i,function(e,t){n(e)})}function p(t,r,s){function o(e){return e.d_type===n.RECEIPT_TYPE}var a=i.get_db_url(r,t);e.replicate(u.get_store_db_name(t),a,{filter:o},function(e,t){s(e)})}function d(e,t){if(!e){t(null);return}$.ajax({url:"/product/create_new_sp_for_receipt_ln",type:"POST",dataType:"json",data:null,success:function(e,n,r){t(null,e)},error:function(e,n,r){t(e)}})}function v(e,t,n){var i=u.is_store_idb_exist.bind(u.is_store_idb_exist,e);r.waterfall([i],function(i,s){i&&n(i);var o=s;if(o==null){n(null);return}var u=f.get_store_db(e),a=m.bind(m,o,u,e,t);r.waterfall([a],function(e,t){e==l&&(e=null),n(e)})})}function m(e,n,i,s,o){var u=t.bind(t,e);r.waterfall([u],function(t,n){if(t){o(t);return}var u=n;if(u.length==0){o(l);return}u=n;var a=p.bind(p,i,s),f=h.bind(h,u,e),v=c.bind(c,e);r.waterfall([a,f,v,d],function(e,t){o(e,u.length)})})}var l="There is no sale data to push";return{exe:m,ERROR_NO_SALE_DATA_TO_PUSH:l,sync_receipt:p,exe_if_nessesary:v}}),define("app/local_db_initializer/customize_db",["constance","lib/async","lib/db/db_util"],function(e,t,n){function r(t,r){var i=3,s=n.get_store_db_name(t),o=indexedDB.open(n.pouch_db_name_to_index_db_name(s),i);o.onupgradeneeded=function(t){var n=event.target.result;n.createObjectStore(e.PENDING_SCAN_OS_NAME,{autoIncrement:!0});var r=t.currentTarget.transaction.objectStore(e.MAIN_OS_NAME);r.createIndex(e.DOCUMENT_TYPE_INDEX,"d_type",{unique:!1,multiEntry:!1}),r.createIndex(e.SKU_INDEX_NAME,"sku_lst",{unique:!1,multiEntry:!0}),r.createIndex(e.PRODUCT_ID_INDEX_NAME,"product_id",{unique:!1,multiEntry:!1}),r.createIndex(e.PRODUCT_NAME_INDEX_NAME,["d_type","name"],{unique:!1,multiEntry:!1}),r.createIndex(e.DOCUMENT_ID_INDEX_NAME,"_id",{unique:!1})},o.onsuccess=function(e){var t=o.result;r(null,t)},o.onerror=function(e){r("error in customizing db")}}return function(e,n){var i=r.bind(r,e);t.waterfall([i],function(e,t){n(e,t)})}}),define("app/sale_shortcut/sale_shortcut_util",[],function(){function e(e,t){var n=null;for(var r=0;r<t.length;r++)if(t[r].position==e){n=t[r];break}return n}function t(e,t){var n=null;for(var r=0;r<e.child_set.length;r++)if(e.child_set[r].position==t){n=e.child_set[r];break}return n}return{get_parent:e,get_child:t}}),define("app/store_product/sp_online_searcher",[],function(){function n(t,n){var t=t.trim();if(!t){n(e);return}$.ajax({url:"/product/search_by_name_sku",type:"GET",data:{search_str:t},dataType:"json",success:function(e,t,r){n(null,e)},error:function(e,t,r){n(e)}})}function r(t,n){var t=t.trim();if(!t){n(e);return}$.ajax({url:"/product/search_by_name",type:"GET",data:{name_str:t},dataType:"json",success:function(e,t,r){n(null,e)},error:function(e,t,r){n(e)}})}function i(e,n){var e=e.trim();if(!e){n(t);return}$.ajax({url:"/product/search_by_sku",type:"GET",data:{sku_str:e},dataType:"json",success:function(e,t,r){n(null,e)},error:function(e,t,r){n(e)}})}var e="NAME_SEARCH_ERROR_EMPTY",t="SKU_SEARCH_ERROR_EMPTY";return{NAME_SEARCH_ERROR_EMPTY:e,SKU_SEARCH_ERROR_EMPTY:t,name_search:r,sku_search:i,name_sku_search:n}}),define("app/sku/product_sku_online_adder",[],function(){return function(e,t,n){$.ajax({url:"/product/sku/add",type:"POST",dataType:"json",data:{product_id:e,sku_str:t},success:function(e,t,r){var i=e;n(null,i)},error:function(e,t,r){n(e)}})}}),define("app/store_product/sp_creator",["lib/async","app/store_product/sp_prompt","app/local_db_initializer/sync_if_nessesary","app/product/product_json_helper","app/sku/product_sku_online_adder"],function(e,t,n,r,i){function o(e,t,n){var r={name:t.name,price:t.price,crv:t.crv,is_taxable:t.is_taxable,is_sale_report:t.is_sale_report,sku_str:t.sku_str,p_type:t.p_type,p_tag:t.p_tag,cost:t.cost,vendor:t.vendor,buydown:t.buydown},i=null;e?(r.product_id=e,i="/product/insert_old_sp"):i="/product/insert_new_sp",$.ajax({url:i,method:"POST",data:r,dataType:"json",success:function(e,t,r){n(null,e)},error:function(e,t,r){n(e)}})}function u(e){$("#select_product_option_dialog").dialog("close"),e(s)}function a(e,t,n,i){if(e.length==0&&t.length==0)i(null,null);else{$("#product_option_create_new_btn").off("click").click(function(){i(null,null),$("#select_product_option_dialog").dialog("close")});var s=document.getElementById("select_product_option_tbl");s.innerHTML="";var o,a;a=s.insertRow(-1),o=a.insertCell(-1),o.innerHTML="product",o=a.insertCell(-1),o.innerHTML="add";for(var f=0;f<e.length;f++){var l=e[f],c=r.get_sp_from_p(l,n);a=s.insertRow(-1),o=a.insertCell(-1),o.innerHTML=c.name,o=a.insertCell(-1),o.innerHTML="sku",function(e){o.addEventListener("click",function(){$("#select_product_option_dialog").dialog("close"),i(null,e)})}(l)}for(var f=0;f<t.length;f++){var l=t[f];a=s.insertRow(-1),o=a.insertCell(-1),o.innerHTML=l.name,o=a.insertCell(-1),o.innerHTML="product",function(e){o.addEventListener("click",function(){$("#select_product_option_dialog").dialog("close"),i(null,e)})}(l)}var h=u.bind(u,i);$("#select_product_option_dialog").dialog({title:"create new product or select option",buttons:[{text:"cancel",click:h}],modal:!0})}}function f(s,u,f,l,c,h){var p=r.extract_prod_store__prod_sku(u,l,!1,!1,s),d=r.extract_prod_store__prod_sku(u,l,!1,!0,s),v=r.extract_prod_store__prod_sku(u,l,!0,!1,s),m=r.extract_prod_store__prod_sku(u,l,!0,!0,s);if(m.length!=0)h("there is error: attempt to create a product that is already exist");else if(d.length!=0)h("there is error. please report bug: data integrity constrain failed");else{var g=a.bind(a,v,p,l);e.waterfall([g],function(u,a){if(u){h(u);return}var p=a;if(p!=null&&r.get_p_from_lst(p.product_id,v)){var d=i.bind(i,p.product_id,s);e.waterfall([d],function(e,t){h(e,t)})}else{var m=t.show_prompt.bind(t.show_prompt,null,null,null,!1,!0,null,null,s,!0,null,null,null,f,!1,p),g=p==null?null:p.product_id,y=o.bind(o,g);e.waterfall([m,y],function(t,r){if(t){h(t);return}product=r;var i=n.bind(n,l,c);e.waterfall([i],function(e,t){h(e,product)})})}})}}var s="ERROR_CANCEL_select_product_option";return{exe:f,ERROR_CANCEL_select_product_option:s}}),define("app/sale/scan/sku_scan_not_found_handler",["lib/async","lib/error_lib","app/store_product/sp_online_searcher","app/store_product/sp_creator","app/store_product/sp_prompt","app/store_product/Store_product","lib/ui/confirm"],function(e,t,n,r,i,s,o){function a(e,t,n,r){sku_lst=[e];var i=new s(null,null,null,null,null,n.name,n.price,n.crv,n.is_taxable,n.is_sale_report,n.p_type,n.p_tag,sku_lst,n.cost,n.vendor,n.buydown);t.post(i,function(e,t){r(e)})}function f(t,n,i,s,o){var u=s.prod_lst,a=s.lookup_type_tag,f=r.exe.bind(r.exe,t,u,a,n,i);e.waterfall([f],function(e,t){o(e)})}function l(r,s,l,c,h){var p=n.sku_search.bind(n.sku_search,r),d=f.bind(f,r,s,l);e.waterfall([p,d],function(n,s){if(n){if(typeof n=="string"){h(n);return}if(!t.is_offline_error(n)){h(n);return}o.exe("internet connection down. Do you want to create product offline?",function(){var t=i.show_prompt.bind(i.show_prompt,null,null,null,!1,!0,null,null,r,!0,null,null,null,null,!1,null),n=a.bind(a,r,c);e.waterfall([t,n],function(e,t){h(e)})},function(){h(u)})}else h(null)})}var u="ERROR_CANCEL_create_product_offline";return{exe:l,ERROR_CANCEL_create_product_offline:u}}),define("app/sale/non_inventory/non_inventory_prompt",["lib/number/number"],function(e){function t(t){price=$("#non_inventory_price_txt").val(),description=$("#non_inventory_description_txt").val();if(!e.is_positive_double(price)){alert("check price input");return}var n={price:price,description:description};t(null,n),$("#non_inventory_prompt_dialog").dialog("close")}function n(e){e("ERROR_CANCEL_NON_INVENTORY_PROMPT_CANCEL"),$("#non_inventory_prompt_dialog").dialog("close")}function r(e){var r=t.bind(t,e),i=n.bind(n,e),s="non inventory";$("#non_inventory_prompt_dialog").dialog({title:s,buttons:[{text:"Ok",click:r},{text:"Cancel",click:i}],modal:!0,width:600,heigh:400}),$("#non_inventory_price_txt").val(""),$("#non_inventory_description_txt").val(""),$("#non_inventory_prompt_dialog").dialog("open")}return{exe:r}}),define("app/store_product/sp_online_name_search_ui",["lib/async","app/store_product/sp_online_searcher","app/product/product_json_helper","lib/error_lib"],function(e,t,n,r){function s(e){$("#product_search_dlg").dialog("close"),e(i)}function o(n){$("#product_search_txt").keypress(function(i){var s=i.keyCode?i.keyCode:i.which;if(s=="13"){var o=$("#product_search_txt").val().trim();if(!o)return;var a=t.name_sku_search.bind(t.name_sku_search,o);e.waterfall([a],function(e,t){e?r.alert_error(e):(u(t,n),t.length==0&&alert("no result"))})}})}function u(e,t){var r=document.getElementById("product_search_tbl");r.innerHTML="";var i,s,o=["product","price","crv","taxable","type","tag","select"];i=r.insertRow(-1);for(var u=0;u<o.length;u++)s=i.insertCell(-1),s.innerHTML=o[u];for(var u=0;u<e.length;u++){var i=r.insertRow(-1),a=null,f=n.get_sp_from_p(e[u],a);s=i.insertCell(-1),s.innerHTML=f.name,s=i.insertCell(-1),s.innerHTML=f.price,s=i.insertCell(-1),s.innerHTML=f.crv,s=i.insertCell(-1),s.innerHTML=f.is_taxable,s=i.insertCell(-1),s.innerHTML=f.p_type,s=i.insertCell(-1),s.innerHTML=f.p_tag,s=i.insertCell(-1),s.innerHTML="select",function(e){s.addEventListener("click",function(){$("#product_search_dlg").dialog("close"),t(null,e)})}(f)}}function a(e){var t=s.bind(s,e);$("#product_search_dlg").dialog({title:"search product",buttons:[{text:"exit",click:t}],modal:!0,width:800,height:500}),o(e),$("#product_search_txt").val(""),u([],e),$("#product_search_dlg").dialog("open")}var i="ERROR_CANCEL_product_search_exit_button_press";return{exe:a,ERROR_CANCEL_product_search_exit_button_press:i}}),define("app/sale/scan/pid_scanner",["lib/async","app/store_product/store_product_getter","app/sale/pending_scan/Pending_scan","app/sale/pending_scan/pending_scan_inserter"],function(e,t,n,r){function i(i,s,o){var u=t.by_product_id.bind(t.by_product_id,i,s);e.waterfall([u],function(t,i){if(t){error_lib.allert(t);return}var u=i,a=new n(null,1,u.price,null,u._id,null),f=r.bind(r,s,a);e.waterfall([f],function(e,t){o(e)})})}return{exe:i}}),define("lib/jquery/jquery.hotkeys",["jquery"],function(e){function t(t){typeof t.data=="string"&&(t.data={keys:t.data});if(!t.data||!t.data.keys||typeof t.data.keys!="string")return;var n=t.handler,r=t.data.keys.toLowerCase().split(" "),i=["text","password","number","email","url","range","date","month","week","time","datetime","datetime-local","search","color","tel"];t.handler=function(t){if(this!==t.target&&(/textarea|select/i.test(t.target.nodeName)||e.inArray(t.target.type,i)>-1))return;var s=e.hotkeys.specialKeys[t.keyCode],o=String.fromCharCode(t.which).toLowerCase(),u="",a={};e.each(["alt","ctrl","meta","shift"],function(e,n){t[n+"Key"]&&s!==n&&(u+=n+"+")}),u=u.replace("alt+ctrl+meta+shift","hyper"),s&&(a[u+s]=!0),o&&(a[u+o]=!0,a[u+e.hotkeys.shiftNums[o]]=!0,u==="shift+"&&(a[e.hotkeys.shiftNums[o]]=!0));for(var f=0,l=r.length;f<l;f++)if(a[r[f]])return n.apply(this,arguments)}}e.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}},e.each(["keydown","keyup","keypress"],function(){e.event.special[this]={add:t}})}),define("app/sale/sale",["lib/async","app/sale/scan/scanner","app/sale/displaying_scan/displaying_scan_2_ui","app/sale/sale_finalizer/sale_finalizer","lib/number/number","lib/db/pouch_db_util","app/sale/displaying_scan/displaying_scan_util","constance","app/sale/voider/voider","lib/misc/csrf_ajax_protection_setup","app/receipt/receipt_pusher","app/local_db_initializer/oneshot_sync","app/local_db_initializer/customize_db","app/sale_shortcut/sale_shortcut_util","app/store_product/store_product_getter","app/sale/pending_scan/Pending_scan","app/sale/pending_scan/pending_scan_inserter","app/sale/scan/sku_scan_not_found_handler","lib/error_lib","app/sale/non_inventory/non_inventory_prompt","app/store_product/sp_online_name_search_ui","app/sale/scan/pid_scanner","app/sale/displaying_scan/displaying_scan_lst_getter","lib/ui/confirm","jquery","jquery_block_ui","jquery_ui","lib/jquery/jquery.hotkeys"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x){function z(){O.addEventListener("click",function(){var t=w.exe.bind(w.exe);e.waterfall([t],function(t,r){if(t){y.alert_error(t);return}var i=r,s=E.exe.bind(E.exe,i.product_id,j),o=n.bind(n,q,j,B,STORE_ID,COUCH_SERVER_URL,F,T,N);e.waterfall([s,o],function(e,t){if(e){y.alert_error(e);return}})})})}function W(){function t(){e.waterfall([b.exe],function(t,r){if(t){y.alert_error(t);return}var i=r.price,s=new v(null,1,i,null,null,r.description),o=m.bind(m,j,s),u=n.bind(n,q,j,B,STORE_ID,COUCH_SERVER_URL,F,T,N);e.waterfall([o,u],function(e,t){if(e){y.alert_error(e);return}})})}$(document).bind("keydown","ctrl+n",t),$("#scan_text").bind("keydown","ctrl+n",t),L.addEventListener("click",t)}function X(){function t(){var t=l.exe.bind(l.exe,j,B,STORE_ID,COUCH_SERVER_URL);$.blockUI({message:"saving sale data ..."}),e.waterfall([t],function(e,t){if(e)e==l.ERROR_NO_SALE_DATA_TO_PUSH?alert(l.ERROR_NO_SALE_DATA_TO_PUSH):y.alert_error(e);else{var n=t;alert(n+" receipt(s) are saved.")}$.unblockUI()})}k.addEventListener("click",t)}function V(){function t(){var t=S.bind(S,q,j);e.waterfall([t],function(t,s){var u=s;if(u.length!=0){var a=o.get_line_total(u,F),f=i.prompt_positive_double("amount: ",a,"wrong input");if(f!=null){if(f<a){alert("collecting amount should be at least:"+a);return}var l="Did you give the customer change: "+i.trim(f-a);x.exe(l,function(){var t=r.bind(r,q,B,j,f,F);e.waterfall([t],function(t,r){if(t)alert(t);else{var i=n.bind(n,q,j,B,STORE_ID,COUCH_SERVER_URL,F,T,N);e.waterfall([i],function(e,t){e&&alert(e)})}})},function(){})}}})}N.addEventListener("click",t)}function J(){function i(i){if(i.keyCode!==r)return;A.select();var s=A.value.trim();if(s.length==0)return;var o=t.exe.bind(t.exe,s,j),u=n.bind(n,q,j,B,STORE_ID,COUCH_SERVER_URL,F,T,N);e.waterfall([o,u],function(n,r){if(n)if(n==t.ERROR_STORE_PRODUCT_NOT_FOUND){sku_str=t.get_sku_from_scan_str(s);var i=g.exe.bind(g.exe,sku_str,STORE_ID,COUCH_SERVER_URL,B);e.waterfall([i,o,u],function(e,t){e&&y.alert_error(e)})}else y.alert_error(n)})}var r=13;A.addEventListener("keypress",i,!1)}function K(t){var r=p.get_parent(R,I);if(r!=null){child=p.get_child(r,t);if(child!=null){var i=E.exe.bind(E.exe,child.product_id,j),s=n.bind(n,q,j,B,STORE_ID,COUCH_SERVER_URL,F,T,N);e.waterfall([i,s],function(e,t){if(e){y.alert_error(e);return}})}}}function Q(e,t){var n=p.get_parent(t,I),r=t==R?"parent_selected":"parent_unselected";td=e.insertCell(-1),td.innerHTML=n==null?null:n.caption,td.addEventListener("click",function(){R=t,Y()}),td.className=r}function G(e,t){var n=p.get_parent(R,I);for(var r=0;r<COLUMN_COUNT;r++){td=e.insertCell(-1);var i=COLUMN_COUNT*t+r;if(n!=null){var s=p.get_child(n,i);s!=null&&(td.innerHTML=s.caption)}var o=K.bind(K,i);td.addEventListener("click",o)}}function Y(){U.innerHTML="";for(var e=0;e<ROW_COUNT;e++){var t=U.insertRow(-1);Q(t,e),G(t,e),Q(t,e+ROW_COUNT)}}function Z(){function t(){var t=S.bind(S,q,j);e.waterfall([t],function(t,r){var i=r;if(i.length==0)return;x.exe("remove all scan?",function(){var t=a.bind(a,j),r=n.bind(n,q,j,B,STORE_ID,COUCH_SERVER_URL,F,T,N);e.waterfall([t,r],function(e,t){e&&alert(e)})},function(){})})}C.addEventListener("click",t)}var T=document.getElementById("sale_table"),N=document.getElementById("total_button"),C=document.getElementById("void_btn"),k=document.getElementById("push_receipt_btn"),L=document.getElementById("non_inventory_btn"),A=document.getElementById("scan_text"),O=document.getElementById("product_search_btn"),M=document.getElementById("product_name_txt"),_=document.getElementById("product_price_txt"),D=document.getElementById("product_taxable_check"),P=document.getElementById("product_crv_txt"),H=document.getElementById("product_sku_txt"),B,j,F=MY_TAX_RATE,I=MY_SHORTCUT_LST,q=MY_MM_LST,R=0,U=document.getElementById("shortcut_tbl");$("#block_message_label").html("please wait for setup ..."),$.blockUI({message:$("#block_message_label")}),f();var et=c.bind(c,STORE_ID,COUCH_SERVER_URL),tt=h.bind(h,STORE_ID);e.waterfall([et,tt],function(t,r){if(t){$.unblockUI(),alert("There is error initializing db: "+t);return}j=r,B=s.get_store_db(STORE_ID),J(),V(),Z(),X(),Y(),W(),z();var i=n.bind(n,q,j,B,STORE_ID,COUCH_SERVER_URL,F,T,N);e.waterfall([i],function(e,t){if(e){$.unblockUI(),alert("There is error displaying scan: "+e);return}$.unblockUI()})})}),requirejs.config({baseUrl:STATIC_URL+"js",paths:{app:"app",lib:"lib",jquery:["//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min","lib/jquery/jquery-1.11.0.min"],jquery_ui:["//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min","lib/jquery/jquery-ui-1.10.4.min"],jquery_block_ui:["//cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.66.0-2013.10.09/jquery.blockUI.min","lib/jquery/jquery.blockUI"]},shim:{jquery_ui:{deps:["jquery"]},jquery_block_ui:{deps:["jquery"]}}}),requirejs(["app/sale/sale"]),define("app/sale/sale_entry",function(){});